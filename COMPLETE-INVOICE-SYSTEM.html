<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aweh Be Lekker - Complete Invoice System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .u-mt-1 {
            margin-top: 1rem;
        }

        .is-hidden {
            display: none;
        }

        .gdrive-control {
            display: none;
        }

        .sync-status {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-right: 0.5rem;
        }

        .google-icon {
            width: 14px;
            height: 14px;
            margin-right: 5px;
            vertical-align: middle;
        }

        .setup-google-drive-btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
        }

        :root {
            --primary: #00d4ff;
            --secondary: #ff006e;
            --accent: #7209b7;
            --success: #06ffa5;
            --warning: #ffbe0b;
            --danger: #f72585;
            --dark: #0a0e27;
            --darker: #050714;
            --light: #e0e7ff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            color: var(--light);
            min-height: 100vh;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--darker);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 5px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.2);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .logo h1 {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Navigation */
        nav {
            background: var(--dark);
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: rgba(0, 212, 255, 0.1);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--danger));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 0, 110, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 110, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #00b377);
            color: var(--dark);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: var(--light);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        select.form-control {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.08);
            color: var(--light);
        }

        select.form-control option {
            background: var(--dark);
            color: #ffffff;
            padding: 0.75rem;
            font-weight: 500;
        }

        select.form-control option:hover {
            background: var(--primary);
            color: var(--dark);
        }

        /* Product Search Results */
        .product-search-results {
            background: var(--dark);
            border: 1px solid var(--primary);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 0.5rem;
        }

        .search-result-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-result-item:hover {
            background: rgba(0, 212, 255, 0.1);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: var(--light);
            margin-bottom: 0.25rem;
        }

        .search-result-details {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Stats Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(114, 9, 183, 0.1));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
            position: relative;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            position: relative;
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .product-card {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }

        .product-brand {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--light);
            margin-bottom: 0.5rem;
        }

        .product-sku {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
            margin-bottom: 1rem;
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding-left: 3rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.2rem;
        }

        .filter-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-tag {
            padding: 0.5rem 1rem;
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 20px;
            color: var(--primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tag:hover,
        .filter-tag.active {
            background: var(--primary);
            color: var(--dark);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: rgba(0, 212, 255, 0.1);
            color: var(--primary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--primary);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
            color: var(--light);
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .editable {
            background: rgba(255, 190, 11, 0.2);
            border: 1px dashed var(--warning);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .editable:hover {
            background: rgba(255, 190, 11, 0.3);
            border-style: solid;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark), var(--darker));
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 212, 255, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Setup Wizard Styles */
        .wizard-modal {
            max-width: 850px;
            padding: 0;
        }

        .wizard-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 1.5rem;
            border-radius: 14px 14px 0 0;
            text-align: center;
        }

        .wizard-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .wizard-progress {
            display: flex;
            justify-content: space-between;
            margin: 1.5rem 0;
            padding: 0 1rem;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .wizard-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.2);
            z-index: -1;
        }

        .wizard-step:first-child::before {
            display: none;
        }

        .wizard-step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wizard-step.active .wizard-step-number {
            background: var(--primary);
            box-shadow: 0 0 20px var(--primary);
        }

        .wizard-step.completed .wizard-step-number {
            background: var(--success);
        }

        .wizard-step.completed .wizard-step-number::after {
            content: '‚úì';
        }

        .wizard-step-label {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .wizard-step.active .wizard-step-label {
            opacity: 1;
            font-weight: bold;
        }

        .wizard-content {
            padding: 2rem;
            min-height: 400px;
        }

        .wizard-step-content {
            display: none;
        }

        .wizard-step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .wizard-instruction {
            background: rgba(0, 212, 255, 0.1);
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }

        .wizard-instruction h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .wizard-instruction ol {
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .wizard-instruction li {
            margin: 0.5rem 0;
        }

        .wizard-copy-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--primary);
            padding: 0.75rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wizard-copy-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--light);
            font-family: monospace;
            font-size: 0.9rem;
        }

        .wizard-copy-btn {
            background: var(--primary);
            color: var(--dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .wizard-copy-btn:hover {
            background: var(--success);
            transform: scale(1.05);
        }

        .wizard-link-btn {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            margin: 1rem 0.5rem 1rem 0;
            transition: all 0.3s;
        }

        .wizard-link-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .wizard-validation {
            margin: 1rem 0;
        }

        .wizard-validation input {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: var(--light);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .wizard-validation input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .wizard-validation.valid input {
            border-color: var(--success);
        }

        .wizard-validation.invalid input {
            border-color: var(--danger);
        }

        .wizard-validation-msg {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            display: none;
        }

        .wizard-validation.valid .wizard-validation-msg.success {
            display: block;
            color: var(--success);
        }

        .wizard-validation.invalid .wizard-validation-msg.error {
            display: block;
            color: var(--danger);
        }

        .wizard-footer {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .wizard-alert {
            background: rgba(255, 190, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 5px;
        }

        .wizard-success {
            background: rgba(6, 255, 165, 0.1);
            border-left: 4px solid var(--success);
            padding: 1.5rem;
            margin: 1rem 0;
            border-radius: 5px;
            text-align: center;
        }

        .wizard-success h3 {
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(247, 37, 133, 0.2);
            transform: rotate(90deg);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--success), #00b377);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(6, 255, 165, 0.4);
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: none;
        }

        .toast.active {
            display: block;
        }

        .toast.error {
            background: linear-gradient(135deg, var(--danger), #d00069);
        }

        .toast.warning {
            background: linear-gradient(135deg, var(--warning), #e6a700);
            color: var(--dark);
        }

        .toast.info {
            background: linear-gradient(135deg, var(--primary), var(--accent));
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Color Picker */
        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .color-picker-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            background: transparent;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 4px;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        /* Logo Upload */
        .logo-upload-area {
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logo-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 212, 255, 0.05);
        }

        .logo-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 1rem auto;
            display: none;
        }

        .logo-preview.active {
            display: block;
        }

        /* Invoice Items Table */
        .invoice-items-table {
            margin-top: 1.5rem;
        }

        .invoice-items-table td input {
            background: rgba(255, 190, 11, 0.1);
            border: 1px solid var(--warning);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Profile Selector */
        .profile-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.85rem;
            }

            .stats-grid,
            .product-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-filter-bar {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .table-container {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .toast {
                right: 1rem;
                left: 1rem;
                top: 1rem;
            }
        }

        @media (max-width: 480px) {
            .logo h1 {
                font-size: 1.4rem;
            }

            .card-title {
                font-size: 1.2rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.85rem;
            }
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            header, nav, .btn, .modal {
                display: none !important;
            }

            .card {
                border: 1px solid #ddd;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>Aweh Be Lekker</h1>
            </div>
            <div class="header-actions" role="toolbar" aria-label="Main actions">
                <!-- Google Drive Sync Status -->
                <span id="syncStatus" class="sync-status">üíæ Local storage</span>

                <!-- Google Drive Single-Click Sync -->
                <button id="syncGoogleBtn" class="btn btn-outline btn-sm setup-google-drive-btn" onclick="syncGoogle()" aria-label="Sync with Google Drive">
                    üîó Sync Google
                </button>
                <button id="googleSignOutBtn" class="btn btn-outline btn-sm gdrive-control" onclick="driveStorage.signOut()" aria-label="Sign out from Google">
                    Sign Out
                </button>

                <!-- Existing Buttons -->
                <button class="btn btn-outline btn-sm" onclick="openSettingsModal()" aria-label="Open settings">‚öôÔ∏è Settings</button>
                <button class="btn btn-outline btn-sm" onclick="importData()" aria-label="Import data">üì§ Import</button>
                <button class="btn btn-primary btn-sm" onclick="exportData()" aria-label="Export data">üì• Export</button>
                <button class="btn btn-success btn-sm" onclick="openCreateInvoiceModal()" aria-label="Create new invoice">‚ûï New Invoice</button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav role="navigation" aria-label="Main navigation">
        <div class="nav-content">
            <button class="nav-tab active" onclick="switchTab('dashboard')" aria-label="Dashboard tab" role="tab" aria-selected="true">Dashboard</button>
            <button class="nav-tab" onclick="switchTab('products')" aria-label="Products tab" role="tab" aria-selected="false">Products</button>
            <button class="nav-tab" onclick="switchTab('invoices')" aria-label="Invoices tab" role="tab" aria-selected="false">Invoices</button>
            <button class="nav-tab" onclick="switchTab('customers')" aria-label="Customers tab" role="tab" aria-selected="false">Customers</button>
            <button class="nav-tab" onclick="switchTab('suppliers')" aria-label="Suppliers tab" role="tab" aria-selected="false">Suppliers</button>
            <button class="nav-tab" onclick="switchTab('settings')" aria-label="Settings tab" role="tab" aria-selected="false">Settings</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container" role="main" aria-label="Main content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="todayInvoices">0</div>
                    <div class="stat-label">Today's Invoices</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayRevenue">R 0</div>
                    <div class="stat-label">Today's Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthInvoices">0</div>
                    <div class="stat-label">This Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalRevenue">R 0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Recent Invoices</h2>
                    <button class="btn btn-sm btn-primary" onclick="openCreateInvoiceModal()">Create New</button>
                </div>
                <div class="table-container">
                    <table id="recentInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices yet. Create your first invoice!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Product Catalog</h2>
                    <div class="filter-tags">
                        <span class="filter-tag active" data-filter="all">All Products</span>
                        <span class="filter-tag" data-filter="awake">Awake</span>
                        <span class="filter-tag" data-filter="aquamarina">Aqua Marina</span>
                    </div>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <span class="search-icon" aria-hidden="true">üîç</span>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products by name, SKU, or category..." aria-label="Search products">
                    </div>
                </div>

                <div id="productCount" style="color: var(--primary); margin-bottom: 1rem; font-weight: 600;">
                    Showing <span id="visibleProducts">217</span> of <span id="totalProducts">217</span> products
                </div>

                <div class="product-grid" id="productGrid">
                    <!-- Products will be dynamically loaded here -->
                </div>
            </div>
        </div>

        <!-- Invoices Tab -->
        <div id="invoices" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Invoices</h2>
                    <button class="btn btn-primary btn-sm" onclick="openCreateInvoiceModal()">‚ûï Create Invoice</button>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="form-control" id="invoiceSearch" placeholder="Search invoices..." oninput="loadAllInvoices()">
                    </div>
                    <select class="form-control" style="max-width: 200px;" id="invoiceFilter" onchange="loadAllInvoices()">
                        <option value="all">All Types</option>
                        <option value="invoice">Invoices</option>
                        <option value="quote">Quotes</option>
                        <option value="proforma">Proforma</option>
                        <option value="credit_note">Credit Notes</option>
                        <option value="purchase_order">Purchase Orders</option>
                    </select>
                    <select class="form-control" style="max-width: 200px;" id="statusFilter" onchange="loadAllInvoices()">
                        <option value="all">All Status</option>
                        <option value="draft">üìù Draft</option>
                        <option value="sent">üì§ Sent</option>
                        <option value="partial">üí∞ Partial</option>
                        <option value="paid">‚úÖ Paid</option>
                        <option value="overdue">‚ö†Ô∏è Overdue</option>
                        <option value="cancelled">‚ùå Cancelled</option>
                    </select>
                    <button type="button" class="btn btn-accent btn-sm" onclick="openReportsModal()">üìä Reports</button>
                </div>

                <div class="table-container">
                    <table id="allInvoicesTable">
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Due Date</th>
                                <th>Customer</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Balance</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices found</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Customers</h2>
                    <button class="btn btn-primary btn-sm" onclick="openAddCustomerModal()">‚ûï Add Customer</button>
                </div>

                <div class="table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Tier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Customers will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="suppliers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Suppliers</h2>
                    <button class="btn btn-primary btn-sm" onclick="openAddSupplierModal()">‚ûï Add Supplier</button>
                </div>

                <div class="table-container">
                    <table id="suppliersTable">
                        <thead>
                            <tr>
                                <th>Logo</th>
                                <th>Supplier Name</th>
                                <th>Contact</th>
                                <th>Products</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No suppliers yet. Add your first supplier!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üì∑ Quick Actions</h2>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <button type="button" class="btn btn-primary" onclick="scanPriceList()" style="padding: 1.5rem;">
                        üì∏ Scan Price List<br>
                        <small style="opacity: 0.7;">Use camera to scan supplier price list</small>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="uploadPriceList()" style="padding: 1.5rem;">
                        üìÑ Upload Price List<br>
                        <small style="opacity: 0.7;">Upload PDF/Excel price list</small>
                    </button>
                    <button type="button" class="btn btn-accent" onclick="scanInvoice()" style="padding: 1.5rem;">
                        üßæ Scan Invoice<br>
                        <small style="opacity: 0.7;">Scan supplier invoice to create order</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <!-- Multi-Business Management -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üè¢ Multi-Business Management</h2>
                    <button class="btn btn-primary btn-sm" onclick="openCreateBusinessModal()">‚ûï Add New Business</button>
                </div>

                <!-- Current Business Display -->
                <div id="currentBusinessDisplay" style="padding: 1rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(6, 255, 165, 0.1)); border-radius: 8px; margin-bottom: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="currentBusinessLogo" style="width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            üè¢
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 0.25rem;">Currently Active:</div>
                            <div id="currentBusinessName" style="font-size: 1.3rem; font-weight: 600; color: var(--primary);">Aweh Be Lekker</div>
                            <div id="currentBusinessDetails" style="font-size: 0.9rem; color: rgba(255,255,255,0.7); margin-top: 0.25rem;"></div>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="openSwitchBusinessModal()">üîÑ Switch Business</button>
                    </div>
                </div>

                <!-- Business List -->
                <div id="businessListSection" style="display: none;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary);">Your Businesses</h4>
                    <div id="businessList" style="display: grid; gap: 1rem;"></div>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Company Logo</h2>
                </div>
                <div class="logo-upload-area" onclick="document.getElementById('logoUpload').click()">
                    <p>üì∑ Click to upload logo (PNG, JPG - Max 5MB)</p>
                    <img id="logoPreview" class="logo-preview" alt="Logo preview">
                    <input type="file" id="logoUpload" accept="image/png,image/jpeg" style="display: none;" onchange="handleLogoUpload(event)">
                </div>
                <button class="btn btn-outline btn-sm" onclick="removeLogo()" style="margin-top: 1rem;">Remove Logo</button>
            </div>

            <!-- Invoice Theme Settings -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üé® Invoice Theme & Layout</h2>
                    <button class="btn btn-outline btn-sm" onclick="previewInvoiceTheme()">üëÅÔ∏è Preview</button>
                </div>

                <!-- Invoice Templates -->
                <div class="form-group">
                    <label class="form-label">üìã Quick Templates (One-Click Apply)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-top: 0.5rem;">
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('modern-blue')" style="background: linear-gradient(135deg, #00d4ff, #0099cc); color: white; border: none;">
                            üåä Modern Blue
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('classic-black')" style="background: linear-gradient(135deg, #333, #000); color: white; border: none;">
                            üé© Classic Black
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('bold-red')" style="background: linear-gradient(135deg, #ff006e, #cc0055); color: white; border: none;">
                            üî• Bold Red
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('elegant-purple')" style="background: linear-gradient(135deg, #7209b7, #560bad); color: white; border: none;">
                            üëë Elegant Purple
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('ocean-teal')" style="background: linear-gradient(135deg, #06ffa5, #00b377); color: white; border: none;">
                            üèùÔ∏è Ocean Teal
                        </button>
                        <button type="button" class="btn btn-outline" onclick="applyTemplate('sunset-orange')" style="background: linear-gradient(135deg, #ff9500, #ff6b00); color: white; border: none;">
                            üåÖ Sunset Orange
                        </button>
                    </div>
                </div>

                <!-- Logo Position -->
                <div class="form-group">
                    <label class="form-label">Logo Position</label>
                    <select class="form-control" id="logoPosition" onchange="saveSettings()">
                        <option value="top-left">Top Left</option>
                        <option value="top-center">Top Center</option>
                        <option value="top-right">Top Right</option>
                    </select>
                </div>

                <!-- Logo Size -->
                <div class="form-group">
                    <label class="form-label">Logo Size</label>
                    <select class="form-control" id="logoSize" onchange="saveSettings()">
                        <option value="small">Small (100px)</option>
                        <option value="medium" selected>Medium (150px)</option>
                        <option value="large">Large (200px)</option>
                    </select>
                </div>

                <!-- Invoice Layout -->
                <div class="form-group">
                    <label class="form-label">Invoice Layout</label>
                    <select class="form-control" id="invoiceLayout" onchange="saveSettings()">
                        <option value="modern" selected>Modern (Clean & Minimal)</option>
                        <option value="classic">Classic (Traditional)</option>
                        <option value="bold">Bold (High Contrast)</option>
                        <option value="elegant">Elegant (Professional)</option>
                    </select>
                </div>

                <!-- Font Style -->
                <div class="form-group">
                    <label class="form-label">Font Style</label>
                    <select class="form-control" id="fontStyle" onchange="saveSettings()">
                        <option value="sans-serif" selected>Sans-Serif (Modern)</option>
                        <option value="serif">Serif (Traditional)</option>
                        <option value="monospace">Monospace (Technical)</option>
                    </select>
                </div>

                <!-- Font Size -->
                <div class="form-group">
                    <label class="form-label">Base Font Size</label>
                    <select class="form-control" id="fontSize" onchange="saveSettings()">
                        <option value="small">Small (10pt)</option>
                        <option value="medium" selected>Medium (12pt)</option>
                        <option value="large">Large (14pt)</option>
                    </select>
                </div>

                <!-- Show/Hide Elements -->
                <div class="form-group">
                    <label class="form-label">Show on Invoice</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showLogo" checked onchange="saveSettings()">
                            <span>Company Logo</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showCompanyDetails" checked onchange="saveSettings()">
                            <span>Company Details</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showCustomerDetails" checked onchange="saveSettings()">
                            <span>Customer Details</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showItemImages" onchange="saveSettings()">
                            <span>Product Images</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showNotes" checked onchange="saveSettings()">
                            <span>Notes/Terms</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="showPageNumbers" checked onchange="saveSettings()">
                            <span>Page Numbers</span>
                        </label>
                    </div>
                </div>

                <!-- Invoice Colors -->
                <div class="form-group">
                    <label class="form-label">Invoice Color Scheme</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;">
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Header Color</label>
                            <input type="color" class="form-control" id="invoiceHeaderColor" value="#00d4ff" onchange="saveSettings()">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Text Color</label>
                            <input type="color" class="form-control" id="invoiceTextColor" value="#000000" onchange="saveSettings()">
                        </div>
                        <div>
                            <label class="form-label" style="font-size: 0.85rem;">Accent Color</label>
                            <input type="color" class="form-control" id="invoiceAccentColor" value="#ff006e" onchange="saveSettings()">
                        </div>
                    </div>
                </div>

                <!-- Custom Footer Text -->
                <div class="form-group">
                    <label class="form-label">Invoice Footer Text</label>
                    <textarea class="form-control" id="invoiceFooter" rows="2" placeholder="Thank you for your business!" onchange="saveSettings()">Thank you for your business! Payment terms: 30 days from invoice date.</textarea>
                </div>

                <!-- Profit Margin Display Settings -->
                <div class="form-group" style="background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(6, 255, 165, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--success);">üí∞ Profit Margin Settings</h3>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                        <input type="checkbox" id="showProfitOnPrint" onchange="saveSettings()">
                        <span style="font-size: 0.9rem;">Show profit margins on printed invoices</span>
                    </label>
                    <p style="font-size: 0.8rem; opacity: 0.7; margin: 0.5rem 0 0 0;">
                        ‚ö†Ô∏è Warning: This will display cost prices and profit margins on the printed invoice. Only enable if you want customers to see this information.
                    </p>
                </div>

                <!-- Pricing Tier Cost Adjustments -->
                <div class="form-group" style="background: rgba(0, 212, 255, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; color: var(--primary);">üè∑Ô∏è Pricing Tier Cost Adjustments</h3>
                    <p style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 1rem;">
                        Set cost price multipliers for each tier. This allows you to account for bulk purchase discounts or different supplier pricing for different customer tiers.
                    </p>

                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #FFB6C1;">Retail:</label>
                            <input type="range" class="form-control" id="tierCostRetail" min="0.5" max="1.5" step="0.05" value="1.0"
                                   oninput="updateTierCostDisplay('retail', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostRetailDisplay" style="text-align: right; font-weight: 600;">1.00x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #DDA0DD;">Platinum:</label>
                            <input type="range" class="form-control" id="tierCostPlatinum" min="0.5" max="1.5" step="0.05" value="0.95"
                                   oninput="updateTierCostDisplay('platinum', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostPlatinumDisplay" style="text-align: right; font-weight: 600;">0.95x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #FFD700;">Gold:</label>
                            <input type="range" class="form-control" id="tierCostGold" min="0.5" max="1.5" step="0.05" value="0.90"
                                   oninput="updateTierCostDisplay('gold', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostGoldDisplay" style="text-align: right; font-weight: 600;">0.90x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #C0C0C0;">Silver:</label>
                            <input type="range" class="form-control" id="tierCostSilver" min="0.5" max="1.5" step="0.05" value="0.85"
                                   oninput="updateTierCostDisplay('silver', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostSilverDisplay" style="text-align: right; font-weight: 600;">0.85x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #87CEEB;">Rental:</label>
                            <input type="range" class="form-control" id="tierCostRental" min="0.5" max="1.5" step="0.05" value="0.80"
                                   oninput="updateTierCostDisplay('rental', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostRentalDisplay" style="text-align: right; font-weight: 600;">0.80x</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 150px 1fr 100px; gap: 0.5rem; align-items: center;">
                            <label style="font-weight: 600; color: #06FFA5;">Custom:</label>
                            <input type="range" class="form-control" id="tierCostCustom" min="0.5" max="1.5" step="0.05" value="1.0"
                                   oninput="updateTierCostDisplay('custom', this.value)" onchange="saveSettings()"
                                   style="padding: 0;">
                            <span id="tierCostCustomDisplay" style="text-align: right; font-weight: 600;">1.00x</span>
                        </div>
                    </div>

                    <p style="font-size: 0.75rem; opacity: 0.6; margin-top: 1rem; margin-bottom: 0;">
                        üí° Example: If a product's landed cost is R1000 and Platinum tier has 0.95x cost multiplier, the cost for Platinum customers will be R950 (5% bulk discount).
                    </p>
                </div>
            </div>

            <!-- Color Customization -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Brand Colors (System UI)</h2>
                    <button class="btn btn-outline btn-sm" onclick="resetColors()">Reset to Default</button>
                </div>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label class="form-label">Primary Color</label>
                        <input type="color" id="primaryColor" value="#00d4ff" onchange="updateColors()">
                    </div>
                    <div class="color-picker-item">
                        <label class="form-label">Secondary Color</label>
                        <input type="color" id="secondaryColor" value="#ff006e" onchange="updateColors()">
                    </div>
                    <div class="color-picker-item">
                        <label class="form-label">Accent Color</label>
                        <input type="color" id="accentColor" value="#7209b7" onchange="updateColors()">
                    </div>
                </div>
            </div>

            <!-- Company Information -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Company Information</h2>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="companyName" value="Aweh Be Lekker">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Trading As</label>
                        <input type="text" class="form-control" id="tradingAs" value="Awake South Africa">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="companyEmail" value="sales@awake.co.za">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="companyPhone" value="+27 21 555 0123">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Website</label>
                        <input type="url" class="form-control" id="companyWebsite" value="www.awake.co.za">
                    </div>
                    <div class="form-group">
                        <label class="form-label">VAT Number</label>
                        <input type="text" class="form-control" id="companyVAT" value="4123456789">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <textarea class="form-control" id="companyAddress">22 Porterfield Road
Table View, Cape Town
7439, South Africa</textarea>
                </div>
            </div>

            <!-- Banking Details -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Banking Details</h2>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="showBanking" checked onchange="saveSettings()">
                        <span style="font-size: 0.9rem; text-transform: none;">Show on invoices</span>
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Bank Name</label>
                        <input type="text" class="form-control" id="bankName" value="First National Bank">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Account Holder</label>
                        <input type="text" class="form-control" id="accountHolder" value="Aweh Be Lekker (Pty) Ltd">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Account Number</label>
                        <input type="text" class="form-control" id="accountNumber" value="62123456789">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Branch Code</label>
                        <input type="text" class="form-control" id="branchCode" value="250655">
                    </div>
                </div>
                <button class="btn btn-success" onclick="saveSettings()">üíæ Save All Settings</button>
            </div>
        </div>
    </div>

    <!-- Google Drive Setup Wizard Modal -->
    <div id="setupWizardModal" class="modal" role="dialog" aria-labelledby="wizardTitle" aria-modal="true">
        <div class="modal-content wizard-modal">
            <div class="wizard-header">
                <h2 id="wizardTitle">üöÄ Google Drive Setup Wizard</h2>
                <p style="opacity: 0.9; margin-top: 0.5rem;">Get unlimited cloud storage in just 5 minutes!</p>
            </div>

            <!-- Progress Tracker -->
            <div class="wizard-progress">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-number">1</div>
                    <div class="wizard-step-label">Welcome</div>
                </div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-number">2</div>
                    <div class="wizard-step-label">Create Project</div>
                </div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-number">3</div>
                    <div class="wizard-step-label">Enable API</div>
                </div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-number">4</div>
                    <div class="wizard-step-label">Get Credentials</div>
                </div>
                <div class="wizard-step" data-step="5">
                    <div class="wizard-step-number">5</div>
                    <div class="wizard-step-label">Connect</div>
                </div>
            </div>

            <!-- Wizard Content -->
            <div class="wizard-content">
                <!-- Step 1: Welcome -->
                <div class="wizard-step-content active" data-step="1">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Welcome to Google Drive Integration! üéâ</h3>

                    <p style="margin-bottom: 1rem; line-height: 1.6;">
                        You're about to unlock <strong>unlimited cloud storage</strong> for your invoice system!
                    </p>

                    <div class="wizard-success">
                        <h4 style="margin-bottom: 0.75rem;">‚ú® What You'll Get:</h4>
                        <ul style="text-align: left; margin-left: 2rem; line-height: 1.8;">
                            <li>‚òÅÔ∏è <strong>15 GB free storage</strong> (3000x more than localStorage)</li>
                            <li>üì± <strong>Multi-device sync</strong> - Access from anywhere</li>
                            <li>üíæ <strong>Automatic backups</strong> - Never lose data</li>
                            <li>üîí <strong>Secure & private</strong> - Your data, your Google Drive</li>
                            <li>‚ö° <strong>Offline support</strong> - Works without internet</li>
                        </ul>
                    </div>

                    <div class="wizard-alert">
                        <strong>‚è±Ô∏è Time Required:</strong> 5-10 minutes (one-time setup)<br>
                        <strong>üí∞ Cost:</strong> FREE (uses your free Google Drive storage)<br>
                        <strong>üîß Technical Level:</strong> Easy - we'll guide you step-by-step
                    </div>

                    <p style="margin-top: 1rem; opacity: 0.8;">
                        Click <strong>Next</strong> to begin the setup process!
                    </p>
                </div>

                <!-- Step 2: Create Google Cloud Project -->
                <div class="wizard-step-content" data-step="2">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 1: Create Google Cloud Project</h3>

                    <div class="wizard-instruction">
                        <h4>üìù Instructions:</h4>
                        <ol>
                            <li>Click the button below to open Google Cloud Console</li>
                            <li>Sign in with your Google account</li>
                            <li>Click <strong>"Select a project"</strong> at the top</li>
                            <li>Click <strong>"New Project"</strong></li>
                            <li>Enter project name: <strong>"Aweh Invoice System"</strong></li>
                            <li>Click <strong>"Create"</strong></li>
                            <li>Wait 30 seconds for project creation</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/projectcreate" target="_blank" class="wizard-link-btn">
                        üåê Open Google Cloud Console
                    </a>

                    <div class="wizard-copy-box">
                        <input type="text" value="Aweh Invoice System" readonly id="projectNameCopy">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('projectNameCopy')">üìã Copy</button>
                    </div>

                    <div class="wizard-alert">
                        <strong>üí° Tip:</strong> Keep the Google Cloud Console tab open - you'll need it for the next steps!
                    </div>
                </div>

                <!-- Step 3: Enable Google Drive API -->
                <div class="wizard-step-content" data-step="3">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 2: Enable Google Drive API</h3>

                    <div class="wizard-instruction">
                        <h4>üìù Instructions:</h4>
                        <ol>
                            <li>Make sure your project "Aweh Invoice System" is selected</li>
                            <li>Click the button below to go to the API Library</li>
                            <li>Search for: <strong>"Google Drive API"</strong></li>
                            <li>Click on <strong>"Google Drive API"</strong> in the results</li>
                            <li>Click the <strong>"Enable"</strong> button</li>
                            <li>Wait 10 seconds for activation</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/library" target="_blank" class="wizard-link-btn">
                        üåê Open API Library
                    </a>

                    <div class="wizard-copy-box">
                        <input type="text" value="Google Drive API" readonly id="apiNameCopy">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('apiNameCopy')">üìã Copy</button>
                    </div>

                    <div class="wizard-alert">
                        <strong>‚úÖ Success Check:</strong> You should see "API enabled" with a green checkmark!
                    </div>
                </div>

                <!-- Step 4: Get OAuth Credentials -->
                <div class="wizard-step-content" data-step="4">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 3: Get Your OAuth Credentials</h3>

                    <div class="wizard-instruction">
                        <h4>üìù Part A: Configure OAuth Consent Screen</h4>
                        <ol>
                            <li>Click the button below to open OAuth consent screen</li>
                            <li>Select <strong>"External"</strong> user type</li>
                            <li>Click <strong>"Create"</strong></li>
                            <li>Fill in:
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li><strong>App name:</strong> Aweh Invoice System</li>
                                    <li><strong>User support email:</strong> Your email</li>
                                    <li><strong>Developer contact:</strong> Your email</li>
                                </ul>
                            </li>
                            <li>Click <strong>"Save and Continue"</strong> (3 times)</li>
                            <li>Click <strong>"Back to Dashboard"</strong></li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/credentials/consent" target="_blank" class="wizard-link-btn">
                        üåê Open OAuth Consent Screen
                    </a>

                    <div class="wizard-instruction" style="margin-top: 1.5rem;">
                        <h4>üìù Part B: Create OAuth Client ID</h4>
                        <ol>
                            <li>Click the button below to create credentials</li>
                            <li>Click <strong>"Create Credentials"</strong> ‚Üí <strong>"OAuth client ID"</strong></li>
                            <li>Application type: <strong>"Web application"</strong></li>
                            <li>Name: <strong>"Aweh Invoice Web Client"</strong></li>
                            <li>Under <strong>"Authorized JavaScript origins"</strong>, click <strong>"Add URI"</strong> and add:
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li><code>http://localhost</code></li>
                                    <li><code>http://localhost:8000</code></li>
                                    <li><code>file://</code></li>
                                </ul>
                            </li>
                            <li>Click <strong>"Create"</strong></li>
                            <li><strong>IMPORTANT:</strong> Copy your <strong>Client ID</strong> (looks like: 123456789-abc...xyz.apps.googleusercontent.com)</li>
                        </ol>
                    </div>

                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="wizard-link-btn">
                        üåê Create Credentials
                    </a>

                    <div class="wizard-alert">
                        <strong>‚ö†Ô∏è Important:</strong> Keep your Client ID safe - you'll need it in the next step!
                    </div>
                </div>

                <!-- Step 5: Connect & Test -->
                <div class="wizard-step-content" data-step="5">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Step 4: Connect Your Invoice System</h3>

                    <p style="margin-bottom: 1rem;">
                        Almost done! Now paste your <strong>Client ID</strong> below to connect your invoice system to Google Drive.
                    </p>

                    <div class="wizard-validation" id="clientIdValidation">
                        <label class="form-label" style="margin-bottom: 0.5rem; display: block;">
                            <strong>Your OAuth Client ID:</strong>
                        </label>
                        <input
                            type="text"
                            id="clientIdInput"
                            placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
                            oninput="validateClientId(this.value)"
                        >
                        <div class="wizard-validation-msg success">
                            ‚úÖ Valid Client ID format! Click "Test Connection" to verify.
                        </div>
                        <div class="wizard-validation-msg error">
                            ‚ùå Invalid format. Client ID should end with .apps.googleusercontent.com
                        </div>
                    </div>

                    <button class="btn btn-primary u-mt-1" onclick="testGoogleDriveConnection()" id="testConnectionBtn" disabled>
                        üîå Test Connection
                    </button>

                    <div id="connectionResult" class="u-mt-1 is-hidden"></div>

                    <div class="wizard-instruction" style="margin-top: 1.5rem;">
                        <h4>üìù What happens next:</h4>
                        <ol>
                            <li>Click <strong>"Test Connection"</strong></li>
                            <li>A Google sign-in popup will appear</li>
                            <li>Sign in with your Google account</li>
                            <li>Grant permission to access Google Drive</li>
                            <li>Your invoice system will connect to Google Drive!</li>
                        </ol>
                    </div>

                    <div class="wizard-alert">
                        <strong>üîí Privacy:</strong> Your data goes directly from your browser to YOUR Google Drive. We never see or store your data!
                    </div>
                </div>
            </div>

            <!-- Wizard Footer -->
            <div class="wizard-footer">
                <button class="btn btn-outline" onclick="wizardPrevStep()" id="wizardPrevBtn" style="display: none;">
                    ‚Üê Previous
                </button>
                <button class="btn btn-outline" onclick="closeModal('setupWizardModal')">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="wizardNextStep()" id="wizardNextBtn">
                    Next ‚Üí
                </button>
                <button class="btn btn-success" onclick="finishWizard()" id="wizardFinishBtn" style="display: none;">
                    üéâ Finish Setup
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Google Sync Setup (Minimal) -->
    <div id="quickGoogleSetupModal" class="modal" role="dialog" aria-labelledby="quickGoogleSetupTitle" aria-modal="true">
        <div class="modal-content wizard-modal">
            <div class="wizard-header">
                <h2 id="quickGoogleSetupTitle">üîó Connect Google Drive</h2>
                <p style="opacity: 0.9; margin-top: 0.5rem;">One-time setup: paste your Client ID, then sign in.</p>
            </div>

            <div class="wizard-content">
                <div class="wizard-instruction">
                    <h4>üìù What you need (one time)</h4>
                    <ol>
                        <li>Create an <strong>OAuth Client ID</strong> in Google Cloud (Web application)</li>
                        <li>Add this as an <strong>Authorized JavaScript origin</strong>:</li>
                    </ol>
                    <div class="wizard-copy-box">
                        <input type="text" readonly id="quickOriginCopy" value="">
                        <button class="wizard-copy-btn" onclick="copyToClipboard('quickOriginCopy')">üìã Copy</button>
                    </div>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="wizard-link-btn">
                        üåê Open Google Credentials
                    </a>
                </div>

                <div class="wizard-validation" id="quickClientIdValidation" style="margin-top: 1rem;">
                    <label class="form-label" style="margin-bottom: 0.5rem; display: block;">
                        <strong>Your OAuth Client ID:</strong>
                    </label>
                    <input
                        type="text"
                        id="quickClientIdInput"
                        placeholder="123456789-abcdefghijklmnop.apps.googleusercontent.com"
                        oninput="validateQuickClientId(this.value)"
                    >
                    <div class="wizard-validation-msg success">
                        ‚úÖ Looks good. Click ‚ÄúConnect Google‚Äù.
                    </div>
                    <div class="wizard-validation-msg error">
                        ‚ùå Invalid format. Client ID should end with .apps.googleusercontent.com
                    </div>
                </div>

                <button class="btn btn-primary u-mt-1" onclick="quickConnectGoogleDrive()" id="quickConnectBtn" disabled>
                    üîó Connect Google
                </button>

                <div id="quickConnectionResult" class="u-mt-1 is-hidden"></div>

                <div class="wizard-alert" style="margin-top: 1rem;">
                    <strong>After this:</strong> the header button becomes ‚ÄúSync Google‚Äù ‚Üí popup login ‚Üí done.
                </div>
            </div>

            <div class="wizard-footer">
                <button class="btn btn-outline" onclick="openSetupWizard()">Need help? Full wizard</button>
                <button class="btn btn-outline" onclick="closeModal('quickGoogleSetupModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Invoice Modal -->
    <div id="invoiceModal" class="modal" role="dialog" aria-labelledby="invoiceModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="invoiceModalTitle">Create New Invoice</h2>
                <button class="close-modal" onclick="closeModal('invoiceModal')" aria-label="Close modal">√ó</button>
            </div>

            <!-- AI Smart Suggestions Bar -->
            <div id="aiSuggestionsBar" style="display: none; background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(6, 255, 165, 0.2)); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(0, 212, 255, 0.3);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">ü§ñ</span>
                    <strong>AI Suggestions</strong>
                </div>
                <div id="aiSuggestionsContent"></div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Customer *</label>
                    <div style="position: relative;">
                        <select class="form-control" id="invoiceCustomer" required onchange="onCustomerSelected()">
                            <option value="">Select Customer...</option>
                        </select>
                        <div id="customerSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: rgba(10, 14, 39, 0.98); border: 1px solid rgba(0, 212, 255, 0.3); border-radius: 8px; margin-top: 0.25rem; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;"></div>
                    </div>
                    <small id="customerInsight" style="display: none; color: rgba(6, 255, 165, 0.8); margin-top: 0.25rem;"></small>
                </div>
                <div class="form-group">
                    <label class="form-label">Pricing Tier</label>
                    <select class="form-control" id="invoiceTier" onchange="onPricingTierChanged()">
                        <option value="retail">Retail (+35%)</option>
                        <option value="platinum">Platinum Dealer (-20%)</option>
                        <option value="gold">Gold Dealer (-15%)</option>
                        <option value="silver">Silver Dealer (-12%)</option>
                        <option value="rental">Rental Fleet (-25%)</option>
                        <option value="custom">Custom</option>
                    </select>
                    <small id="tierSuggestion" style="display: none; color: rgba(255, 165, 0, 0.8); margin-top: 0.25rem;"></small>
                </div>
            </div>

            <!-- AI Quick Actions -->
            <div id="aiQuickActions" style="display: none; margin-bottom: 1rem;">
                <label class="form-label">‚ö° Quick Actions</label>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="repeatLastInvoice()" title="Copy items from last invoice to this customer">
                        üîÑ Repeat Last Order
                    </button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="addRecommendedProducts()" title="Add products this customer usually buys">
                        üí° Add Usual Items
                    </button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showCustomerHistory()" title="View customer's invoice history">
                        üìä View History
                    </button>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Document Type</label>
                    <select class="form-control" id="invoiceType">
                        <option value="invoice">Invoice</option>
                        <option value="quote">Quote</option>
                        <option value="proforma">Proforma Invoice</option>
                        <option value="credit_note">Credit Note</option>
                        <option value="purchase_order">Purchase Order</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">VAT Handling</label>
                    <select class="form-control" id="invoiceVAT">
                        <option value="include">Include VAT (15%)</option>
                        <option value="exclude">Exclude VAT</option>
                        <option value="none">No VAT</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="invoiceStatus">
                        <option value="draft">üìù Draft</option>
                        <option value="sent">üì§ Sent</option>
                        <option value="partial">üí∞ Partially Paid</option>
                        <option value="paid">‚úÖ Paid</option>
                        <option value="overdue">‚ö†Ô∏è Overdue</option>
                        <option value="cancelled">‚ùå Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Terms (Days)</label>
                    <select class="form-control" id="paymentTerms" onchange="updateDueDate()">
                        <option value="0">Due on Receipt</option>
                        <option value="7">Net 7 Days</option>
                        <option value="14">Net 14 Days</option>
                        <option value="30" selected>Net 30 Days</option>
                        <option value="60">Net 60 Days</option>
                        <option value="90">Net 90 Days</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Invoice Date</label>
                    <input type="date" class="form-control" id="invoiceDate" onchange="updateDueDate()">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" class="form-control" id="invoiceDueDate">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Add Products</label>
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('favorites')" title="Favorite Products">‚≠ê Favorites</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('recent')" title="Recently Used">üïê Recent</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('awake')" title="Awake Products">üèÑ Jetboards</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('aqua')" title="Aqua Marina">üåä Aqua Marina</button>
                    <button type="button" class="btn btn-outline btn-sm" onclick="showProductCategory('all')" title="All Products">üì¶ All</button>
                </div>
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="form-control" id="invoiceProductSearch" placeholder="Search products to add..." autocomplete="off" onfocus="showProductSearchResults()">
                </div>
                <div id="productSearchResults" class="product-search-results" style="display: none; max-height: 400px; overflow-y: auto;">
                    <!-- Product search results will appear here -->
                </div>
            </div>

            <!-- AI Product Recommendations -->
            <div id="aiProductRecommendations" style="display: none; background: rgba(6, 255, 165, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(6, 255, 165, 0.3);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="font-size: 1.1rem;">üí°</span>
                        <strong>Customers also bought:</strong>
                    </div>
                    <button type="button" onclick="document.getElementById('aiProductRecommendations').style.display='none'" style="background: none; border: none; color: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.2rem;">√ó</button>
                </div>
                <div id="recommendedProductsList" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
            </div>

            <div class="invoice-items-table">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>SKU</th>
                            <th>Qty</th>
                            <th>Cost</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Profit</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceItemsBody">
                        <tr>
                            <td colspan="8" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="form-row" style="margin-top: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Discount</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="number" class="form-control" id="discountAmount" placeholder="0" onchange="calculateInvoiceTotal()">
                        <select class="form-control" id="discountType" style="max-width: 120px;" onchange="calculateInvoiceTotal()">
                            <option value="percentage">%</option>
                            <option value="fixed">Fixed</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Shipping Cost</label>
                    <input type="number" class="form-control" id="shippingCost" placeholder="0" onchange="calculateInvoiceTotal()">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Deposit Amount</label>
                <input type="number" class="form-control" id="depositAmount" placeholder="0" onchange="calculateInvoiceTotal()">
            </div>

            <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 1.1rem;">
                    <div>
                        <strong>Subtotal:</strong>
                        <span id="invoiceSubtotal" style="float: right;">R 0.00</span>
                    </div>
                    <div>
                        <strong>VAT (15%):</strong>
                        <span id="invoiceVATAmount" style="float: right;">R 0.00</span>
                    </div>
                    <div style="grid-column: 1 / -1; font-size: 1.5rem; color: var(--success); font-weight: 700; border-top: 2px solid var(--primary); padding-top: 1rem;">
                        <strong>TOTAL:</strong>
                        <span id="invoiceTotal" style="float: right;">R 0.00</span>
                    </div>
                    <div id="paymentTrackingSection" style="grid-column: 1 / -1; border-top: 2px solid rgba(255,255,255,0.1); padding-top: 1rem; display: none;">
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Amount Paid:</strong>
                            <span id="invoiceAmountPaid" style="float: right; color: var(--success);">R 0.00</span>
                        </div>
                        <div style="font-size: 1.3rem; color: var(--accent);">
                            <strong>Balance Due:</strong>
                            <span id="invoiceBalance" style="float: right;">R 0.00</span>
                        </div>
                    </div>

                    <!-- Profit Margin Section (INTERNAL USE ONLY - NOT PRINTED) -->
                    <div id="profitMarginSection" style="grid-column: 1 / -1; border-top: 2px solid rgba(6, 255, 165, 0.3); padding-top: 1rem; margin-top: 1rem; background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.1)); padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="color: var(--success); margin: 0;">üí∞ Profit Analysis (Internal Only)</h4>
                            <span style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">üìä Visible only to you</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Total Cost:</strong>
                            <span id="invoiceTotalCost" style="float: right; color: var(--warning);">R 0.00</span>
                        </div>
                        <div style="margin-bottom: 0.5rem;">
                            <strong>Total Revenue:</strong>
                            <span id="invoiceTotalRevenue" style="float: right; color: var(--primary);">R 0.00</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; font-size: 1.2rem;">
                            <strong>Gross Profit:</strong>
                            <span id="invoiceGrossProfit" style="float: right; color: var(--success);">R 0.00</span>
                        </div>
                        <div style="font-size: 1.3rem; font-weight: 700;">
                            <strong>Profit Margin:</strong>
                            <span id="invoiceProfitMargin" style="float: right; color: var(--success);">0%</span>
                        </div>
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.85rem; color: rgba(255,255,255,0.7);">
                            üí° <strong>Tip:</strong> Adjust unit prices above to see profit margins update in real-time
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Recording Section -->
            <div id="paymentSection" style="background: rgba(255, 0, 110, 0.1); padding: 1.5rem; border-radius: 8px; margin: 1.5rem 0; display: none;">
                <h3 style="margin-bottom: 1rem; color: var(--secondary);">üí∞ Record Payment</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Amount</label>
                        <input type="number" class="form-control" id="paymentAmount" placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" id="paymentDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-control" id="paymentMethod">
                            <option value="eft">EFT/Bank Transfer</option>
                            <option value="cash">Cash</option>
                            <option value="card">Credit/Debit Card</option>
                            <option value="cheque">Cheque</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reference/Notes</label>
                        <input type="text" class="form-control" id="paymentReference" placeholder="Payment reference">
                    </div>
                </div>
                <button type="button" class="btn btn-success btn-sm" onclick="recordPayment()">üíµ Add Payment</button>

                <!-- Payment History -->
                <div id="paymentHistory" style="margin-top: 1rem; display: none;">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.7);">Payment History:</h4>
                    <div id="paymentHistoryList" style="font-size: 0.85rem;"></div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: space-between; align-items: center;">
                <div>
                    <button type="button" class="btn btn-outline btn-sm" id="togglePaymentBtn" onclick="togglePaymentSection()" style="display: none;">üí∞ Record Payment</button>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invoiceModal')">Cancel</button>
                    <button type="button" class="btn btn-accent" onclick="sendViaWhatsApp()" id="whatsappBtn" style="display: none;">üì± WhatsApp</button>
                    <button type="button" class="btn btn-secondary" onclick="sendViaEmail()" id="emailBtn" style="display: none;">üìß Email</button>
                    <button type="button" class="btn btn-success" onclick="saveInvoice()">üíæ Save Invoice</button>
                    <button type="button" class="btn btn-primary" onclick="printInvoice()">üñ®Ô∏è Print</button>
                </div>
            </div>
        </div>
    </div>

        <!-- Add Customer Modal -->
    <div id="customerModal" class="modal" role="dialog" aria-labelledby="customerModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="customerModalTitle">Add New Customer</h2>
                <button class="close-modal" onclick="closeModal('customerModal')" aria-label="Close modal">√ó</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Customer Name *</label>
                    <input type="text" class="form-control" id="customerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Company</label>
                    <input type="text" class="form-control" id="customerCompany">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="customerEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="customerPhone">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <textarea class="form-control" id="customerAddress"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">VAT Number</label>
                    <input type="text" class="form-control" id="customerVAT">
                </div>
                <div class="form-group">
                    <label class="form-label">Default Pricing Tier</label>
                    <select class="form-control" id="customerTier">
                        <option value="retail">Retail</option>
                        <option value="platinum">Platinum Dealer</option>
                        <option value="gold">Gold Dealer</option>
                        <option value="silver">Silver Dealer</option>
                        <option value="rental">Rental Fleet</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button class="btn btn-outline" onclick="closeModal('customerModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveCustomer()">üíæ Save Customer</button>
            </div>
        </div>
    </div>

    <!-- Reports Modal -->
    <div id="reportsModal" class="modal" role="dialog" aria-labelledby="reportsModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="reportsModalTitle">üìä Business Reports</h2>
                <button class="close-modal" onclick="closeModal('reportsModal')" aria-label="Close modal">√ó</button>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(6, 255, 165, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="reportTotalInvoices">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Invoices</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(6, 255, 165, 0.2), rgba(0, 212, 255, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="reportTotalRevenue">R 0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Total Revenue</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(255, 0, 110, 0.2), rgba(0, 212, 255, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="reportOutstanding">R 0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Outstanding</div>
                </div>
                <div style="background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(255, 0, 110, 0.2)); padding: 1.5rem; border-radius: 8px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="reportOverdue">0</div>
                    <div style="font-size: 0.9rem; opacity: 0.8;">Overdue Invoices</div>
                </div>
            </div>

            <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Status Breakdown</h3>
                <div id="statusBreakdown" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;"></div>
            </div>

            <div style="background: rgba(6, 255, 165, 0.1); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 1rem;">Top Customers</h3>
                <div id="topCustomers"></div>
            </div>

            <div style="background: rgba(255, 0, 110, 0.1); padding: 1.5rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem;">Monthly Revenue (Last 6 Months)</h3>
                <div id="monthlyRevenue"></div>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('reportsModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportReportData()">üì• Export Report</button>
            </div>
        </div>
    </div>

    <!-- Add Supplier Modal -->
    <div id="supplierModal" class="modal" role="dialog" aria-labelledby="supplierModalTitle" aria-modal="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="supplierModalTitle">Add New Supplier</h2>
                <button class="close-modal" onclick="closeModal('supplierModal')" aria-label="Close modal">√ó</button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Supplier Name *</label>
                    <input type="text" class="form-control" id="supplierName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Person</label>
                    <input type="text" class="form-control" id="supplierContact">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="supplierEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="supplierPhone">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-control" id="supplierWebsite" placeholder="https://">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-control" id="supplierCategory">
                        <option value="jetboards">Jetboards & E-foils</option>
                        <option value="watersports">Water Sports Equipment</option>
                        <option value="accessories">Accessories</option>
                        <option value="parts">Parts & Components</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Address</label>
                <textarea class="form-control" id="supplierAddress" rows="2"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Notes</label>
                <textarea class="form-control" id="supplierNotes" rows="2" placeholder="Additional information about this supplier..."></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Supplier Logo</label>
                <input type="file" class="form-control" id="supplierLogoUpload" accept="image/*" onchange="handleSupplierLogoUpload(event)">
                <img id="supplierLogoPreview" style="max-width: 200px; margin-top: 0.5rem; display: none;" alt="Supplier logo preview">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button type="button" class="btn btn-outline" onclick="closeModal('supplierModal')">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveSupplier()">üíæ Save Supplier</button>
            </div>
        </div>
    </div>

    <!-- OCR Scanner Modal -->
    <div id="scannerModal" class="modal" role="dialog" aria-labelledby="scannerModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title" id="scannerModalTitle">üì∑ Scan Document</h2>
                <button class="close-modal" onclick="closeModal('scannerModal')" aria-label="Close modal">√ó</button>
            </div>

            <div id="scannerContent">
                <div style="text-align: center; padding: 2rem;">
                    <p style="margin-bottom: 1rem;">Choose how to scan your document:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="startCamera()" style="padding: 2rem;">
                            üì∏ Use Camera<br>
                            <small style="opacity: 0.7;">Take a photo with your device camera</small>
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('scanFileUpload').click()" style="padding: 2rem;">
                            üìÅ Upload File<br>
                            <small style="opacity: 0.7;">Select an image from your device</small>
                        </button>
                    </div>
                    <input type="file" id="scanFileUpload" accept="image/*" style="display: none;" onchange="handleScanFileUpload(event)">
                </div>

                <!-- Camera View -->
                <div id="cameraView" style="display: none;">
                    <video id="cameraPreview" autoplay playsinline style="width: 100%; border-radius: 8px;"></video>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="btn btn-success" onclick="capturePhoto()">üì∏ Capture</button>
                        <button type="button" class="btn btn-outline" onclick="stopCamera()">Cancel</button>
                    </div>
                </div>

                <!-- Captured Image -->
                <div id="capturedImageView" style="display: none;">
                    <canvas id="capturedCanvas" style="width: 100%; border-radius: 8px;"></canvas>
                    <div id="ocrProgress" style="margin-top: 1rem; text-align: center; display: none;">
                        <div style="padding: 1rem; background: rgba(0, 212, 255, 0.2); border-radius: 8px;">
                            <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">üîç Processing...</div>
                            <div id="ocrStatus">Initializing OCR...</div>
                            <div style="margin-top: 0.5rem;">
                                <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="ocrProgressBar" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem;">
                        <button type="button" class="btn btn-primary" onclick="processOCR()" id="processBtn">üîç Extract Text</button>
                        <button type="button" class="btn btn-outline" onclick="resetScanner()">Try Again</button>
                    </div>
                </div>

                <!-- OCR Results -->
                <div id="ocrResults" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Extracted Data:</h3>
                    <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <pre id="ocrText" style="white-space: pre-wrap; font-family: monospace; font-size: 0.9rem;"></pre>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="resetScanner()">Scan Another</button>
                        <button type="button" class="btn btn-success" onclick="analyzeSupplierInvoice()">ü§ñ Analyze Invoice</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Business Modal -->
    <div id="businessModal" class="modal" role="dialog" aria-labelledby="businessModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="businessModalTitle">‚ûï Add New Business</h2>
                <button class="close-modal" onclick="closeModal('businessModal')" aria-label="Close modal">√ó</button>
            </div>

            <div style="padding: 1.5rem;">
                <div class="form-group">
                    <label class="form-label">Business Name *</label>
                    <input type="text" class="form-control" id="businessName" placeholder="e.g., Aweh Be Lekker">
                </div>

                <div class="form-group">
                    <label class="form-label">Trading As (Optional)</label>
                    <input type="text" class="form-control" id="businessTradingAs" placeholder="e.g., Aweh Watersports">
                </div>

                <div class="form-group">
                    <label class="form-label">Business Type</label>
                    <select class="form-control" id="businessType">
                        <option value="retail">Retail</option>
                        <option value="wholesale">Wholesale</option>
                        <option value="service">Service</option>
                        <option value="rental">Rental</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Registration Number</label>
                    <input type="text" class="form-control" id="businessRegNumber" placeholder="e.g., 2021/123456/07">
                </div>

                <div class="form-group">
                    <label class="form-label">VAT Number</label>
                    <input type="text" class="form-control" id="businessVatNumber" placeholder="e.g., 4123456789">
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn btn-outline" onclick="closeModal('businessModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveNewBusiness()">üíæ Save Business</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Switch Business Modal -->
    <div id="switchBusinessModal" class="modal" role="dialog" aria-labelledby="switchBusinessModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title" id="switchBusinessModalTitle">üîÑ Switch Business</h2>
                <button class="close-modal" onclick="closeModal('switchBusinessModal')" aria-label="Close modal">√ó</button>
            </div>

            <div style="padding: 1.5rem;">
                <p style="margin-bottom: 1.5rem; color: rgba(255,255,255,0.7);">
                    Select which business you want to work with. Each business has its own settings, products, and invoices.
                </p>
                <div id="businessSwitchList" style="display: grid; gap: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Supplier Invoice Analysis Modal -->
    <div id="invoiceAnalysisModal" class="modal" role="dialog" aria-labelledby="analysisModalTitle" aria-modal="true">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="analysisModalTitle">ü§ñ AI Invoice Analysis</h2>
                <button class="close-modal" onclick="closeModal('invoiceAnalysisModal')" aria-label="Close modal">√ó</button>
            </div>

            <div style="padding: 1.5rem;">
                <!-- Supplier Recognition -->
                <div id="supplierRecognitionSection" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">üì¶ Supplier Recognition</h3>
                    <div id="supplierRecognitionResult" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                        <div style="text-align: center; color: rgba(255,255,255,0.5);">Analyzing...</div>
                    </div>
                </div>

                <!-- Product Analysis -->
                <div id="productAnalysisSection" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">üìä Product & Price Analysis</h3>
                    <div id="productAnalysisResult" style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 8px;">
                        <div style="text-align: center; color: rgba(255,255,255,0.5);">Analyzing...</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.1);">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invoiceAnalysisModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="applyPriceUpdates()" id="applyUpdatesBtn" style="display: none;">‚úÖ Apply Updates</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="polite" aria-atomic="true"></div>

    <script>
        // Global State
        let products = [];
        let invoices = [];
        let customers = [];
        let payments = []; // Track all payments
        let suppliers = []; // Supplier management
        let businesses = []; // Multi-business support
        let currentBusiness = null; // Active business
        let favoriteProducts = []; // User's favorite products
        let recentProducts = []; // Recently used products
        let currentInvoice = {
            items: [],
            subtotal: 0,
            vat: 0,
            total: 0,
            status: 'draft', // draft, sent, paid, partial, overdue
            dueDate: '',
            paymentTerms: 30, // days
            amountPaid: 0,
            balance: 0
        };

        // Input Validation Helpers
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(String(email).toLowerCase());
        }

        function validatePhone(phone) {
            // Accepts various phone formats including South African numbers
            const re = /^[\+]?[(]?[0-9]{1,4}[)]?[-\s\.]?[(]?[0-9]{1,4}[)]?[-\s\.]?[0-9]{1,9}$/;
            return !phone || re.test(phone.replace(/\s/g, ''));
        }

        function sanitizeNumber(value, min = 0, max = Infinity) {
            const num = parseFloat(value) || 0;
            return Math.max(min, Math.min(max, num));
        }

        // Date Helper Functions
        function updateDueDate() {
            const invoiceDate = document.getElementById('invoiceDate')?.value;
            const paymentTerms = parseInt(document.getElementById('paymentTerms')?.value || 30);

            if (invoiceDate) {
                const date = new Date(invoiceDate);
                date.setDate(date.getDate() + paymentTerms);
                document.getElementById('invoiceDueDate').value = date.toISOString().split('T')[0];
            }
        }

        async function checkOverdueInvoices() {
            const today = new Date().toISOString().split('T')[0];
            invoices.forEach(inv => {
                if (inv.dueDate && inv.dueDate < today && inv.status !== 'paid' && inv.status !== 'cancelled') {
                    inv.status = 'overdue';
                }
            });
            await saveToStorage('aweh_invoices', invoices);
        }

        // Status Helper Functions
        function getStatusBadge(status) {
            const badges = {
                'draft': '<span style="padding: 0.25rem 0.75rem; background: rgba(128, 128, 128, 0.3); border-radius: 20px; font-size: 0.85rem;">üìù Draft</span>',
                'sent': '<span style="padding: 0.25rem 0.75rem; background: rgba(0, 212, 255, 0.3); border-radius: 20px; font-size: 0.85rem;">üì§ Sent</span>',
                'partial': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 165, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">üí∞ Partial</span>',
                'paid': '<span style="padding: 0.25rem 0.75rem; background: rgba(0, 255, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">‚úÖ Paid</span>',
                'overdue': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 0, 0, 0.3); border-radius: 20px; font-size: 0.85rem;">‚ö†Ô∏è Overdue</span>',
                'cancelled': '<span style="padding: 0.25rem 0.75rem; background: rgba(255, 0, 110, 0.3); border-radius: 20px; font-size: 0.85rem;">‚ùå Cancelled</span>'
            };
            return badges[status] || badges['draft'];
        }

        // Payment Recording Functions
        function togglePaymentSection() {
            const section = document.getElementById('paymentSection');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';

            // Set default payment date to today
            if (section.style.display === 'block') {
                document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            }
        }

        function recordPayment() {
            const amount = parseFloat(document.getElementById('paymentAmount').value || 0);
            if (amount <= 0) {
                showToast('Please enter a valid payment amount', 'error');
                return;
            }

            const balance = currentInvoice.total - (currentInvoice.amountPaid || 0);
            if (amount > balance) {
                if (!confirm(`Payment amount (R ${formatNumber(amount)}) exceeds balance (R ${formatNumber(balance)}). Continue?`)) {
                    return;
                }
            }

            const payment = {
                id: Date.now(),
                invoiceId: currentInvoice.id,
                amount: amount,
                date: document.getElementById('paymentDate').value,
                method: document.getElementById('paymentMethod').value,
                reference: document.getElementById('paymentReference').value
            };

            // Initialize payments array if needed
            if (!currentInvoice.payments) {
                currentInvoice.payments = [];
            }
            currentInvoice.payments.push(payment);

            // Update amounts
            currentInvoice.amountPaid = (currentInvoice.amountPaid || 0) + amount;
            currentInvoice.balance = currentInvoice.total - currentInvoice.amountPaid;

            // Update status
            if (currentInvoice.balance <= 0) {
                currentInvoice.status = 'paid';
                document.getElementById('invoiceStatus').value = 'paid';
            } else if (currentInvoice.amountPaid > 0) {
                currentInvoice.status = 'partial';
                document.getElementById('invoiceStatus').value = 'partial';
            }

            // Update UI
            updatePaymentDisplay();

            // Clear payment form
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentReference').value = '';

            showToast('Payment recorded successfully!', 'success');
        }

        function updatePaymentDisplay() {
            const amountPaid = currentInvoice.amountPaid || 0;
            const balance = currentInvoice.total - amountPaid;

            document.getElementById('invoiceAmountPaid').textContent = 'R ' + formatNumber(Math.round(amountPaid));
            document.getElementById('invoiceBalance').textContent = 'R ' + formatNumber(Math.round(balance));

            // Show/hide payment tracking section
            const trackingSection = document.getElementById('paymentTrackingSection');
            if (amountPaid > 0) {
                trackingSection.style.display = 'block';
            } else {
                trackingSection.style.display = 'none';
            }

            // Show payment history
            if (currentInvoice.payments && currentInvoice.payments.length > 0) {
                const historyDiv = document.getElementById('paymentHistory');
                const historyList = document.getElementById('paymentHistoryList');

                historyList.innerHTML = currentInvoice.payments.map(p => `
                    <div style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.5rem;">
                        <strong>R ${formatNumber(p.amount)}</strong> - ${p.date} - ${p.method}
                        ${p.reference ? `<br><small>Ref: ${p.reference}</small>` : ''}
                    </div>
                `).join('');

                historyDiv.style.display = 'block';
            }
        }

        // WhatsApp Integration
        function sendViaWhatsApp() {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before sending', 'error');
                return;
            }

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }

            if (!customer.phone) {
                showToast('Customer has no phone number', 'error');
                return;
            }

            // Format phone number for WhatsApp (remove spaces, dashes, etc.)
            let phone = customer.phone.replace(/[\s\-\(\)]/g, '');
            if (!phone.startsWith('+')) {
                // Assume South African number if no country code
                phone = '+27' + phone.replace(/^0/, '');
            }

            const invoiceNumber = currentInvoice.number || 'DRAFT';
            const total = formatNumber(Math.round(currentInvoice.total));
            const dueDate = currentInvoice.dueDate || 'TBD';

            const message = `Hi ${customer.name},

Your invoice from ${settings.companyName} is ready!

üìÑ Invoice #: ${invoiceNumber}
üí∞ Total: R ${total}
üìÖ Due Date: ${dueDate}

Items:
${currentInvoice.items.map(item => `‚Ä¢ ${item.name} (${item.qty}x) - R ${formatNumber(item.total)}`).join('\n')}

${settings.bankName ? `\nBank Details:\n${settings.bankName}\nAcc: ${settings.accountNumber}\nBranch: ${settings.branchCode}` : ''}

Thank you for your business!
${settings.companyName}
${settings.phone}`;

            const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');

            // Update status to sent if it was draft
            if (currentInvoice.status === 'draft') {
                currentInvoice.status = 'sent';
                document.getElementById('invoiceStatus').value = 'sent';
            }

            showToast('Opening WhatsApp...', 'success');
        }

        // Email Integration
        function sendViaEmail() {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before sending', 'error');
                return;
            }

            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }

            if (!customer.email) {
                showToast('Customer has no email address', 'error');
                return;
            }

            const invoiceNumber = currentInvoice.number || 'DRAFT';
            const total = formatNumber(Math.round(currentInvoice.total));
            const dueDate = currentInvoice.dueDate || 'TBD';

            const subject = `Invoice ${invoiceNumber} from ${settings.companyName}`;
            const body = `Dear ${customer.name},

Please find your invoice details below:

Invoice #: ${invoiceNumber}
Date: ${new Date().toISOString().split('T')[0]}
Due Date: ${dueDate}
Total Amount: R ${total}

Items:
${currentInvoice.items.map(item => `${item.name} (Qty: ${item.qty}) - R ${formatNumber(item.total)}`).join('\n')}

${settings.bankName ? `\nPayment Details:\nBank: ${settings.bankName}\nAccount Number: ${settings.accountNumber}\nBranch Code: ${settings.branchCode}\nAccount Holder: ${settings.accountHolder}` : ''}

If you have any questions, please don't hesitate to contact us.

Best regards,
${settings.companyName}
${settings.phone}
${settings.email}`;

            const mailtoUrl = `mailto:${customer.email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoUrl;

            // Update status to sent if it was draft
            if (currentInvoice.status === 'draft') {
                currentInvoice.status = 'sent';
                document.getElementById('invoiceStatus').value = 'sent';
            }

            showToast('Opening email client...', 'success');
        }

        // Reports Functions
        function openReportsModal() {
            openModal('reportsModal');
            generateReports();
        }

        function generateReports() {
            // Check for overdue invoices first
            checkOverdueInvoices();

            // Total invoices
            const totalInvoices = invoices.length;
            document.getElementById('reportTotalInvoices').textContent = totalInvoices;

            // Total revenue
            const totalRevenue = invoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            document.getElementById('reportTotalRevenue').textContent = 'R ' + formatNumber(Math.round(totalRevenue));

            // Outstanding balance
            const totalPaid = invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const outstanding = totalRevenue - totalPaid;
            document.getElementById('reportOutstanding').textContent = 'R ' + formatNumber(Math.round(outstanding));

            // Overdue invoices
            const overdueCount = invoices.filter(inv => inv.status === 'overdue').length;
            document.getElementById('reportOverdue').textContent = overdueCount;

            // Status breakdown
            const statusCounts = {
                draft: 0,
                sent: 0,
                partial: 0,
                paid: 0,
                overdue: 0,
                cancelled: 0
            };

            invoices.forEach(inv => {
                const status = inv.status || 'draft';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const statusBreakdownHTML = Object.entries(statusCounts).map(([status, count]) => {
                if (count === 0) return '';
                return `
                    <div style="text-align: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        ${getStatusBadge(status)}
                        <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.5rem;">${count}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('statusBreakdown').innerHTML = statusBreakdownHTML;

            // Top customers by revenue
            const customerRevenue = {};
            invoices.forEach(inv => {
                const customer = inv.customer || 'Unknown';
                customerRevenue[customer] = (customerRevenue[customer] || 0) + (inv.total || 0);
            });

            const topCustomers = Object.entries(customerRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const topCustomersHTML = topCustomers.map(([customer, revenue], index) => `
                <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 0.5rem;">
                    <span><strong>${index + 1}.</strong> ${customer}</span>
                    <span style="color: var(--success); font-weight: 700;">R ${formatNumber(Math.round(revenue))}</span>
                </div>
            `).join('');

            document.getElementById('topCustomers').innerHTML = topCustomersHTML || '<p style="text-align: center; opacity: 0.5;">No customer data yet</p>';

            // Monthly revenue (last 6 months)
            const monthlyData = {};
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = date.toISOString().substr(0, 7);
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                monthlyData[monthKey] = { name: monthName, revenue: 0 };
            }

            invoices.forEach(inv => {
                const monthKey = inv.date?.substr(0, 7);
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].revenue += inv.total || 0;
                }
            });

            const maxRevenue = Math.max(...Object.values(monthlyData).map(m => m.revenue), 1);

            const monthlyHTML = Object.values(monthlyData).map(month => {
                const percentage = (month.revenue / maxRevenue) * 100;
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>${month.name}</span>
                            <span style="color: var(--success); font-weight: 700;">R ${formatNumber(Math.round(month.revenue))}</span>
                        </div>
                        <div style="background: rgba(0,0,0,0.3); height: 30px; border-radius: 4px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--primary), var(--success)); height: 100%; width: ${percentage}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('monthlyRevenue').innerHTML = monthlyHTML;
        }

        function exportReportData() {
            const reportData = {
                generatedDate: new Date().toISOString(),
                summary: {
                    totalInvoices: invoices.length,
                    totalRevenue: invoices.reduce((sum, inv) => sum + (inv.total || 0), 0),
                    totalPaid: invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0),
                    outstanding: invoices.reduce((sum, inv) => sum + ((inv.total || 0) - (inv.amountPaid || 0)), 0),
                    overdueCount: invoices.filter(inv => inv.status === 'overdue').length
                },
                invoices: invoices.map(inv => ({
                    number: inv.number,
                    date: inv.date,
                    dueDate: inv.dueDate,
                    customer: inv.customer,
                    type: inv.type,
                    status: inv.status,
                    total: inv.total,
                    amountPaid: inv.amountPaid || 0,
                    balance: (inv.total || 0) - (inv.amountPaid || 0)
                }))
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `business-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Report exported successfully!', 'success');
        }

        function validateRequired(value, fieldName) {
            if (!value || value.trim() === '') {
                showToast(`${fieldName} is required`, 'error');
                return false;
            }
            return true;
        }

        // Safe LocalStorage Operations (Legacy - kept for backward compatibility)
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('Storage quota exceeded. Please export your data and clear old invoices.', 'error');
                } else {
                    showToast('Failed to save data: ' + e.message, 'error');
                }
                console.error('LocalStorage error:', e);
                return false;
            }
        }

        function safeGetItem(key, defaultValue = null) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Error reading from localStorage:', e);
                return defaultValue;
            }
        }

        // Google Drive Storage Operations (Async)
        async function saveToStorage(key, data) {
            try {
                // Check if driveStorage is available and initialized
                if (typeof driveStorage !== 'undefined' && driveStorage.isSignedIn) {
                    await driveStorage.setItem(key, data);
                    return true;
                } else {
                    // Fallback to localStorage
                    return safeSetItem(key, JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error saving to storage:', error);
                // Fallback to localStorage on error
                return safeSetItem(key, JSON.stringify(data));
            }
        }

        async function loadFromStorage(key, defaultValue = null) {
            try {
                // Check if driveStorage is available and initialized
                if (typeof driveStorage !== 'undefined' && driveStorage.isSignedIn) {
                    return await driveStorage.getItem(key, defaultValue);
                } else {
                    // Fallback to localStorage
                    return safeGetItem(key, defaultValue);
                }
            } catch (error) {
                console.error('Error loading from storage:', error);
                // Fallback to localStorage on error
                return safeGetItem(key, defaultValue);
            }
        }
        let settings = {
            logo: '',
            primaryColor: '#00d4ff',
            secondaryColor: '#ff006e',
            accentColor: '#7209b7',
            companyName: 'Aweh Be Lekker',
            tradingAs: 'Awake South Africa',
            email: 'sales@awake.co.za',
            phone: '+27 21 555 0123',
            website: 'www.awake.co.za',
            vat: '4123456789',
            address: '22 Porterfield Road\nTable View, Cape Town\n7439, South Africa',
            bankName: 'First National Bank',
            accountHolder: 'Aweh Be Lekker (Pty) Ltd',
            accountNumber: '62123456789',
            branchCode: '250655',
            showBanking: true
        };

        // Initialize Products - ALL 217 PRODUCTS WITH CORRECT NAMES AND COSTS
        function initializeProducts() {
            products = [
                // ========== AWAKE COMPLETE JETBOARDS ==========
                {sku: '99RE-21XR-GL', name: 'R√ÑVIK Explore XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 189927, description: 'Entry-level electric jetboard with XR4 battery'},
                {sku: '99R3-21XR-GL', name: 'R√ÑVIK Adventure XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 274922, description: 'Mid-range performance jetboard with XR4 battery'},
                {sku: '99RU-21XR-GL', name: 'R√ÑVIK Ultimate XR 4', brand: 'Awake', category: 'Jetboards', landedCost: 317393, description: 'High-performance jetboard with XR4 battery'},
                {sku: '99R3-BRABUS-08BP-GL', name: 'BRABUS x Awake Shadow', brand: 'Awake', category: 'Jetboards', landedCost: 356161, description: 'Limited edition BRABUS performance jetboard'},
                
                // ========== AWAKE EFOILS ==========
                {sku: '99VA-22LR-GL', name: 'VINGA Adventure LR 4 e-foil', brand: 'Awake', category: 'eFoils', landedCost: 253685, description: 'Entry-level eFoil with LR4 battery'},
                {sku: '99VA-21XR-GL', name: 'VINGA Adventure XR 4 e-foil', brand: 'Awake', category: 'eFoils', landedCost: 285539, description: 'Entry-level eFoil with XR4 battery'},
                {sku: '99VU-22LR-GL', name: 'VINGA Ultimate LR 4 e-foil', brand: 'Awake', category: 'eFoils', landedCost: 274922, description: 'Professional eFoil with LR4 battery'},
                {sku: '99VU-21XR-GL', name: 'VINGA Ultimate XR 4 e-foil', brand: 'Awake', category: 'eFoils', landedCost: 306775, description: 'Professional eFoil with XR4 battery'},
                
                // ========== AWAKE BATTERIES ==========
                {sku: '99CL-22LR', name: 'Awake Flex Battery LR 4', brand: 'Awake', category: 'Batteries', landedCost: 62047, description: 'Standard range battery'},
                {sku: '99CL-21XR', name: 'Awake Flex Battery XR 4', brand: 'Awake', category: 'Batteries', landedCost: 96025, description: 'Extended range battery'},
                
                // ========== AWAKE BOARDS (EX BATTERY) ==========
                {sku: '99RE-GL', name: 'R√ÑVIK Explore (ex BP ex Acc)', brand: 'Awake', category: 'Boards', landedCost: 104689, description: 'Explore board only, no battery or accessories'},
                {sku: '99RA-GL', name: 'R√ÑVIK Adventure (ex BP ex Acc)', brand: 'Awake', category: 'Boards', landedCost: 168398, description: 'Adventure board only, no battery or accessories'},
                {sku: '99RU-GL', name: 'R√ÑVIK Ultimate (ex BP ex Acc)', brand: 'Awake', category: 'Boards', landedCost: 189633, description: 'Ultimate board only, no battery or accessories'},
                {sku: '99VA-GL', name: 'VINGA Adventure (ex BP ex Acc)', brand: 'Awake', category: 'Boards', landedCost: 189633, description: 'VINGA Adventure board only'},
                {sku: '99VU-GL', name: 'VINGA Ultimate (ex BP ex Acc)', brand: 'Awake', category: 'Boards', landedCost: 200252, description: 'VINGA Ultimate board only'},
                {sku: '99VA-22LR-GL-SHELL', name: 'VINGA Adventure (Shell only)', brand: 'Awake', category: 'Boards', landedCost: 72709, description: 'VINGA Adventure shell only'},
                {sku: '99VU-21XR-GL-SHELL', name: 'VINGA Ultimate (Shell only)', brand: 'Awake', category: 'Boards', landedCost: 83327, description: 'VINGA Ultimate shell only'},
                
                // ========== AWAKE BAGS & CONTROLLERS ==========
                {sku: '99CL-09AY-31', name: 'R√ÑVIK Board Bag Kit', brand: 'Awake', category: 'Bags', landedCost: 15491, description: 'Protective travel bag for R√ÑVIK boards'},
                {sku: '99CL-09AY-05', name: 'VINGA S Board Bag Kit', brand: 'Awake', category: 'Bags', landedCost: 15491, description: 'Protective travel bag for VINGA S'},
                {sku: '99CL-09AY-06', name: 'VINGA 3 Board Bag Kit', brand: 'Awake', category: 'Bags', landedCost: 15491, description: 'Protective travel bag for VINGA 3'},
                {sku: '99CL-24HC', name: 'Flex Hand Controller 4', brand: 'Awake', category: 'Controllers', landedCost: 12909, description: 'Wireless hand controller'},
                
                // ========== VINGA WING KITS ==========
                {sku: '99L-19FD-WG-05', name: 'CRUISE 1600 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 21404, description: 'Complete CRUISE 1600 wing kit'},
                {sku: '99CL-19FD-WG-02', name: 'POWDER 1800 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 21404, description: 'Complete POWDER 1800 wing kit'},
                {sku: '99CL-19FD-WG-01', name: 'POWDER 1400 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 21404, description: 'Complete POWDER 1400 wing kit'},
                {sku: '99CL-19FD-WG-04', name: 'FLUID 1300 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 21404, description: 'Complete FLUID 1300 wing kit'},
                {sku: '99CL-19FD-WG-03', name: 'FLUID 1000 Wing Kit', brand: 'Awake', category: 'Wings', landedCost: 21404, description: 'Complete FLUID 1000 wing kit'},
                
                // ========== VINGA WING COMPONENTS ==========
                {sku: '19FD-36', name: 'CRUISE 1600 Front Wing', brand: 'Awake', category: 'Wings', landedCost: 19428, description: 'CRUISE 1600 front wing only'},
                {sku: '19FD-37', name: 'CRUISE Rear Wing', brand: 'Awake', category: 'Wings', landedCost: 6618, description: 'CRUISE rear wing only'},
                {sku: '19FD-31', name: 'POWDER 1800 Front Wing', brand: 'Awake', category: 'Wings', landedCost: 19428, description: 'POWDER 1800 front wing only'},
                {sku: '19FD-30', name: 'POWDER 1400 Front Wing', brand: 'Awake', category: 'Wings', landedCost: 19428, description: 'POWDER 1400 front wing only'},
                {sku: '19FD-32', name: 'POWDER Rear Wing', brand: 'Awake', category: 'Wings', landedCost: 6618, description: 'POWDER rear wing only'},
                {sku: '19FD-34', name: 'FLUID 1300 Front Wing', brand: 'Awake', category: 'Wings', landedCost: 19428, description: 'FLUID 1300 front wing only'},
                {sku: '19FD-33', name: 'FLUID 1000 Front Wing', brand: 'Awake', category: 'Wings', landedCost: 19428, description: 'FLUID 1000 front wing only'},
                {sku: '19FD-35', name: 'FLUID Rear Wing', brand: 'Awake', category: 'Wings', landedCost: 6618, description: 'FLUID rear wing only'},
                
                // ========== FINS & PERFORMANCE PARTS ==========
                {sku: '99CL-09AY-03', name: 'R√ÑVIK Fins', brand: 'Awake', category: 'Performance', landedCost: 4437, description: 'Standard fins for R√ÑVIK boards'},
                {sku: '99CL-09AY-04', name: 'R√ÑVIK Carbon Fins', brand: 'Awake', category: 'Performance', landedCost: 6348, description: 'Carbon fiber performance fins'},
                {sku: '99CL-09AY-02', name: 'Foot Straps', brand: 'Awake', category: 'Performance', landedCost: 7873, description: 'Adjustable foot straps'},
                
                // ========== MAJOR ACCESSORIES ==========
                {sku: '99CL-09AY-49', name: 'Awake Dock', brand: 'Awake', category: 'Accessories', landedCost: 61781, description: 'Floating dock system'},
                {sku: '99CL-09AY-48', name: 'Dock Pump', brand: 'Awake', category: 'Accessories', landedCost: 2732, description: 'Electric pump for dock'},
                {sku: '99CL-09AY-57', name: 'Jetboard Tube', brand: 'Awake', category: 'Safety', landedCost: 15415, description: 'Inflatable safety tube'},
                {sku: '99CL-09AY-11', name: 'Power Key Leash', brand: 'Awake', category: 'Safety', landedCost: 5070, description: 'Retractable power key leash'},
                {sku: '99CL-09AY-01', name: 'Competition Power Key', brand: 'Awake', category: 'Safety', landedCost: 5070, description: 'Competition grade power key'},
                {sku: '99CL-07CH-GL', name: 'Flex Battery Charger', brand: 'Awake', category: 'Chargers', landedCost: 19491, description: 'Fast charger for Flex batteries'},
                {sku: '99CL-06IN-GL', name: 'Flex Hand Controller Charger', brand: 'Awake', category: 'Chargers', landedCost: 4437, description: 'Charger for hand controller'},
                
                // ========== DISPLAY & STORAGE ==========
                {sku: '99CL-17WM-ALL', name: 'R√ÑVIK Wall Mount', brand: 'Awake', category: 'Storage', landedCost: 23390, description: 'Wall mounting bracket'},
                {sku: '09AY-54', name: 'R√ÑVIK Board Stand (Vertical)', brand: 'Awake', category: 'Storage', landedCost: 12866, description: 'Vertical display stand'},
                {sku: '09AY-52', name: 'Jetboard Stand (Horizontal)', brand: 'Awake', category: 'Storage', landedCost: 12866, description: 'Horizontal display stand'},
                {sku: '09AY-56', name: 'eFoil Board Stand', brand: 'Awake', category: 'Storage', landedCost: 12866, description: 'Display stand for eFoils'},
                {sku: '00SU-09AY-01', name: 'Soft Handle', brand: 'Awake', category: 'Accessories', landedCost: 3279, description: 'Soft carry handle'},
                
                // ========== SAFETY & APPAREL ==========
                {sku: '99CL-LF-02', name: 'Awake Life Vest', brand: 'Awake', category: 'Safety', landedCost: 7625, description: 'CE certified life vest'},
                {sku: '99CL-TS-01', name: 'Awake x Sail Racing T-shirt', brand: 'Awake', category: 'Apparel', landedCost: 2646, description: 'Official branded t-shirt'},
                {sku: '99CL-CP-02', name: 'Awake Cap', brand: 'Awake', category: 'Apparel', landedCost: 1411, description: 'Branded cap'},
                
                // ========== MARKETING MATERIALS ==========
                {sku: '99CL-RL-03', name: 'Awake Roll Up 2024 R√ÑVIK', brand: 'Awake', category: 'Marketing', landedCost: 6348, description: 'Marketing roll-up banner'},
                {sku: '99CL-RL-04', name: 'Awake Roll Up 2024 VINGA', brand: 'Awake', category: 'Marketing', landedCost: 6348, description: 'Marketing roll-up banner'},
                {sku: '99CL-BF-01', name: 'Awake Beach Flag', brand: 'Awake', category: 'Marketing', landedCost: 7618, description: 'Large beach flag banner'},
                
                // ========== AQUA MARINA ISUPS (31 products) ==========
                {sku: 'AM-RACE-14', name: 'Race 14\'0" Racing SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 8500, description: 'Professional racing board'},
                {sku: 'AM-BEAST-18', name: 'Beast 18\'0" XXL SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 10500, description: 'Extra large capacity board'},
                {sku: 'AM-VAPOR-10', name: 'Vapor 10\'10" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Versatile all-round board'},
                {sku: 'AM-MAGMA-11', name: 'Magma 11\'2" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5200, description: 'Long distance touring'},
                {sku: 'AM-FUSION-10', name: 'Fusion 10\'10" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Family friendly board'},
                {sku: 'AM-HYPER-11', name: 'Hyper 11\'6" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5800, description: 'High performance touring'},
                {sku: 'AM-DRIFT-10', name: 'Drift 10\'10" Fishing', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6200, description: 'Fishing specific features'},
                {sku: 'AM-MONSTER-12', name: 'Monster 12\'0" Multi-Person', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 7500, description: 'Multi-person capacity'},
                {sku: 'AM-BREEZE-9', name: 'Breeze 9\'9" Compact', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3800, description: 'Compact travel board'},
                {sku: 'AM-BLADE-10', name: 'Blade 10\'6" Wind SUP', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6500, description: 'Windsurf capable'},
                {sku: 'AM-ECHO-10', name: 'Echo 10\'6" Kids', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3500, description: 'Youth specific board'},
                {sku: 'AM-PEACE-10', name: 'Peace 10\'0" Yoga', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Yoga and fitness'},
                {sku: 'AM-LIQUID-10', name: 'Liquid 10\'4" Surf', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Wave riding performance'},
                {sku: 'AM-CHAMPION-14', name: 'Champion 14\'0" Racing', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 9500, description: 'Competition ready'},
                {sku: 'AM-ATLAS-12', name: 'Atlas 12\'0" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5800, description: 'Premium all-round'},
                {sku: 'AM-RAPID-12', name: 'Rapid 12\'6" Touring', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6200, description: 'Fast touring board'},
                {sku: 'AM-AQUA-GLIDE-11', name: 'Aqua Glide 11\'2" Family', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4800, description: 'Family board'},
                {sku: 'AM-VIBRANT-8', name: 'Vibrant 8\'0" Youth', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2800, description: 'Kids starter board'},
                {sku: 'AM-SUPER-TRIP-12', name: 'Super Trip 12\'2" Family', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 6800, description: 'Extra wide family board'},
                {sku: 'AM-ALL-AROUND-EIGHT-10', name: 'All Around Eight 10\'', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3200, description: 'Budget all-round'},
                {sku: 'AM-DHYANA-11', name: 'Dhyana 11\'0" Yoga', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Premium yoga board'},
                {sku: 'AM-TOMAHAWK-AIR-9', name: 'Tomahawk AIR 9\'9" Surf', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Surf style board'},
                {sku: 'AM-LEISURE-9', name: 'Leisure 9\'9" Beginner', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2800, description: 'Entry level board'},
                {sku: 'AM-SLIDE-10', name: 'Slide 10\'2" All-Round', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3500, description: 'Mid-range all-round'},
                {sku: 'AM-CASCADE-10', name: 'Cascade 10\'0" River', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4500, description: 'Whitewater capable'},
                {sku: 'AM-MEGA-19', name: 'Mega 19\'0" Party', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 15000, description: 'Giant party platform'},
                {sku: 'AM-EVOLUTION-10', name: 'Evolution 10\'10"', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 4200, description: 'Progressive design'},
                {sku: 'AM-CORAL-10', name: 'Coral 10\'2" Youth', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3200, description: 'Teen board'},
                {sku: 'AM-STREAM-9', name: 'Stream 9\'9" Compact', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 3000, description: 'Small storage board'},
                {sku: 'AM-LIBERTY-9', name: 'Liberty 9\'9" Kids', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 2500, description: 'Basic kids board'},
                {sku: 'AM-TRITON-11', name: 'Triton 11\'2" Advanced', brand: 'Aqua Marina', category: 'ISUPs', landedCost: 5500, description: 'Advanced rider board'},
                
                // ========== AQUA MARINA KAYAKS (17 products) ==========
                {sku: 'AM-K1-TANDEM', name: 'K1 Tandem Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6500, description: '2-person inflatable kayak'},
                {sku: 'AM-K2-SOLO', name: 'K2 Solo Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 4200, description: '1-person kayak'},
                {sku: 'AM-LAXO-285', name: 'Laxo-285 Family Kayak', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 5800, description: '2-3 person kayak'},
                {sku: 'AM-LAXO-320', name: 'Laxo-320 Touring', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6800, description: 'Long distance touring'},
                {sku: 'AM-STEAM-312', name: 'Steam-312 Fishing', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 7200, description: 'Fishing kayak'},
                {sku: 'AM-MEMBA-330', name: 'Memba-330 Tandem', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 6200, description: 'Tandem touring kayak'},
                {sku: 'AM-BETTA-312', name: 'Betta-312 Advanced', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 5500, description: 'Performance kayak'},
                {sku: 'AM-TOMAHAWK-375', name: 'Tomahawk-375 Whitewater', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 7800, description: 'Whitewater kayak'},
                {sku: 'AM-VISTA-380', name: 'Vista-380 3-Person', brand: 'Aqua Marina', category: 'Kayaks', landedCost: 8500, description: 'Family 3-person'},
                {sku: 'AM-KAYAK-SEAT', name: 'Kayak Seat Deluxe', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 850, description: 'Padded kayak seat'},
                {sku: 'AM-PADDLE-230', name: 'Kayak Paddle 230cm', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 650, description: 'Adjustable paddle'},
                {sku: 'AM-KAYAK-PUMP', name: 'Kayak High Pressure Pump', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 950, description: 'HP electric pump'},
                {sku: 'AM-KAYAK-BAG', name: 'Kayak Transport Bag', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1200, description: 'Wheeled bag'},
                {sku: 'AM-OUTRIGGER', name: 'Kayak Outrigger Kit', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1800, description: 'Stability outriggers'},
                {sku: 'AM-FISHING-ROD-HOLDER', name: 'Fishing Rod Holder', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 450, description: 'Rod mount'},
                {sku: 'AM-KAYAK-CART', name: 'Kayak Transport Cart', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 1500, description: 'Wheeled cart'},
                {sku: 'AM-ANCHOR-KIT', name: 'Kayak Anchor Kit', brand: 'Aqua Marina', category: 'Kayak Accessories', landedCost: 850, description: 'Anchor and line'},
                
                // ========== AQUA MARINA BOATS (8 products) ==========
                {sku: 'AM-DELUXE-230', name: 'Deluxe 230 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 3500, description: '2-person raft'},
                {sku: 'AM-DELUXE-277', name: 'Deluxe 277 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 4800, description: '3-person raft'},
                {sku: 'AM-DELUXE-300', name: 'Deluxe 300 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 5500, description: '4-person raft'},
                {sku: 'AM-DELUXE-330', name: 'Deluxe 330 Raft', brand: 'Aqua Marina', category: 'Boats', landedCost: 6500, description: '5-person raft'},
                {sku: 'AM-RACING-BOAT-300', name: 'Racing Boat 300', brand: 'Aqua Marina', category: 'Boats', landedCost: 7200, description: 'Sport racing boat'},
                {sku: 'AM-FISHING-BOAT-249', name: 'Fishing Boat 249', brand: 'Aqua Marina', category: 'Boats', landedCost: 5800, description: 'Fishing platform'},
                {sku: 'AM-DIVE-BOAT', name: 'Dive Support Boat', brand: 'Aqua Marina', category: 'Boats', landedCost: 6800, description: 'Diving support craft'},
                {sku: 'AM-RIB-FLOOR', name: 'RIB Floor Kit', brand: 'Aqua Marina', category: 'Boat Accessories', landedCost: 2200, description: 'Rigid floor insert'},
                
                // ========== MOTORS & BATTERIES (7 products) ==========
                {sku: 'AM-MOTOR-S1', name: 'S1 Electric Motor', brand: 'Aqua Marina', category: 'Motors', landedCost: 8500, description: 'Entry electric motor'},
                {sku: 'AM-MOTOR-S2', name: 'S2 Electric Motor Pro', brand: 'Aqua Marina', category: 'Motors', landedCost: 12000, description: 'Pro electric motor'},
                {sku: 'AM-BATTERY-40AH', name: '40Ah Battery Pack', brand: 'Aqua Marina', category: 'Batteries', landedCost: 4500, description: 'Rechargeable battery'},
                {sku: 'AM-BATTERY-60AH', name: '60Ah Battery Pack', brand: 'Aqua Marina', category: 'Batteries', landedCost: 6500, description: 'Extended battery'},
                {sku: 'AM-CHARGER-SMART', name: 'Smart Battery Charger', brand: 'Aqua Marina', category: 'Accessories', landedCost: 1200, description: 'Fast charger'},
                {sku: 'AM-MOTOR-MOUNT', name: 'Universal Motor Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 850, description: 'Motor bracket'},
                {sku: 'AM-PROPELLER-SPARE', name: 'Spare Propeller', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Replacement prop'},
                
                // ========== PADDLES (15 products) ==========
                {sku: 'AM-PADDLE-CARBON-ADJ', name: 'Carbon Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1800, description: 'Premium carbon'},
                {sku: 'AM-PADDLE-ALLOY-ADJ', name: 'Aluminum Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 950, description: 'Standard alloy'},
                {sku: 'AM-PADDLE-FIBREGLASS', name: 'Fiberglass Fixed Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1200, description: 'Fixed length'},
                {sku: 'AM-PADDLE-KIDS', name: 'Kids Adjustable Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 650, description: 'Youth size'},
                {sku: 'AM-PADDLE-3PC', name: '3-Piece Travel Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1100, description: 'Portable paddle'},
                {sku: 'AM-PADDLE-TOURING', name: 'Touring Carbon Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 2200, description: 'Long distance'},
                {sku: 'AM-PADDLE-RACING', name: 'Racing Carbon Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 2800, description: 'Competition'},
                {sku: 'AM-PADDLE-SURF', name: 'Surf Paddle Short', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1400, description: 'Wave riding'},
                {sku: 'AM-PADDLE-ALLROUND', name: 'All-Round Basic Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 750, description: 'Entry level'},
                {sku: 'AM-PADDLE-MULTI-ADJUST', name: 'Multi-Position Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 1300, description: 'Variable angles'},
                {sku: 'AM-PADDLE-FLOATING', name: 'Floating Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 850, description: 'High visibility'},
                {sku: 'AM-PADDLE-TELESCOPIC', name: 'Telescopic Compact Paddle', brand: 'Aqua Marina', category: 'Paddles', landedCost: 950, description: 'Ultra compact'},
                {sku: 'AM-PADDLE-BLADE-SPARE', name: 'Spare Paddle Blade', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Replacement blade'},
                {sku: 'AM-PADDLE-GRIP', name: 'Paddle Grip Upgrade', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Comfort grip'},
                {sku: 'AM-PADDLE-BAG', name: 'Paddle Travel Bag', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Protective bag'},
                
                // ========== PUMPS (5 products) ==========
                {sku: 'AM-PUMP-ELECTRIC-20PSI', name: 'Electric Pump 20 PSI', brand: 'Aqua Marina', category: 'Pumps', landedCost: 1800, description: 'High pressure electric'},
                {sku: 'AM-PUMP-DUAL-ACTION', name: 'Dual Action Hand Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 650, description: 'Manual pump'},
                {sku: 'AM-PUMP-TURBO', name: 'Turbo Electric Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 2500, description: 'Fast inflation'},
                {sku: 'AM-PUMP-12V', name: '12V Car Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 950, description: 'Vehicle powered'},
                {sku: 'AM-PUMP-RECHARGEABLE', name: 'Rechargeable Electric Pump', brand: 'Aqua Marina', category: 'Pumps', landedCost: 2200, description: 'Cordless pump'},
                
                // ========== ACCESSORIES (40+ products) ==========
                {sku: 'AM-LEASH-COIL', name: 'Coiled SUP Leash', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Safety leash'},
                {sku: 'AM-LEASH-STRAIGHT', name: 'Straight SUP Leash', brand: 'Aqua Marina', category: 'Accessories', landedCost: 320, description: 'Standard leash'},
                {sku: 'AM-FIN-TOURING', name: 'Touring Center Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Large touring fin'},
                {sku: 'AM-FIN-ALLROUND', name: 'All-Round Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Standard fin'},
                {sku: 'AM-FIN-RACE', name: 'Racing Fin', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Performance fin'},
                {sku: 'AM-FIN-SET-3PC', name: '3-Piece Fin Set', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Thruster setup'},
                {sku: 'AM-REPAIR-KIT', name: 'Repair Kit Pro', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Comprehensive repair'},
                {sku: 'AM-BACKPACK', name: 'SUP Backpack Deluxe', brand: 'Aqua Marina', category: 'Bags', landedCost: 1200, description: 'Wheeled backpack'},
                {sku: 'AM-DRYBAG-10L', name: 'Dry Bag 10L', brand: 'Aqua Marina', category: 'Bags', landedCost: 350, description: 'Waterproof bag'},
                {sku: 'AM-DRYBAG-20L', name: 'Dry Bag 20L', brand: 'Aqua Marina', category: 'Bags', landedCost: 450, description: 'Large dry bag'},
                {sku: 'AM-PHONE-CASE', name: 'Waterproof Phone Case', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Phone protection'},
                {sku: 'AM-GOPRO-MOUNT', name: 'GoPro Camera Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Camera bracket'},
                {sku: 'AM-DECK-PAD', name: 'EVA Deck Pad', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Traction pad'},
                {sku: 'AM-ROOF-RACK-PADS', name: 'Roof Rack Pads', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Car transport pads'},
                {sku: 'AM-TIE-DOWN-STRAPS', name: 'Tie-Down Straps', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Secure straps'},
                {sku: 'AM-WATERPROOF-SPEAKER', name: 'Bluetooth Waterproof Speaker', brand: 'Aqua Marina', category: 'Accessories', landedCost: 850, description: 'Music system'},
                {sku: 'AM-COOLER-BAG', name: 'Floating Cooler Bag', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Insulated bag'},
                {sku: 'AM-SEAT-CONVERSION', name: 'Kayak Seat Conversion Kit', brand: 'Aqua Marina', category: 'Accessories', landedCost: 950, description: 'SUP to kayak'},
                {sku: 'AM-FISHING-MOUNT', name: 'Fishing Rod Mount', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Rod holder'},
                {sku: 'AM-CARGO-NET', name: 'Deck Cargo Net', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'Storage net'},
                {sku: 'AM-BUNGEE-CORD', name: 'Bungee Cord Set', brand: 'Aqua Marina', category: 'Accessories', landedCost: 250, description: 'Elastic cords'},
                {sku: 'AM-VALVE-ADAPTER', name: 'Valve Adapter Kit', brand: 'Aqua Marina', category: 'Accessories', landedCost: 180, description: 'Universal adapters'},
                {sku: 'AM-PRESSURE-GAUGE', name: 'Digital Pressure Gauge', brand: 'Aqua Marina', category: 'Accessories', landedCost: 350, description: 'PSI meter'},
                {sku: 'AM-ANCHOR-FOLDING', name: 'Folding Anchor', brand: 'Aqua Marina', category: 'Accessories', landedCost: 650, description: 'Compact anchor'},
                {sku: 'AM-WATERPROOF-LIGHTS', name: 'LED Waterproof Lights', brand: 'Aqua Marina', category: 'Accessories', landedCost: 550, description: 'Safety lights'},
                {sku: 'AM-COMPASS', name: 'Marine Compass', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Navigation compass'},
                {sku: 'AM-WHISTLE', name: 'Safety Whistle', brand: 'Aqua Marina', category: 'Safety', landedCost: 120, description: 'Emergency whistle'},
                {sku: 'AM-PFD-ADULT', name: 'Adult Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 850, description: 'Buoyancy vest'},
                {sku: 'AM-PFD-YOUTH', name: 'Youth Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 650, description: 'Kids life vest'},
                {sku: 'AM-PFD-CHILD', name: 'Child Life Jacket', brand: 'Aqua Marina', category: 'Safety', landedCost: 550, description: 'Toddler vest'},
                {sku: 'AM-HELMET', name: 'Water Sports Helmet', brand: 'Aqua Marina', category: 'Safety', landedCost: 750, description: 'Protection helmet'},
                {sku: 'AM-GLOVES', name: 'Paddling Gloves', brand: 'Aqua Marina', category: 'Apparel', landedCost: 350, description: 'Grip gloves'},
                {sku: 'AM-WETSUIT-SHORTY', name: 'Shorty Wetsuit', brand: 'Aqua Marina', category: 'Apparel', landedCost: 1200, description: 'Short wetsuit'},
                {sku: 'AM-WETSUIT-FULLSUIT', name: 'Full Wetsuit', brand: 'Aqua Marina', category: 'Apparel', landedCost: 1800, description: 'Full body wetsuit'},
                {sku: 'AM-RASH-GUARD', name: 'Rash Guard Shirt', brand: 'Aqua Marina', category: 'Apparel', landedCost: 550, description: 'Sun protection'},
                {sku: 'AM-BOARDSHORTS', name: 'Quick-Dry Boardshorts', brand: 'Aqua Marina', category: 'Apparel', landedCost: 450, description: 'Swim shorts'},
                {sku: 'AM-SUNGLASSES', name: 'Polarized Sunglasses', brand: 'Aqua Marina', category: 'Apparel', landedCost: 650, description: 'Water sunglasses'},
                {sku: 'AM-HAT', name: 'Quick-Dry Cap', brand: 'Aqua Marina', category: 'Apparel', landedCost: 280, description: 'Sun hat'},
                {sku: 'AM-TOWEL', name: 'Microfiber Towel', brand: 'Aqua Marina', category: 'Apparel', landedCost: 350, description: 'Quick-dry towel'},
                {sku: 'AM-CHANGING-MAT', name: 'Changing Mat', brand: 'Aqua Marina', category: 'Accessories', landedCost: 450, description: 'Wetsuit changing mat'}
            ];
            
            console.log(`‚úÖ Loaded ${products.length} products`);
            displayProducts();
            updateProductCount();
        }

        // Initialize Customers - SAMPLE CUSTOMERS
        function initializeCustomers() {
            customers = [
                {
                    id: 1,
                    name: 'Wave Dominator',
                    company: 'Cape Town Surf School',
                    email: 'info@ctsurf.co.za',
                    phone: '+27 82 123 4567',
                    address: 'Camps Bay Beach\nCape Town, 8005',
                    vat: '4987654321',
                    tier: 'rental'
                },
                {
                    id: 2,
                    name: 'John Smith',
                    company: '',
                    email: 'john.smith@email.com',
                    phone: '+27 83 234 5678',
                    address: 'Clifton, Cape Town',
                    vat: '',
                    tier: 'retail'
                },
                {
                    id: 3,
                    name: 'Sarah Johnson',
                    company: 'Luxury Marine Sports',
                    email: 'sarah@luxmarine.co.za',
                    phone: '+27 84 345 6789',
                    address: 'V&A Waterfront\nCape Town, 8001',
                    vat: '4112233445',
                    tier: 'gold'
                },
                {
                    id: 4,
                    name: 'Allan Stuart',
                    company: '',
                    email: 'allan.stuart@gmail.com',
                    phone: '+27 76 456 7890',
                    address: 'Blouberg, Cape Town',
                    vat: '',
                    tier: 'retail'
                }
            ];
            
            loadCustomers();
        }

        // Tab Switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav tabs and update ARIA
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Make nav tab active and update ARIA
            event.target.classList.add('active');
            event.target.setAttribute('aria-selected', 'true');
        }

        // Display Products
        function displayProducts(filter = 'all') {
            const grid = document.getElementById('productGrid');
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            
            let filteredProducts = products;
            
            // Apply brand filter
            if (filter !== 'all') {
                filteredProducts = products.filter(p => 
                    filter === 'awake' ? p.brand === 'Awake' : p.brand === 'Aqua Marina'
                );
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.sku.toLowerCase().includes(searchTerm) ||
                    p.category.toLowerCase().includes(searchTerm)
                );
            }
            
            grid.innerHTML = filteredProducts.map(product => `
                <div class="product-card" onclick="addProductToInvoice('${product.sku}')">
                    <div class="product-brand">${product.brand}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-sku">SKU: ${product.sku}</div>
                    <div class="product-price">R ${formatNumber(product.landedCost)}</div>
                    <button class="btn btn-primary btn-sm" style="width: 100%;">Add to Invoice</button>
                </div>
            `).join('');
            
            updateProductCount(filteredProducts.length);
        }

        // Update Product Count
        function updateProductCount(visible = null) {
            document.getElementById('totalProducts').textContent = products.length;
            if (visible !== null) {
                document.getElementById('visibleProducts').textContent = visible;
            } else {
                document.getElementById('visibleProducts').textContent = products.length;
            }
        }

        // Filter Tags
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    displayProducts(e.target.dataset.filter);
                });
            });
            
            // Product Search
            document.getElementById('productSearch').addEventListener('input', () => {
                const activeFilter = document.querySelector('.filter-tag.active').dataset.filter;
                displayProducts(activeFilter);
            });
        });

        // Format Number with spaces
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            console.log('closeModal called with:', modalId);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }

            // Remove active class AND force display none
            modal.classList.remove('active');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';

            // Reset supplier modal form when closing
            if (modalId === 'supplierModal') {
                console.log('Resetting supplier form');
                resetSupplierForm();
            }
            console.log('Modal closed successfully');
        }

        function resetSupplierForm() {
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierWebsite').value = '';
            document.getElementById('supplierCategory').value = 'jetboards';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
            document.getElementById('supplierLogoUpload').value = '';
            document.getElementById('supplierLogoPreview').src = '';
            document.getElementById('supplierLogoPreview').style.display = 'none';
        }

        // ========================================
        // GOOGLE DRIVE SETUP WIZARD FUNCTIONS
        // ========================================

        let currentWizardStep = 1;
        const totalWizardSteps = 5;

        function openSetupWizard() {
            currentWizardStep = 1;
            updateWizardStep();
            openModal('setupWizardModal');
        }

        function openQuickGoogleSetup() {
            const originInput = document.getElementById('quickOriginCopy');
            if (originInput) originInput.value = location.origin;

            const input = document.getElementById('quickClientIdInput');
            if (input) {
                input.value = localStorage.getItem('google_drive_client_id') || '';
                validateQuickClientId(input.value);
            }

            const resultDiv = document.getElementById('quickConnectionResult');
            if (resultDiv) {
                resultDiv.classList.add('is-hidden');
                resultDiv.style.display = 'none';
                resultDiv.innerHTML = '';
            }

            openModal('quickGoogleSetupModal');
        }

        async function syncGoogle() {
            try {
                if (typeof driveStorage === 'undefined') {
                    if (typeof showToast === 'function') {
                        showToast('Google sync is not available right now', 'error');
                    }
                    return;
                }

                // If not configured yet, show the minimal setup first (Client ID once)
                if (!driveStorage.isClientConfigured || !driveStorage.isClientConfigured()) {
                    openQuickGoogleSetup();
                    return;
                }

                // Ensure the Drive SDK is initialized
                if (typeof driveStorage.init === 'function') {
                    try {
                        await driveStorage.init();
                    } catch (e) {
                        console.warn('Drive init failed (will retry during sign-in):', e);
                    }
                }

                // One button flow:
                // - if not signed in: pop up login/consent and auto-sync
                // - if signed in: just sync
                if (!driveStorage.isSignedIn) {
                    await driveStorage.signIn();
                    return;
                }

                if (typeof driveStorage.ensureFolder === 'function') {
                    await driveStorage.ensureFolder();
                }
                await driveStorage.syncAll();
            } catch (error) {
                console.error('syncGoogle error:', error);
                if (typeof driveStorage !== 'undefined' && typeof driveStorage.updateSyncStatus === 'function') {
                    driveStorage.updateSyncStatus(`‚ùå Google sync failed: ${error?.message || error}`, 'error');
                } else if (typeof showToast === 'function') {
                    showToast(`Google sync failed: ${error?.message || error}`, 'error');
                }
            }
        }

        function validateQuickClientId(clientId) {
            const validation = document.getElementById('quickClientIdValidation');
            const connectBtn = document.getElementById('quickConnectBtn');

            const isValid = clientId.trim().length > 0 &&
                           clientId.includes('-') &&
                           clientId.endsWith('.apps.googleusercontent.com');

            if (isValid) {
                validation?.classList.remove('invalid');
                validation?.classList.add('valid');
                if (connectBtn) connectBtn.disabled = false;
            } else {
                validation?.classList.remove('valid');
                validation?.classList.add('invalid');
                if (connectBtn) connectBtn.disabled = true;
            }
        }

        async function quickConnectGoogleDrive() {
            const clientId = document.getElementById('quickClientIdInput')?.value?.trim() || '';
            const resultDiv = document.getElementById('quickConnectionResult');
            const connectBtn = document.getElementById('quickConnectBtn');

            if (!clientId) {
                showToast('Please enter your Client ID first', 'error');
                return;
            }

            if (connectBtn) {
                connectBtn.disabled = true;
                connectBtn.textContent = 'üîÑ Connecting...';
            }
            if (resultDiv) {
                resultDiv.classList.remove('is-hidden');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<div class="wizard-alert">‚è≥ Opening Google sign-in...</div>';
            }

            try {
                if (typeof driveStorage === 'undefined') {
                    throw new Error('Google Drive module not loaded');
                }

                driveStorage.CLIENT_ID = clientId;

                // Force a clean init if the module initialized with a placeholder
                if (driveStorage._initPromise) {
                    driveStorage._initPromise = null;
                }
                if ('tokenClient' in driveStorage) {
                    driveStorage.tokenClient = null;
                }

                localStorage.setItem('google_drive_client_id', clientId);

                await driveStorage.init();
                await driveStorage.signIn();

                if (resultDiv) {
                    resultDiv.innerHTML = `
                        <div class="wizard-success">
                            <h3>‚úÖ Connected!</h3>
                            <p style="margin-top: 0.5rem;">Google Drive is ready. Click ‚ÄúSync Google‚Äù any time.</p>
                        </div>
                    `;
                }

                const syncGoogleBtn = document.getElementById('syncGoogleBtn');
                if (syncGoogleBtn) syncGoogleBtn.style.animation = '';

                showToast('‚úÖ Google Drive connected', 'success');
                closeModal('quickGoogleSetupModal');
            } catch (error) {
                console.error('quickConnectGoogleDrive failed:', error);
                if (resultDiv) {
                    resultDiv.classList.remove('is-hidden');
                    resultDiv.style.display = 'block';
                    resultDiv.innerHTML = `
                        <div class="wizard-alert">
                            <strong>‚ö†Ô∏è Connection Failed</strong><br>
                            <p style="margin-top: 0.5rem;">${error?.message || error}</p>
                            <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                                <strong>Fix:</strong><br>
                                ‚Ä¢ In Google Cloud ‚Üí OAuth Client ‚Üí add this origin: <strong>${location.origin}</strong><br>
                                ‚Ä¢ Then try again
                            </p>
                        </div>
                    `;
                }
                showToast('Connection failed. Check the message.', 'error');
            } finally {
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.textContent = 'üîó Connect Google';
                }
            }
        }

        function wizardNextStep() {
            if (currentWizardStep < totalWizardSteps) {
                currentWizardStep++;
                updateWizardStep();
            }
        }

        function wizardPrevStep() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                updateWizardStep();
            }
        }

        function updateWizardStep() {
            // Update progress indicators
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');

                if (stepNum === currentWizardStep) {
                    step.classList.add('active');
                } else if (stepNum < currentWizardStep) {
                    step.classList.add('completed');
                }
            });

            // Update content visibility
            document.querySelectorAll('.wizard-step-content').forEach((content, index) => {
                const stepNum = index + 1;
                content.classList.remove('active');

                if (stepNum === currentWizardStep) {
                    content.classList.add('active');
                }
            });

            // Update button visibility
            const prevBtn = document.getElementById('wizardPrevBtn');
            const nextBtn = document.getElementById('wizardNextBtn');
            const finishBtn = document.getElementById('wizardFinishBtn');

            if (currentWizardStep === 1) {
                prevBtn.style.display = 'none';
            } else {
                prevBtn.style.display = 'inline-block';
            }

            if (currentWizardStep === totalWizardSteps) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'inline-block';
            } else {
                nextBtn.style.display = 'inline-block';
                finishBtn.style.display = 'none';
            }
        }

        function copyToClipboard(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            document.execCommand('copy');
            showToast('üìã Copied to clipboard!', 'success');
        }

        function validateClientId(clientId) {
            const validation = document.getElementById('clientIdValidation');
            const testBtn = document.getElementById('testConnectionBtn');

            // Check if it matches Google OAuth Client ID format
            const isValid = clientId.trim().length > 0 &&
                           clientId.includes('-') &&
                           clientId.endsWith('.apps.googleusercontent.com');

            if (isValid) {
                validation.classList.remove('invalid');
                validation.classList.add('valid');
                testBtn.disabled = false;
            } else {
                validation.classList.remove('valid');
                validation.classList.add('invalid');
                testBtn.disabled = true;
            }
        }

        async function testGoogleDriveConnection() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            const resultDiv = document.getElementById('connectionResult');
            const testBtn = document.getElementById('testConnectionBtn');

            if (!clientId) {
                showToast('Please enter your Client ID first', 'error');
                return;
            }

            testBtn.disabled = true;
            testBtn.textContent = 'üîÑ Testing...';
            if (resultDiv) {
                resultDiv.classList.remove('is-hidden');
                resultDiv.style.display = 'block';
            }
            resultDiv.innerHTML = '<div class="wizard-alert">‚è≥ Connecting to Google Drive...</div>';

            try {
                // Update the google-drive-sync.js with the new Client ID
                if (typeof driveStorage !== 'undefined') {
                    driveStorage.CLIENT_ID = clientId;

                    // Re-initialize if previously initialized with a different Client ID
                    if (driveStorage._initPromise) {
                        driveStorage._initPromise = null;
                        driveStorage.tokenClient = null;
                    }

                    // Try to initialize and sign in
                    await driveStorage.init();
                    await driveStorage.signIn();

                    resultDiv.innerHTML = `
                        <div class="wizard-success">
                            <h3>‚úÖ Connection Successful!</h3>
                            <p style="margin-top: 0.5rem;">Your invoice system is now connected to Google Drive!</p>
                            <p style="margin-top: 0.5rem; opacity: 0.8;">You can close this window and start using cloud storage.</p>
                        </div>
                    `;

                    // Save the Client ID to localStorage for persistence
                    localStorage.setItem('google_drive_client_id', clientId);

                    // Stop pulsing the header button now that we're configured
                    const syncGoogleBtn = document.getElementById('syncGoogleBtn');
                    if (syncGoogleBtn) {
                        syncGoogleBtn.style.animation = '';
                    }

                    showToast('‚úÖ Successfully connected to Google Drive!', 'success');

                    // ‚ÄúAccept and done‚Äù: close the wizard automatically
                    closeModal('setupWizardModal');
                } else {
                    throw new Error('Google Drive module not loaded');
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                if (resultDiv) {
                    resultDiv.classList.remove('is-hidden');
                    resultDiv.style.display = 'block';
                }
                resultDiv.innerHTML = `
                    <div class="wizard-alert">
                        <strong>‚ö†Ô∏è Connection Failed</strong><br>
                        <p style="margin-top: 0.5rem;">${error.message}</p>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">
                            <strong>Troubleshooting:</strong><br>
                            ‚Ä¢ Make sure you copied the entire Client ID<br>
                            ‚Ä¢ Add this exact origin to Google OAuth "Authorized JavaScript origins": <strong>${location.origin}</strong><br>
                            ‚Ä¢ Try refreshing the page and testing again
                        </p>
                    </div>
                `;
                showToast('Connection test failed. Check the error message.', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üîå Test Connection';
            }
        }

        function finishWizard() {
            const clientId = document.getElementById('clientIdInput').value.trim();

            if (!clientId) {
                showToast('Please complete the connection test first', 'warning');
                return;
            }

            // Update google-drive-sync.js file with the Client ID
            updateGoogleDriveSyncFile(clientId);

            closeModal('setupWizardModal');
            showToast('üéâ Setup complete! Your data will now sync to Google Drive.', 'success');

            // Reload to apply changes
            setTimeout(() => {
                location.reload();
            }, 2000);
        }

        function updateGoogleDriveSyncFile(clientId) {
            // Save to localStorage so it persists
            localStorage.setItem('google_drive_client_id', clientId);

            // Show instructions to update the file
            const instructions = `
                <div style="background: rgba(0, 212, 255, 0.1); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--primary); margin: 1rem 0;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">üìù Final Step: Update google-drive-sync.js</h3>
                    <p style="margin-bottom: 1rem;">Open the file <code>google-drive-sync.js</code> and replace line 19:</p>
                    <div style="background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 5px; font-family: monospace; margin: 1rem 0;">
                        <div style="opacity: 0.5;">// OLD:</div>
                        <div style="color: #ff006e;">this.CLIENT_ID = 'YOUR_CLIENT_ID_HERE';</div>
                        <div style="opacity: 0.5; margin-top: 1rem;">// NEW:</div>
                        <div style="color: var(--success);">this.CLIENT_ID = '${clientId}';</div>
                    </div>
                    <p style="margin-top: 1rem;">Then refresh this page to activate Google Drive sync!</p>
                </div>
            `;

            // You could show this in a modal or toast
            console.log('Client ID to use:', clientId);
        }

        function openAddSupplierModal() {
            console.log('openAddSupplierModal called');
            resetSupplierForm();
            openModal('supplierModal');
            console.log('Supplier modal opened');
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                const modalId = event.target.id;
                closeModal(modalId);
            }
        });

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3500);
        }

        // Open Create Invoice Modal
        function openCreateInvoiceModal() {
            openModal('invoiceModal');
            document.getElementById('invoiceModalTitle').textContent = 'Create New Invoice';
            loadCustomersIntoSelect();
            currentInvoice = {
                items: [],
                subtotal: 0,
                vat: 0,
                total: 0,
                status: 'draft',
                paymentTerms: 30,
                amountPaid: 0,
                balance: 0,
                payments: []
            };

            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            document.getElementById('paymentTerms').value = '30';
            updateDueDate();

            // Set default status
            document.getElementById('invoiceStatus').value = 'draft';

            // Hide payment section for new invoices
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('paymentTrackingSection').style.display = 'none';
            document.getElementById('togglePaymentBtn').style.display = 'none';
            document.getElementById('whatsappBtn').style.display = 'none';
            document.getElementById('emailBtn').style.display = 'none';

            document.getElementById('invoiceItemsBody').innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td></tr>';
            document.getElementById('invoiceProductSearch').value = '';
            document.getElementById('productSearchResults').style.display = 'none';
            calculateInvoiceTotal();
        }

        // Product Category & Favorites Functions
        function showProductCategory(category) {
            const resultsDiv = document.getElementById('productSearchResults');
            let productsToShow = [];
            let title = '';

            switch(category) {
                case 'favorites':
                    productsToShow = products.filter(p => favoriteProducts.includes(p.sku));
                    title = '‚≠ê Favorite Products';
                    break;
                case 'recent':
                    // Get unique SKUs from recent invoices
                    const recentSKUs = [...new Set(
                        invoices.slice(-10).flatMap(inv => inv.items.map(item => item.sku))
                    )].slice(0, 20);
                    productsToShow = products.filter(p => recentSKUs.includes(p.sku));
                    title = 'üïê Recently Used Products';
                    break;
                case 'awake':
                    productsToShow = products.filter(p => p.brand === 'Awake');
                    title = 'üèÑ Awake Jetboards & E-foils';
                    break;
                case 'aqua':
                    productsToShow = products.filter(p => p.brand === 'Aqua Marina');
                    title = 'üåä Aqua Marina Products';
                    break;
                case 'all':
                    productsToShow = products;
                    title = 'üì¶ All Products';
                    break;
            }

            if (productsToShow.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: rgba(255,255,255,0.5);">
                        ${category === 'favorites' ? 'No favorites yet. Click ‚≠ê on products to add them!' : 'No products found'}
                    </div>
                `;
                resultsDiv.style.display = 'block';
                return;
            }

            resultsDiv.innerHTML = `
                <div style="padding: 0.75rem; background: rgba(0, 212, 255, 0.2); border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600;">
                    ${title} (${productsToShow.length})
                </div>
                ${productsToShow.slice(0, 20).map(p => `
                    <div class="search-result-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <div onclick="addProductToInvoiceFromSearch('${p.sku}')" style="flex: 1; cursor: pointer;">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-details">
                                <span>${p.sku}</span> ‚Ä¢
                                <span>${p.brand}</span> ‚Ä¢
                                <span style="color: var(--success); font-weight: 600;">R ${formatNumber(p.landedCost)}</span>
                            </div>
                        </div>
                        <button type="button" onclick="toggleFavorite('${p.sku}')" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0.5rem;" title="Toggle Favorite">
                            ${favoriteProducts.includes(p.sku) ? '‚≠ê' : '‚òÜ'}
                        </button>
                    </div>
                `).join('')}
            `;

            resultsDiv.style.display = 'block';
        }

        function showProductSearchResults() {
            const searchInput = document.getElementById('invoiceProductSearch');
            if (!searchInput.value.trim()) {
                showProductCategory('recent'); // Show recent by default
            }
        }

        async function toggleFavorite(sku) {
            const index = favoriteProducts.indexOf(sku);
            if (index > -1) {
                favoriteProducts.splice(index, 1);
            } else {
                favoriteProducts.push(sku);
            }
            await saveToStorage('aweh_favorites', favoriteProducts);

            // Refresh current view
            const resultsDiv = document.getElementById('productSearchResults');
            if (resultsDiv.style.display === 'block') {
                // Re-render current category
                const searchValue = document.getElementById('invoiceProductSearch').value;
                if (!searchValue.trim()) {
                    showProductCategory('recent');
                }
            }

            showToast(index > -1 ? 'Removed from favorites' : 'Added to favorites', 'success');
        }

        // Product Search in Invoice Modal
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('invoiceProductSearch');
            const resultsDiv = document.getElementById('productSearchResults');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const term = e.target.value.toLowerCase().trim();
                    
                    if (term.length < 2) {
                        resultsDiv.style.display = 'none';
                        return;
                    }
                    
                    const matches = products.filter(p =>
                        p.name.toLowerCase().includes(term) ||
                        p.sku.toLowerCase().includes(term) ||
                        p.category.toLowerCase().includes(term)
                    ).slice(0, 10);
                    
                    if (matches.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-result-item" style="color: rgba(255,255,255,0.5);">No products found</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }
                    
                    resultsDiv.innerHTML = matches.map(p => `
                        <div class="search-result-item" onclick="addProductToInvoiceFromSearch('${p.sku}')">
                            <div class="search-result-name">${p.name}</div>
                            <div class="search-result-details">
                                <span>${p.sku}</span> ‚Ä¢ 
                                <span>${p.brand}</span> ‚Ä¢ 
                                <span>${p.category}</span> ‚Ä¢ 
                                <span style="color: var(--success); font-weight: 600;">R ${formatNumber(p.landedCost)}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    resultsDiv.style.display = 'block';
                });
                
                // Close search results when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                        resultsDiv.style.display = 'none';
                    }
                });
            }
        });

        // Add Product from Search
        function addProductToInvoiceFromSearch(sku) {
            addProductToInvoice(sku);
            document.getElementById('invoiceProductSearch').value = '';
            document.getElementById('productSearchResults').style.display = 'none';

            // Show AI product recommendations after adding a product
            setTimeout(() => showProductRecommendations(), 100);
        }

        // Load Customers into Select
        function loadCustomersIntoSelect() {
            const select = document.getElementById('invoiceCustomer');
            select.innerHTML = '<option value="">Select Customer...</option>' +
                customers.map(c => `<option value="${c.id}">${c.name}${c.company ? ' - ' + c.company : ''}</option>`).join('');
        }

        // Add Product to Invoice
        function addProductToInvoice(sku) {
            const product = products.find(p => p.sku === sku);
            if (!product) return;
            
            // Check if product already in invoice
            const existing = currentInvoice.items.find(item => item.sku === sku);
            if (existing) {
                existing.qty++;
                existing.total = existing.qty * existing.unitPrice;
            } else {
                const tier = document.getElementById('invoiceTier').value;
                const unitPrice = calculatePrice(product.landedCost, tier);
                
                currentInvoice.items.push({
                    product: product.name,
                    sku: product.sku,
                    qty: 1,
                    unitPrice: unitPrice,
                    total: unitPrice
                });
            }
            
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
            showToast(`Added ${product.name} to invoice`, 'success');
        }

        // Get tier-specific cost multiplier
        function getTierCostMultiplier(tier) {
            const settings = getSettings();
            const tierCostMultipliers = settings.tierCostMultipliers || {
                retail: 1.0,
                platinum: 0.95,
                gold: 0.90,
                silver: 0.85,
                rental: 0.80,
                custom: 1.0
            };
            return tierCostMultipliers[tier] || 1.0;
        }

        // Calculate adjusted cost based on tier
        function getAdjustedCost(baseCost, tier) {
            const costMultiplier = getTierCostMultiplier(tier);
            return baseCost * costMultiplier;
        }

        // Calculate Price based on Tier (with tier-specific cost adjustments)
        function calculatePrice(cost, tier) {
            // First, adjust the cost based on tier (e.g., bulk purchase discounts)
            const adjustedCost = getAdjustedCost(cost, tier);

            // Then apply the pricing multiplier
            const pricingTiers = {
                'retail': 1.35,           // +35% margin
                'platinum': 1.08,         // -20% off retail
                'gold': 1.1475,           // -15% off retail
                'silver': 1.188,          // -12% off retail
                'rental': 1.0125,         // -25% off retail
                'custom': 1.30            // Default 30%
            };

            return Math.round(adjustedCost * pricingTiers[tier]);
        }

        // Update tier cost display (for settings sliders)
        function updateTierCostDisplay(tier, value) {
            const displayElement = document.getElementById(`tierCost${tier.charAt(0).toUpperCase() + tier.slice(1)}Display`);
            if (displayElement) {
                displayElement.textContent = parseFloat(value).toFixed(2) + 'x';
            }
        }

        // Update Invoice Items Table
        function updateInvoiceItemsTable() {
            const tbody = document.getElementById('invoiceItemsBody');

            if (currentInvoice.items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: rgba(255,255,255,0.5);">No items added yet</td></tr>';
                return;
            }

            tbody.innerHTML = currentInvoice.items.map((item, index) => {
                // Find product to get base cost
                const product = products.find(p => p.sku === item.sku);
                const baseCost = product?.landedCost || 0;

                // Get current tier and calculate adjusted cost
                const currentTier = document.getElementById('invoiceTier')?.value || 'retail';
                const adjustedUnitCost = getAdjustedCost(baseCost, currentTier);
                const totalCost = adjustedUnitCost * item.qty;

                // Calculate profit based on adjusted cost
                const itemProfit = item.total - totalCost;
                const itemMargin = item.total > 0 ? (itemProfit / item.total) * 100 : 0;

                // Color code profit margin
                let profitColor = '#06ffa5'; // Green
                if (itemMargin < 20) profitColor = '#ff006e'; // Red
                else if (itemMargin < 40) profitColor = '#ffbe0b'; // Yellow

                return `
                <tr>
                    <td>${item.product}</td>
                    <td>${item.sku}</td>
                    <td>
                        <input type="number" class="form-control editable" value="${item.qty}" min="1"
                            onchange="updateItemQuantity(${index}, this.value)" style="width: 80px;">
                    </td>
                    <td style="color: #ffbe0b;">R ${formatNumber(Math.round(totalCost))}</td>
                    <td>
                        <input type="number" class="form-control editable" value="${item.unitPrice}"
                            onchange="updateItemPrice(${index}, this.value)" style="width: 120px;">
                    </td>
                    <td>R ${formatNumber(item.total)}</td>
                    <td style="color: ${profitColor}; font-weight: 600;">
                        R ${formatNumber(Math.round(itemProfit))} (${itemMargin.toFixed(0)}%)
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm btn-icon" onclick="removeInvoiceItem(${index})">üóëÔ∏è</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Update Item Quantity
        function updateItemQuantity(index, qty) {
            const validQty = Math.max(1, parseInt(qty) || 1); // Minimum quantity is 1
            currentInvoice.items[index].qty = validQty;
            currentInvoice.items[index].total = validQty * currentInvoice.items[index].unitPrice;
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
        }

        // Update Item Price
        function updateItemPrice(index, price) {
            const validPrice = Math.max(0, parseInt(price) || 0); // Minimum price is 0
            currentInvoice.items[index].unitPrice = validPrice;
            currentInvoice.items[index].total = currentInvoice.items[index].qty * validPrice;
            updateInvoiceItemsTable();
            calculateInvoiceTotal();
        }

        // Remove Invoice Item
        function removeInvoiceItem(index) {
            currentInvoice.items.splice(index, 1);
            updateInvoiceItemsTable();
            calculateInvoiceTotal();

            // Update AI product recommendations
            setTimeout(() => showProductRecommendations(), 100);
        }

        // Calculate Invoice Total
        function calculateInvoiceTotal() {
            const subtotal = currentInvoice.items.reduce((sum, item) => sum + item.total, 0);
            const discountAmount = parseFloat(document.getElementById('discountAmount')?.value || 0);
            const discountType = document.getElementById('discountType')?.value || 'percentage';
            const shippingCost = parseFloat(document.getElementById('shippingCost')?.value || 0);
            const vatOption = document.getElementById('invoiceVAT')?.value || 'include';

            // Apply discount to subtotal FIRST
            let discountedAmount = 0;
            if (discountAmount > 0) {
                if (discountType === 'percentage') {
                    discountedAmount = subtotal * (discountAmount / 100);
                } else {
                    discountedAmount = Math.min(discountAmount, subtotal); // Can't discount more than subtotal
                }
            }

            // Calculate final subtotal: (subtotal - discount) + shipping
            let finalSubtotal = (subtotal - discountedAmount) + shippingCost;

            // Calculate VAT based on option
            let vat = 0;
            let total = finalSubtotal;

            if (vatOption === 'include') {
                // VAT is already included in the prices - extract the VAT portion
                vat = finalSubtotal * (15 / 115);
                total = finalSubtotal; // Total stays the same
            } else if (vatOption === 'exclude') {
                // VAT must be added on top
                vat = finalSubtotal * 0.15;
                total = finalSubtotal + vat;
            } else {
                // No VAT
                vat = 0;
                total = finalSubtotal;
            }

            currentInvoice.subtotal = finalSubtotal;
            currentInvoice.vat = vat;
            currentInvoice.total = total;

            document.getElementById('invoiceSubtotal').textContent = 'R ' + formatNumber(Math.round(finalSubtotal));
            document.getElementById('invoiceVATAmount').textContent = 'R ' + formatNumber(Math.round(vat));
            document.getElementById('invoiceTotal').textContent = 'R ' + formatNumber(Math.round(total));

            // Calculate and display profit margins
            calculateProfitMargins();
        }

        // Calculate Profit Margins (with tier-adjusted costs)
        function calculateProfitMargins() {
            // Get current tier
            const currentTier = document.getElementById('invoiceTier')?.value || 'retail';

            // Calculate total cost from all items using tier-adjusted costs
            let totalCost = 0;
            currentInvoice.items.forEach(item => {
                const product = products.find(p => p.sku === item.sku);
                if (product && product.landedCost) {
                    // Use tier-adjusted cost instead of base landed cost
                    const adjustedCost = getAdjustedCost(product.landedCost, currentTier);
                    totalCost += adjustedCost * item.qty;
                }
            });

            // Revenue is the subtotal (before VAT, after discount)
            const revenue = currentInvoice.items.reduce((sum, item) => sum + item.total, 0);

            // Calculate profit
            const grossProfit = revenue - totalCost;
            const profitMargin = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

            // Store in currentInvoice for later use
            currentInvoice.totalCost = totalCost;
            currentInvoice.grossProfit = grossProfit;
            currentInvoice.profitMargin = profitMargin;

            // Update display
            document.getElementById('invoiceTotalCost').textContent = 'R ' + formatNumber(Math.round(totalCost));
            document.getElementById('invoiceTotalRevenue').textContent = 'R ' + formatNumber(Math.round(revenue));
            document.getElementById('invoiceGrossProfit').textContent = 'R ' + formatNumber(Math.round(grossProfit));
            document.getElementById('invoiceProfitMargin').textContent = profitMargin.toFixed(1) + '%';

            // Color code the profit margin
            const marginElement = document.getElementById('invoiceProfitMargin');
            if (profitMargin < 20) {
                marginElement.style.color = '#ff006e'; // Red for low margin
            } else if (profitMargin < 40) {
                marginElement.style.color = '#ffbe0b'; // Yellow for medium margin
            } else {
                marginElement.style.color = '#06ffa5'; // Green for good margin
            }
        }

        // Save Invoice (handles both create and edit)
        async function saveInvoice() {
            const customer = document.getElementById('invoiceCustomer').value;
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }
            
            if (currentInvoice.items.length === 0) {
                showToast('Please add at least one product', 'error');
                return;
            }

            // Validate numeric inputs
            const discountAmount = sanitizeNumber(document.getElementById('discountAmount').value, 0);
            const shippingCost = sanitizeNumber(document.getElementById('shippingCost').value, 0);
            const depositAmount = sanitizeNumber(document.getElementById('depositAmount').value, 0);
            
            const invoiceData = {
                customerId: customer,
                customer: customers.find(c => c.id == customer)?.name || '',
                type: document.getElementById('invoiceType').value,
                tier: document.getElementById('invoiceTier').value,
                vatOption: document.getElementById('invoiceVAT').value,
                status: document.getElementById('invoiceStatus').value,
                paymentTerms: parseInt(document.getElementById('paymentTerms').value || 30),
                dueDate: document.getElementById('invoiceDueDate').value,
                items: [...currentInvoice.items],
                discount: {
                    amount: discountAmount,
                    type: document.getElementById('discountType').value
                },
                shipping: shippingCost,
                deposit: depositAmount,
                subtotal: currentInvoice.subtotal,
                vat: currentInvoice.vat,
                total: currentInvoice.total,
                amountPaid: currentInvoice.amountPaid || 0,
                balance: currentInvoice.total - (currentInvoice.amountPaid || 0),
                payments: currentInvoice.payments || []
            };
            
            if (currentInvoice.id) {
                // Editing existing invoice
                const index = invoices.findIndex(inv => inv.id === currentInvoice.id);
                if (index !== -1) {
                    invoices[index] = {
                        ...invoices[index],
                        ...invoiceData
                    };
                    showToast('Invoice updated successfully!', 'success');
                }
            } else {
                // Creating new invoice
                const timestamp = Date.now();
                const newInvoice = {
                    id: timestamp,
                    number: 'INV-' + new Date().getFullYear() + '-' + String(timestamp).slice(-8),
                    date: document.getElementById('invoiceDate').value || new Date().toISOString().split('T')[0],
                    ...invoiceData,
                    createdAt: timestamp
                };
                invoices.push(newInvoice);
                showToast('Invoice created successfully!', 'success');
            }
            
            await saveToStorage('aweh_invoices', invoices);

            closeModal('invoiceModal');
            loadRecentInvoices();
            updateDashboard();
        }

        // Load Recent Invoices
        function loadRecentInvoices() {
            const tbody = document.querySelector('#recentInvoicesTable tbody');
            const recentInvoices = invoices.slice(-10).reverse();
            
            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices yet. Create your first invoice!</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentInvoices.map(inv => `
                <tr>
                    <td>${inv.number}</td>
                    <td>${inv.date}</td>
                    <td>${inv.customer}</td>
                    <td>R ${formatNumber(Math.round(inv.total))}</td>
                    <td>${getStatusBadge(inv.status || 'draft')}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewInvoice(${inv.id})">üëÅÔ∏è</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editInvoice(${inv.id})">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteInvoice(${inv.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update Dashboard Stats
        function updateDashboard() {
            // Check for overdue invoices
            checkOverdueInvoices();

            const today = new Date().toISOString().split('T')[0];
            const todayInvoices = invoices.filter(inv => inv.date === today);
            const todayRevenue = todayInvoices.reduce((sum, inv) => sum + inv.total, 0);

            const thisMonth = new Date().toISOString().substr(0, 7);
            const monthInvoices = invoices.filter(inv => inv.date.startsWith(thisMonth));

            const totalRevenue = invoices.reduce((sum, inv) => sum + inv.total, 0);
            const totalPaid = invoices.reduce((sum, inv) => sum + (inv.amountPaid || 0), 0);
            const totalOutstanding = totalRevenue - totalPaid;

            document.getElementById('todayInvoices').textContent = todayInvoices.length;
            document.getElementById('todayRevenue').textContent = 'R ' + formatNumber(Math.round(todayRevenue));
            document.getElementById('monthInvoices').textContent = monthInvoices.length;
            document.getElementById('totalRevenue').textContent = 'R ' + formatNumber(Math.round(totalRevenue));

            // Update outstanding balance if element exists
            const outstandingEl = document.getElementById('totalOutstanding');
            if (outstandingEl) {
                outstandingEl.textContent = 'R ' + formatNumber(Math.round(totalOutstanding));
            }
        }

        async function persistSettingsToStorage() {
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            return await saveToStorage(storageKey, settings);
        }

        // Logo Upload
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Logo must be under 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                settings.logo = e.target.result;
                document.getElementById('logoPreview').src = e.target.result;
                document.getElementById('logoPreview').classList.add('active');

                const saved = await persistSettingsToStorage();
                if (saved) {
                    updateCurrentBusinessDisplay?.();
                    showToast('Logo uploaded successfully!', 'success');
                } else {
                    showToast('Logo upload failed to save. Storage quota may be exceeded.', 'error');
                }
            };
            reader.readAsDataURL(file);
        }

        // Remove Logo
        async function removeLogo() {
            settings.logo = '';
            document.getElementById('logoPreview').classList.remove('active');
            document.getElementById('logoUpload').value = '';

            const saved = await persistSettingsToStorage();
            if (saved) {
                updateCurrentBusinessDisplay?.();
                showToast('Logo removed', 'info');
            } else {
                showToast('Failed to save logo removal. Storage quota may be exceeded.', 'error');
            }
        }

        // Update Colors
        function updateColors() {
            settings.primaryColor = document.getElementById('primaryColor').value;
            settings.secondaryColor = document.getElementById('secondaryColor').value;
            settings.accentColor = document.getElementById('accentColor').value;
            
            document.documentElement.style.setProperty('--primary', settings.primaryColor);
            document.documentElement.style.setProperty('--secondary', settings.secondaryColor);
            document.documentElement.style.setProperty('--accent', settings.accentColor);
            
            saveSettings();
        }

        // Reset Colors
        function resetColors() {
            document.getElementById('primaryColor').value = '#00d4ff';
            document.getElementById('secondaryColor').value = '#ff006e';
            document.getElementById('accentColor').value = '#7209b7';
            updateColors();
            showToast('Colors reset to default', 'info');
        }

        // Save Settings
        async function saveSettings() {
            const email = document.getElementById('companyEmail').value.trim();
            if (email && !validateEmail(email)) {
                showToast('Please enter a valid company email address', 'error');
                return;
            }

            const phone = document.getElementById('companyPhone').value.trim();
            if (phone && !validatePhone(phone)) {
                showToast('Please enter a valid company phone number', 'error');
                return;
            }

            settings.companyName = document.getElementById('companyName').value.trim();
            settings.tradingAs = document.getElementById('tradingAs').value.trim();
            settings.email = email;
            settings.phone = phone;
            settings.website = document.getElementById('companyWebsite').value;
            settings.vat = document.getElementById('companyVAT').value;
            settings.address = document.getElementById('companyAddress').value;
            settings.bankName = document.getElementById('bankName').value;
            settings.accountHolder = document.getElementById('accountHolder').value;
            settings.accountNumber = document.getElementById('accountNumber').value;
            settings.branchCode = document.getElementById('branchCode').value;
            settings.showBanking = document.getElementById('showBanking').checked;

            // Invoice Theme Settings
            settings.logoPosition = document.getElementById('logoPosition')?.value || 'top-left';
            settings.logoSize = document.getElementById('logoSize')?.value || 'medium';
            settings.invoiceLayout = document.getElementById('invoiceLayout')?.value || 'modern';
            settings.fontStyle = document.getElementById('fontStyle')?.value || 'sans-serif';
            settings.fontSize = document.getElementById('fontSize')?.value || 'medium';
            settings.showLogo = document.getElementById('showLogo')?.checked ?? true;
            settings.showCompanyDetails = document.getElementById('showCompanyDetails')?.checked ?? true;
            settings.showCustomerDetails = document.getElementById('showCustomerDetails')?.checked ?? true;
            settings.showItemImages = document.getElementById('showItemImages')?.checked ?? false;
            settings.showNotes = document.getElementById('showNotes')?.checked ?? true;
            settings.showPageNumbers = document.getElementById('showPageNumbers')?.checked ?? true;
            settings.invoiceHeaderColor = document.getElementById('invoiceHeaderColor')?.value || '#00d4ff';
            settings.invoiceTextColor = document.getElementById('invoiceTextColor')?.value || '#000000';
            settings.invoiceAccentColor = document.getElementById('invoiceAccentColor')?.value || '#ff006e';
            settings.invoiceFooter = document.getElementById('invoiceFooter')?.value || 'Thank you for your business!';

            // Profit Margin Settings
            settings.showProfitOnPrint = document.getElementById('showProfitOnPrint')?.checked ?? false;

            // Tier Cost Adjustments
            settings.tierCostMultipliers = {
                retail: parseFloat(document.getElementById('tierCostRetail')?.value || 1.0),
                platinum: parseFloat(document.getElementById('tierCostPlatinum')?.value || 0.95),
                gold: parseFloat(document.getElementById('tierCostGold')?.value || 0.90),
                silver: parseFloat(document.getElementById('tierCostSilver')?.value || 0.85),
                rental: parseFloat(document.getElementById('tierCostRental')?.value || 0.80),
                custom: parseFloat(document.getElementById('tierCostCustom')?.value || 1.0)
            };

            // Use business-specific storage key
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            await saveToStorage(storageKey, settings);
            showToast('Settings saved successfully!', 'success');
        }

        // Helper function to get settings for current business
        async function getSettings() {
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            return await loadFromStorage(storageKey, {});
        }

        // Apply Invoice Template
        function applyTemplate(templateName) {
            const templates = {
                'modern-blue': {
                    name: 'Modern Blue',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'modern',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#00d4ff',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#0099cc',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'classic-black': {
                    name: 'Classic Black',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'classic',
                    fontStyle: 'serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#000000',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#333333',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'bold-red': {
                    name: 'Bold Red',
                    logoPosition: 'top-center',
                    logoSize: 'large',
                    invoiceLayout: 'bold',
                    fontStyle: 'sans-serif',
                    fontSize: 'large',
                    invoiceHeaderColor: '#ff006e',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#cc0055',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'elegant-purple': {
                    name: 'Elegant Purple',
                    logoPosition: 'top-center',
                    logoSize: 'medium',
                    invoiceLayout: 'elegant',
                    fontStyle: 'serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#7209b7',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#560bad',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'ocean-teal': {
                    name: 'Ocean Teal',
                    logoPosition: 'top-left',
                    logoSize: 'medium',
                    invoiceLayout: 'modern',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#06ffa5',
                    invoiceTextColor: '#333333',
                    invoiceAccentColor: '#00b377',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                },
                'sunset-orange': {
                    name: 'Sunset Orange',
                    logoPosition: 'top-right',
                    logoSize: 'large',
                    invoiceLayout: 'bold',
                    fontStyle: 'sans-serif',
                    fontSize: 'medium',
                    invoiceHeaderColor: '#ff9500',
                    invoiceTextColor: '#000000',
                    invoiceAccentColor: '#ff6b00',
                    showLogo: true,
                    showCompanyDetails: true,
                    showCustomerDetails: true,
                    showNotes: true,
                    showPageNumbers: true
                }
            };

            const template = templates[templateName];
            if (!template) return;

            // Apply template settings to form
            document.getElementById('logoPosition').value = template.logoPosition;
            document.getElementById('logoSize').value = template.logoSize;
            document.getElementById('invoiceLayout').value = template.invoiceLayout;
            document.getElementById('fontStyle').value = template.fontStyle;
            document.getElementById('fontSize').value = template.fontSize;
            document.getElementById('invoiceHeaderColor').value = template.invoiceHeaderColor;
            document.getElementById('invoiceTextColor').value = template.invoiceTextColor;
            document.getElementById('invoiceAccentColor').value = template.invoiceAccentColor;
            document.getElementById('showLogo').checked = template.showLogo;
            document.getElementById('showCompanyDetails').checked = template.showCompanyDetails;
            document.getElementById('showCustomerDetails').checked = template.showCustomerDetails;
            document.getElementById('showNotes').checked = template.showNotes;
            document.getElementById('showPageNumbers').checked = template.showPageNumbers;

            // Save settings
            saveSettings();

            showToast(`‚ú® ${template.name} template applied!`, 'success');
        }

        // Preview Invoice Theme
        function previewInvoiceTheme() {
            // Save current settings first
            saveSettings();

            showToast('Opening preview... Create a test invoice to see the theme in action!', 'info');

            // Switch to invoices tab and suggest creating a test invoice
            setTimeout(() => {
                switchTab('invoices');
                showToast('üí° Tip: Create a test invoice and click Print to see your theme!', 'info');
            }, 1500);
        }

        // Load Settings
        async function loadSettings() {
            // Use business-specific storage key
            const storageKey = currentBusiness ? `aweh_settings_${currentBusiness.id}` : 'aweh_settings';
            const saved = await loadFromStorage(storageKey, null);
            if (saved) {
                settings = saved;

                document.getElementById('companyName').value = settings.companyName || '';
                document.getElementById('tradingAs').value = settings.tradingAs || '';
                document.getElementById('companyEmail').value = settings.email || '';
                document.getElementById('companyPhone').value = settings.phone || '';
                document.getElementById('companyWebsite').value = settings.website || '';
                document.getElementById('companyVAT').value = settings.vat || '';
                document.getElementById('companyAddress').value = settings.address || '';
                document.getElementById('bankName').value = settings.bankName || '';
                document.getElementById('accountHolder').value = settings.accountHolder || '';
                document.getElementById('accountNumber').value = settings.accountNumber || '';
                document.getElementById('branchCode').value = settings.branchCode || '';
                document.getElementById('showBanking').checked = settings.showBanking !== false;

                document.getElementById('primaryColor').value = settings.primaryColor || '#00d4ff';
                document.getElementById('secondaryColor').value = settings.secondaryColor || '#ff006e';
                document.getElementById('accentColor').value = settings.accentColor || '#7209b7';

                // Load Invoice Theme Settings
                if (document.getElementById('logoPosition')) {
                    document.getElementById('logoPosition').value = settings.logoPosition || 'top-left';
                    document.getElementById('logoSize').value = settings.logoSize || 'medium';
                    document.getElementById('invoiceLayout').value = settings.invoiceLayout || 'modern';
                    document.getElementById('fontStyle').value = settings.fontStyle || 'sans-serif';
                    document.getElementById('fontSize').value = settings.fontSize || 'medium';
                    document.getElementById('showLogo').checked = settings.showLogo !== false;
                    document.getElementById('showCompanyDetails').checked = settings.showCompanyDetails !== false;
                    document.getElementById('showCustomerDetails').checked = settings.showCustomerDetails !== false;
                    document.getElementById('showItemImages').checked = settings.showItemImages || false;
                    document.getElementById('showNotes').checked = settings.showNotes !== false;
                    document.getElementById('showPageNumbers').checked = settings.showPageNumbers !== false;
                    document.getElementById('invoiceHeaderColor').value = settings.invoiceHeaderColor || '#00d4ff';
                    document.getElementById('invoiceTextColor').value = settings.invoiceTextColor || '#000000';
                    document.getElementById('invoiceAccentColor').value = settings.invoiceAccentColor || '#ff006e';
                    document.getElementById('invoiceFooter').value = settings.invoiceFooter || 'Thank you for your business!';
                }

                // Load Profit Margin Settings
                if (document.getElementById('showProfitOnPrint')) {
                    document.getElementById('showProfitOnPrint').checked = settings.showProfitOnPrint || false;
                }

                // Load Tier Cost Adjustments
                const tierCostMultipliers = settings.tierCostMultipliers || {
                    retail: 1.0,
                    platinum: 0.95,
                    gold: 0.90,
                    silver: 0.85,
                    rental: 0.80,
                    custom: 1.0
                };

                if (document.getElementById('tierCostRetail')) {
                    document.getElementById('tierCostRetail').value = tierCostMultipliers.retail;
                    document.getElementById('tierCostPlatinum').value = tierCostMultipliers.platinum;
                    document.getElementById('tierCostGold').value = tierCostMultipliers.gold;
                    document.getElementById('tierCostSilver').value = tierCostMultipliers.silver;
                    document.getElementById('tierCostRental').value = tierCostMultipliers.rental;
                    document.getElementById('tierCostCustom').value = tierCostMultipliers.custom;

                    // Update displays
                    updateTierCostDisplay('retail', tierCostMultipliers.retail);
                    updateTierCostDisplay('platinum', tierCostMultipliers.platinum);
                    updateTierCostDisplay('gold', tierCostMultipliers.gold);
                    updateTierCostDisplay('silver', tierCostMultipliers.silver);
                    updateTierCostDisplay('rental', tierCostMultipliers.rental);
                    updateTierCostDisplay('custom', tierCostMultipliers.custom);
                }

                if (settings.logo) {
                    document.getElementById('logoPreview').src = settings.logo;
                    document.getElementById('logoPreview').classList.add('active');
                }

                updateColors();

                // Reflect logo/name changes in the multi-business header
                if (typeof updateCurrentBusinessDisplay === 'function') {
                    updateCurrentBusinessDisplay();
                }
            }
        }

        // Save Customer (handles both create and edit)
        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            if (!validateRequired(name, 'Customer name')) {
                return;
            }

            const email = document.getElementById('customerEmail').value.trim();
            if (email && !validateEmail(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }

            const phone = document.getElementById('customerPhone').value.trim();
            if (phone && !validatePhone(phone)) {
                showToast('Please enter a valid phone number', 'error');
                return;
            }
            
            const customerData = {
                name: name,
                company: document.getElementById('customerCompany').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                vat: document.getElementById('customerVAT').value,
                tier: document.getElementById('customerTier').value
            };
            
            const editId = document.getElementById('customerModal').dataset.editId;
            
            if (editId) {
                // Editing existing customer
                const index = customers.findIndex(c => c.id == editId);
                if (index !== -1) {
                    customers[index] = {
                        ...customers[index],
                        ...customerData
                    };
                    showToast('Customer updated successfully!', 'success');
                }
                delete document.getElementById('customerModal').dataset.editId;
            } else {
                // Creating new customer
                const customer = {
                    id: Date.now(),
                    ...customerData
                };
                customers.push(customer);
                showToast('Customer added successfully!', 'success');
            }
            
            if (!await saveToStorage('aweh_customers', customers)) {
                return; // Stop if save failed
            }
            
            closeModal('customerModal');
            loadCustomers();
            
            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerVAT').value = '';
        }

        // Load Customers
        function loadCustomers() {
            const tbody = document.querySelector('#customersTable tbody');
            
            tbody.innerHTML = customers.map(c => `
                <tr>
                    <td>${c.name}</td>
                    <td>${c.email}</td>
                    <td>${c.phone}</td>
                    <td><span style="padding: 0.25rem 0.75rem; background: rgba(0, 212, 255, 0.2); border-radius: 20px; font-size: 0.85rem;">${c.tier}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-primary btn-sm btn-icon" onclick="editCustomer(${c.id})">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm btn-icon" onclick="deleteCustomer(${c.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Open Add Customer Modal
        function openAddCustomerModal() {
            openModal('customerModal');
            document.getElementById('customerModalTitle').textContent = 'Add New Customer';
            // Clear form
            document.getElementById('customerName').value = '';
            document.getElementById('customerCompany').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerAddress').value = '';
            document.getElementById('customerVAT').value = '';
            document.getElementById('customerTier').value = 'retail';
            // Clear edit ID
            delete document.getElementById('customerModal').dataset.editId;
        }

        // Export Data
        function exportData() {
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                settings: settings,
                invoices: invoices,
                customers: customers
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aweh-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showToast('Data exported successfully!', 'success');
        }
        
        // Import Data
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);

                        // Validate backup file structure
                        if (!data.version) {
                            throw new Error('Invalid backup file - missing version number');
                        }

                        if (data.invoices && !Array.isArray(data.invoices)) {
                            throw new Error('Invalid backup file - invoices data is corrupted');
                        }

                        if (data.customers && !Array.isArray(data.customers)) {
                            throw new Error('Invalid backup file - customers data is corrupted');
                        }

                        if (data.settings && typeof data.settings !== 'object') {
                            throw new Error('Invalid backup file - settings data is corrupted');
                        }

                        if (confirm('‚ö†Ô∏è IMPORT DATA\n\nThis will replace all current data!\n\nAre you sure you want to continue?')) {
                            // Create automatic backup before import
                            const backupData = {
                                version: '1.0',
                                backupDate: new Date().toISOString(),
                                settings: settings,
                                invoices: invoices,
                                customers: customers
                            };
                            safeSetItem('aweh_last_backup', JSON.stringify(backupData));
                            
                            if (data.settings) {
                                settings = data.settings;
                                await saveToStorage('aweh_settings', settings);
                            }
                            if (data.invoices) {
                                invoices = data.invoices;
                                await saveToStorage('aweh_invoices', invoices);
                            }
                            if (data.customers) {
                                customers = data.customers;
                                await saveToStorage('aweh_customers', customers);
                            }
                            
                            showToast('Data imported successfully! Reloading...', 'success');
                            setTimeout(() => location.reload(), 1500);
                        }
                    } catch (err) {
                        showToast('Error importing data: ' + err.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Open Settings Modal
        function openSettingsModal() {
            switchTab('settings');
        }

        // Print Invoice with Company Branding
        function printInvoice() {
            if (currentInvoice.items.length === 0) {
                showToast('Please add items before printing', 'error');
                return;
            }
            
            const customer = customers.find(c => c.id == document.getElementById('invoiceCustomer').value);
            if (!customer) {
                showToast('Please select a customer', 'error');
                return;
            }
            
            const invoiceNumber = currentInvoice.id ? 
                invoices.find(inv => inv.id === currentInvoice.id)?.number || 'DRAFT' : 
                'DRAFT';
            
            const invoiceType = document.getElementById('invoiceType').value.toUpperCase().replace('_', ' ');
            const date = new Date().toISOString().split('T')[0];
            
            let printHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${invoiceType} #${invoiceNumber}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: ${settings.fontStyle === 'serif' ? 'Georgia, serif' : settings.fontStyle === 'monospace' ? 'Courier New, monospace' : 'Arial, sans-serif'};
            padding: 40px;
            color: ${settings.invoiceTextColor || '#333'};
            background: white;
            font-size: ${settings.fontSize === 'small' ? '10pt' : settings.fontSize === 'large' ? '14pt' : '12pt'};
        }
        .invoice-header {
            display: flex;
            justify-content: ${settings.logoPosition === 'top-center' ? 'center' : 'space-between'};
            align-items: ${settings.logoPosition === 'top-center' ? 'center' : 'flex-start'};
            flex-direction: ${settings.logoPosition === 'top-center' ? 'column' : 'row'};
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: ${settings.invoiceLayout === 'bold' ? '5px' : '3px'} solid ${settings.invoiceHeaderColor || settings.primaryColor};
        }
        .company-info {
            flex: 1;
            ${settings.logoPosition === 'top-right' ? 'order: 2; text-align: right;' : ''}
            ${settings.logoPosition === 'top-center' ? 'text-align: center;' : ''}
        }
        .company-logo {
            max-width: ${settings.logoSize === 'small' ? '100px' : settings.logoSize === 'large' ? '200px' : '150px'};
            max-height: ${settings.logoSize === 'small' ? '60px' : settings.logoSize === 'large' ? '120px' : '80px'};
            margin-bottom: 10px;
            ${!settings.showLogo ? 'display: none;' : ''}
        }
        .company-name {
            font-size: ${settings.invoiceLayout === 'bold' ? '28px' : '24px'};
            font-weight: bold;
            color: ${settings.invoiceHeaderColor || settings.primaryColor};
            margin-bottom: 5px;
        }
        .company-details {
            font-size: ${settings.fontSize === 'small' ? '10px' : settings.fontSize === 'large' ? '14px' : '12px'};
            line-height: 1.6;
            color: #666;
            ${!settings.showCompanyDetails ? 'display: none;' : ''}
        }
        .invoice-info {
            text-align: ${settings.logoPosition === 'top-right' ? 'left' : settings.logoPosition === 'top-center' ? 'center' : 'right'};
            ${settings.logoPosition === 'top-right' ? 'order: 1;' : ''}
            ${settings.logoPosition === 'top-center' ? 'margin-top: 20px;' : ''}
        }
        .invoice-title {
            font-size: ${settings.invoiceLayout === 'bold' ? '36px' : '32px'};
            font-weight: bold;
            color: ${settings.invoiceHeaderColor || settings.primaryColor};
            margin-bottom: 10px;
        }
        .invoice-details {
            font-size: ${settings.fontSize === 'small' ? '11px' : settings.fontSize === 'large' ? '15px' : '13px'};
            line-height: 1.8;
        }
        .customer-section {
            margin: 30px 0;
            padding: 20px;
            background: ${settings.invoiceLayout === 'elegant' ? '#fafafa' : '#f9f9f9'};
            border-left: 4px solid ${settings.invoiceHeaderColor || settings.primaryColor};
            ${!settings.showCustomerDetails ? 'display: none;' : ''}
        }
        .section-title {
            font-size: ${settings.fontSize === 'small' ? '12px' : settings.fontSize === 'large' ? '16px' : '14px'};
            font-weight: bold;
            color: ${settings.invoiceHeaderColor || settings.primaryColor};
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .customer-details {
            font-size: ${settings.fontSize === 'small' ? '11px' : settings.fontSize === 'large' ? '15px' : '13px'};
            line-height: 1.6;
        }
        table { width: 100%; border-collapse: collapse; margin: 30px 0; }
        th {
            background: ${settings.invoiceLayout === 'bold' ? settings.invoiceHeaderColor || settings.primaryColor : settings.invoiceLayout === 'elegant' ? '#333' : settings.invoiceHeaderColor || settings.primaryColor};
            color: white;
            padding: ${settings.invoiceLayout === 'bold' ? '15px 12px' : '12px'};
            text-align: left;
            font-size: ${settings.fontSize === 'small' ? '11px' : settings.fontSize === 'large' ? '15px' : '13px'};
            text-transform: uppercase;
        }
        td {
            padding: ${settings.invoiceLayout === 'bold' ? '12px' : '10px 12px'};
            border-bottom: 1px solid #eee;
            font-size: ${settings.fontSize === 'small' ? '11px' : settings.fontSize === 'large' ? '15px' : '13px'};
        }
        tr:hover { background: #f9f9f9; }
        .text-right { text-align: right; }
        .totals-section { float: right; width: 400px; margin-top: 20px; }
        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            font-size: ${settings.fontSize === 'small' ? '12px' : settings.fontSize === 'large' ? '16px' : '14px'};
        }
        .totals-row.subtotal { background: #f9f9f9; }
        .totals-row.total {
            background: ${settings.invoiceHeaderColor || settings.primaryColor};
            color: white;
            font-weight: bold;
            font-size: ${settings.fontSize === 'small' ? '16px' : settings.fontSize === 'large' ? '20px' : '18px'};
            margin-top: 5px;
        }
        .banking-section {
            clear: both;
            margin-top: 50px;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid ${settings.invoiceAccentColor || settings.secondaryColor};
        }
        .banking-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: ${settings.fontSize === 'small' ? '11px' : settings.fontSize === 'large' ? '15px' : '13px'};
        }
        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            text-align: center;
            font-size: ${settings.fontSize === 'small' ? '10px' : settings.fontSize === 'large' ? '14px' : '12px'};
            color: #999;
            ${!settings.showNotes ? 'display: none;' : ''}
        }
        @media print {
            body { padding: 20px; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>
    <div class="invoice-header">
        <div class="company-info">
            ${settings.logo ? `<img src="${settings.logo}" class="company-logo" alt="Company Logo">` : ''}
            <div class="company-name">${settings.companyName}</div>
            ${settings.tradingAs ? `<div style="font-size: 14px; color: #666; margin-bottom: 10px;">Trading as: ${settings.tradingAs}</div>` : ''}
            <div class="company-details">
                ${settings.address ? settings.address.replace(/\n/g, '<br>') + '<br>' : ''}
                ${settings.phone ? 'Tel: ' + settings.phone + '<br>' : ''}
                ${settings.email ? 'Email: ' + settings.email + '<br>' : ''}
                ${settings.website ? 'Web: ' + settings.website + '<br>' : ''}
                ${settings.vat ? 'VAT#: ' + settings.vat : ''}
            </div>
        </div>
        <div class="invoice-info">
            <div class="invoice-title">${invoiceType}</div>
            <div class="invoice-details">
                <strong>Number:</strong> ${invoiceNumber}<br>
                <strong>Date:</strong> ${date}<br>
                <strong>Pricing Tier:</strong> ${document.getElementById('invoiceTier').value.toUpperCase()}<br>
                <strong>VAT:</strong> ${document.getElementById('invoiceVAT').value === 'include' ? 'Inclusive' : document.getElementById('invoiceVAT').value === 'exclude' ? 'Exclusive' : 'None'}
            </div>
        </div>
    </div>

    <div class="customer-section">
        <div class="section-title">Bill To</div>
        <div class="customer-details">
            <strong>${customer.name}</strong><br>
            ${customer.company ? customer.company + '<br>' : ''}
            ${customer.address ? customer.address.replace(/\n/g, '<br>') + '<br>' : ''}
            ${customer.email ? 'Email: ' + customer.email + '<br>' : ''}
            ${customer.phone ? 'Tel: ' + customer.phone + '<br>' : ''}
            ${customer.vat ? 'VAT#: ' + customer.vat : ''}
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40%;">Product</th>
                <th style="width: 15%;">SKU</th>
                <th style="width: 10%;" class="text-right">Qty</th>
                <th style="width: 15%;" class="text-right">Unit Price</th>
                <th style="width: 20%;" class="text-right">Total</th>
            </tr>
        </thead>
        <tbody>
            ${currentInvoice.items.map(item => `
                <tr>
                    <td>${item.product}</td>
                    <td>${item.sku}</td>
                    <td class="text-right">${item.qty}</td>
                    <td class="text-right">R ${formatNumber(item.unitPrice)}</td>
                    <td class="text-right">R ${formatNumber(item.total)}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>

    <div class="totals-section">
        <div class="totals-row subtotal">
            <span>Subtotal:</span>
            <span>R ${formatNumber(Math.round(currentInvoice.subtotal))}</span>
        </div>
        ${document.getElementById('discountAmount')?.value > 0 ? `
        <div class="totals-row">
            <span>Discount (${document.getElementById('discountAmount').value}${document.getElementById('discountType').value === 'percentage' ? '%' : ''}):</span>
            <span>- R ${formatNumber(Math.round(document.getElementById('discountType').value === 'percentage' ? currentInvoice.subtotal * (parseFloat(document.getElementById('discountAmount').value) / 100) : parseFloat(document.getElementById('discountAmount').value)))}</span>
        </div>
        ` : ''}
        ${document.getElementById('shippingCost')?.value > 0 ? `
        <div class="totals-row">
            <span>Shipping:</span>
            <span>R ${formatNumber(Math.round(parseFloat(document.getElementById('shippingCost').value)))}</span>
        </div>
        ` : ''}
        ${document.getElementById('invoiceVAT').value === 'include' ? `
        <div class="totals-row">
            <span>VAT (15%):</span>
            <span>R ${formatNumber(Math.round(currentInvoice.vat))}</span>
        </div>
        ` : ''}
        <div class="totals-row total">
            <span>TOTAL:</span>
            <span>R ${formatNumber(Math.round(currentInvoice.total))}</span>
        </div>
        ${document.getElementById('depositAmount')?.value > 0 ? `
        <div class="totals-row">
            <span>Deposit Paid:</span>
            <span>R ${formatNumber(Math.round(parseFloat(document.getElementById('depositAmount').value)))}</span>
        </div>
        <div class="totals-row total">
            <span>Balance Due:</span>
            <span>R ${formatNumber(Math.round(currentInvoice.total - parseFloat(document.getElementById('depositAmount').value)))}</span>
        </div>
        ` : ''}
    </div>

    ${settings.showProfitOnPrint ? `
    <div class="profit-section" style="margin-top: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(6, 255, 165, 0.1), rgba(0, 212, 255, 0.1)); border-radius: 8px; border: 2px solid rgba(6, 255, 165, 0.3);">
        <div class="section-title" style="color: #06ffa5; margin-bottom: 1rem; font-size: 1.2rem; font-weight: 700;">üí∞ Profit Analysis</div>
        <div style="display: grid; gap: 0.75rem;">
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <span style="font-weight: 600;">Total Cost:</span>
                <span style="color: #ffbe0b; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.totalCost))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <span style="font-weight: 600;">Total Revenue:</span>
                <span style="color: #00d4ff; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.subtotal))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(6, 255, 165, 0.15); border-radius: 4px; font-size: 1.1rem;">
                <span style="font-weight: 700;">Gross Profit:</span>
                <span style="color: #06ffa5; font-weight: 700;">R ${formatNumber(Math.round(currentInvoice.grossProfit))}</span>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: rgba(6, 255, 165, 0.15); border-radius: 4px; font-size: 1.1rem;">
                <span style="font-weight: 700;">Profit Margin:</span>
                <span style="color: #06ffa5; font-weight: 700;">${currentInvoice.profitMargin.toFixed(1)}%</span>
            </div>
        </div>
    </div>
    ` : ''}

    ${settings.showBanking ? `
    <div class="banking-section">
        <div class="section-title">Banking Details</div>
        <div class="banking-details">
            <div><strong>Bank:</strong> ${settings.bankName}</div>
            <div><strong>Account Holder:</strong> ${settings.accountHolder}</div>
            <div><strong>Account Number:</strong> ${settings.accountNumber}</div>
            <div><strong>Branch Code:</strong> ${settings.branchCode}</div>
        </div>
    </div>
    ` : ''}

    ${settings.showNotes ? `
    <div class="footer">
        <p>${settings.invoiceFooter || 'Thank you for your business!'}</p>
    </div>
    ` : ''}

    <script>
        window.onload = function() {
            setTimeout(function() {
                window.print();
            }, 500);
        };
    <\/script>
</body>
</html>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHtml);
            printWindow.document.close();
        }

        // View, Edit, Delete Invoice - COMPLETE IMPLEMENTATIONS
        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            alert(`Invoice #${invoice.number}\n\nCustomer: ${invoice.customer}\nDate: ${invoice.date}\nTotal: R ${formatNumber(Math.round(invoice.total))}\nItems: ${invoice.items.length}\n\nFull view modal coming in next update!`);
        }

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Open modal
            openModal('invoiceModal');
            document.getElementById('invoiceModalTitle').textContent = 'Edit Invoice #' + invoice.number;
            
            // Load customers
            loadCustomersIntoSelect();
            
            // Set customer
            const customerSelect = document.getElementById('invoiceCustomer');
            const customer = customers.find(c => c.name === invoice.customer);
            if (customer) {
                customerSelect.value = customer.id;
            }
            
            // Set other fields
            document.getElementById('invoiceTier').value = invoice.tier || 'retail';
            document.getElementById('invoiceType').value = invoice.type || 'invoice';
            document.getElementById('invoiceVAT').value = invoice.vatOption || 'include';
            document.getElementById('invoiceStatus').value = invoice.status || 'draft';
            document.getElementById('paymentTerms').value = invoice.paymentTerms || 30;
            document.getElementById('invoiceDate').value = invoice.date || new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('discountAmount').value = invoice.discount?.amount || 0;
            document.getElementById('discountType').value = invoice.discount?.type || 'percentage';
            document.getElementById('shippingCost').value = invoice.shipping || 0;
            document.getElementById('depositAmount').value = invoice.deposit || 0;

            // Load items
            currentInvoice = {
                id: invoice.id,
                items: [...invoice.items],
                subtotal: invoice.subtotal,
                vat: invoice.vat,
                total: invoice.total,
                status: invoice.status || 'draft',
                paymentTerms: invoice.paymentTerms || 30,
                dueDate: invoice.dueDate || '',
                amountPaid: invoice.amountPaid || 0,
                balance: invoice.balance || invoice.total,
                payments: invoice.payments || []
            };

            // Show payment section if invoice is saved
            if (invoice.id) {
                document.getElementById('togglePaymentBtn').style.display = 'inline-block';
                document.getElementById('whatsappBtn').style.display = 'inline-block';
                document.getElementById('emailBtn').style.display = 'inline-block';
            }

            updateInvoiceItemsTable();
            calculateInvoiceTotal();
            updatePaymentDisplay();

            showToast('Invoice loaded for editing', 'info');
        }

        async function deleteInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;
            
            // Double confirmation
            if (!confirm(`‚ö†Ô∏è DELETE INVOICE?\n\nInvoice #${invoice.number}\nCustomer: ${invoice.customer}\nTotal: R ${formatNumber(Math.round(invoice.total))}\n\nAre you sure?`)) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL CONFIRMATION\n\nThis action cannot be undone!\n\nDelete this invoice permanently?')) {
                return;
            }
            
            invoices = invoices.filter(inv => inv.id !== id);
            await saveToStorage('aweh_invoices', invoices);
            loadRecentInvoices();
            updateDashboard();
            showToast('Invoice deleted permanently', 'success');
        }

        function editCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            openModal('customerModal');
            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerCompany').value = customer.company || '';
            document.getElementById('customerEmail').value = customer.email || '';
            document.getElementById('customerPhone').value = customer.phone || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerVAT').value = customer.vat || '';
            document.getElementById('customerTier').value = customer.tier || 'retail';
            
            // Store ID for updating
            document.getElementById('customerModal').dataset.editId = id;
        }

        async function deleteCustomer(id) {
            const customer = customers.find(c => c.id === id);
            if (!customer) return;
            
            if (confirm(`‚ö†Ô∏è DELETE CUSTOMER?\n\nName: ${customer.name}\n${customer.company ? 'Company: ' + customer.company + '\n' : ''}Are you sure?`)) {
                customers = customers.filter(c => c.id !== id);
                if (await saveToStorage('aweh_customers', customers)) {
                    loadCustomers();
                    showToast('Customer deleted', 'success');
                }
            }
        }

        // Profile Management
        function saveProfile() {
            const name = prompt('Enter profile name:');
            if (!name) return;
            
            const profiles = JSON.parse(localStorage.getItem('aweh_profiles') || '[]');
            profiles.push({
                id: Date.now(),
                name: name,
                settings: {...settings}
            });
            
            if (safeSetItem('aweh_profiles', JSON.stringify(profiles))) {
                loadProfiles();
                showToast('Profile saved!', 'success');
            }
        }

        function loadProfile() {
            const profileId = document.getElementById('profileSelector').value;
            if (!profileId) return;
            
            const profiles = JSON.parse(localStorage.getItem('aweh_profiles') || '[]');
            const profile = profiles.find(p => p.id == profileId);
            
            if (profile && confirm('Load profile "' + profile.name + '"? Current settings will be replaced.')) {
                settings = {...profile.settings};
                if (safeSetItem('aweh_settings', JSON.stringify(settings))) {
                    location.reload();
                }
            }
        }

        function deleteProfile() {
            const profileId = document.getElementById('profileSelector').value;
            if (!profileId) return;
            
            if (confirm('Delete this profile?')) {
                let profiles = safeGetItem('aweh_profiles', []);
                profiles = profiles.filter(p => p.id != profileId);
                if (safeSetItem('aweh_profiles', JSON.stringify(profiles))) {
                    loadProfiles();
                    showToast('Profile deleted', 'success');
                }
            }
        }

        function loadProfiles() {
            const profiles = safeGetItem('aweh_profiles', []);
            const select = document.getElementById('profileSelector');
            select.innerHTML = '<option value="">Select a profile...</option>' +
                profiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Aweh Be Lekker Invoice System...');

            // Load businesses first so settings use the correct business-specific key
            if (typeof loadBusinesses === 'function') {
                await loadBusinesses();
            }

            // Check if Google Drive Client ID is configured
            const savedClientId = localStorage.getItem('google_drive_client_id');
            const syncGoogleBtn = document.getElementById('syncGoogleBtn');

            const isValidClientId = Boolean(
                savedClientId &&
                typeof savedClientId === 'string' &&
                savedClientId.includes('-') &&
                savedClientId.endsWith('.apps.googleusercontent.com')
            );

            if (isValidClientId && typeof driveStorage !== 'undefined') {
                // Client ID is configured; keep Sync Google visible
                if (syncGoogleBtn) {
                    syncGoogleBtn.style.display = 'inline-flex';
                    syncGoogleBtn.style.animation = '';
                }

                // Update driveStorage with saved Client ID
                driveStorage.CLIENT_ID = savedClientId;

                // If the module initialized earlier with a placeholder, re-init with the saved Client ID
                if (driveStorage._initPromise) {
                    driveStorage._initPromise = null;
                    driveStorage.tokenClient = null;
                }
            } else {
                // If an invalid client id is stored, clear it so the UI doesn't get stuck
                if (savedClientId && !isValidClientId) {
                    localStorage.removeItem('google_drive_client_id');
                }

                // Not configured, keep Sync Google visible and highlight it
                if (syncGoogleBtn) {
                    syncGoogleBtn.style.display = 'inline-flex';
                    syncGoogleBtn.style.animation = 'pulse 2s infinite';
                }
            }

            // Initialize Google Drive (if available)
            if (typeof driveStorage !== 'undefined') {
                try {
                    await driveStorage.init();
                    console.log('‚úÖ Google Drive initialized');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Google Drive initialization failed, using localStorage only:', error);
                }
            }

            initializeProducts();
            initializeCustomers();
            await loadSettings();
            loadProfiles();

            // Load saved data
            invoices = await loadFromStorage('aweh_invoices', []);
            customers = await loadFromStorage('aweh_customers', []);
            suppliers = await loadFromStorage('aweh_suppliers', []);
            favoriteProducts = await loadFromStorage('aweh_favorites', []);

            // Re-initialize customers if empty
            if (customers.length === 0) {
                initializeCustomers();
            }

            // Render suppliers if the table exists
            if (typeof loadSuppliers === 'function') {
                loadSuppliers();
            }

            loadRecentInvoices();
            updateDashboard();
            loadCustomers();

            // Close modals on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        closeModal(modal.id);
                    });
                }

                // Keyboard shortcuts
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'n':
                            e.preventDefault();
                            openCreateInvoiceModal();
                            break;
                        case 's':
                            if (document.getElementById('settings').classList.contains('active')) {
                                e.preventDefault();
                                saveSettings();
                            }
                            break;
                        case 'e':
                            e.preventDefault();
                            exportData();
                            break;
                    }
                }
            });

            // Load all invoices table
            loadAllInvoices();

            // Invoice search and filter
            document.getElementById('invoiceSearch')?.addEventListener('input', loadAllInvoices);
            document.getElementById('invoiceFilter')?.addEventListener('change', loadAllInvoices);

            console.log('‚úÖ System ready! Loaded', products.length, 'products');
        });
        
        // Load All Invoices
        function loadAllInvoices() {
            const tbody = document.querySelector('#allInvoicesTable tbody');
            const searchTerm = document.getElementById('invoiceSearch')?.value.toLowerCase() || '';
            const filterType = document.getElementById('invoiceFilter')?.value || 'all';
            const filterStatus = document.getElementById('statusFilter')?.value || 'all';

            let filtered = invoices;

            if (filterType !== 'all') {
                filtered = filtered.filter(inv => inv.type === filterType);
            }

            if (filterStatus !== 'all') {
                filtered = filtered.filter(inv => (inv.status || 'draft') === filterStatus);
            }

            if (searchTerm) {
                filtered = filtered.filter(inv =>
                    inv.number.toLowerCase().includes(searchTerm) ||
                    inv.customer.toLowerCase().includes(searchTerm) ||
                    inv.type.toLowerCase().includes(searchTerm) ||
                    (inv.status || 'draft').toLowerCase().includes(searchTerm)
                );
            }
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: rgba(255,255,255,0.5);">No invoices found</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.reverse().map(inv => {
                const balance = (inv.total || 0) - (inv.amountPaid || 0);
                return `
                <tr>
                    <td>${inv.number}</td>
                    <td>${inv.date}</td>
                    <td>${inv.dueDate || '-'}</td>
                    <td>${inv.customer}</td>
                    <td><span style="padding: 0.25rem 0.75rem; background: rgba(6, 255, 165, 0.2); border-radius: 20px; font-size: 0.85rem;">${inv.type}</span></td>
                    <td>${getStatusBadge(inv.status || 'draft')}</td>
                    <td>R ${formatNumber(Math.round(inv.total))}</td>
                    <td style="color: ${balance > 0 ? 'var(--accent)' : 'var(--success)'};">R ${formatNumber(Math.round(balance))}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewInvoice(${inv.id})" title="View">üëÅÔ∏è</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editInvoice(${inv.id})" title="Edit">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-success btn-sm btn-icon" onclick="duplicateInvoice(${inv.id})" title="Duplicate">üìã</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteInvoice(${inv.id})" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `}).join('');
        }
        
        // Duplicate Invoice
        async function duplicateInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const newInvoice = {
                ...invoice,
                id: Date.now(),
                number: 'INV-' + String(Date.now()).substr(-6),
                date: new Date().toISOString().split('T')[0],
                createdAt: Date.now()
            };

            invoices.push(newInvoice);
            await saveToStorage('aweh_invoices', invoices);
            loadRecentInvoices();
            loadAllInvoices();
            updateDashboard();
            showToast('Invoice duplicated successfully!', 'success');
        }

        // ============================================
        // SUPPLIER MANAGEMENT FUNCTIONS
        // ============================================

        function openAddSupplierModal() {
            document.getElementById('supplierModal').style.display = 'flex';
            // Clear form
            document.getElementById('supplierName').value = '';
            document.getElementById('supplierContact').value = '';
            document.getElementById('supplierEmail').value = '';
            document.getElementById('supplierPhone').value = '';
            document.getElementById('supplierWebsite').value = '';
            document.getElementById('supplierCategory').value = 'jetboards';
            document.getElementById('supplierAddress').value = '';
            document.getElementById('supplierNotes').value = '';
            document.getElementById('supplierLogoUpload').value = '';
            document.getElementById('supplierLogoPreview').style.display = 'none';
        }

        function handleSupplierLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 500KB)
            if (file.size > 500000) {
                showToast('Logo file is too large. Please use an image under 500KB.', 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('supplierLogoPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function saveSupplier() {
            const name = document.getElementById('supplierName').value.trim();
            if (!name) {
                showToast('Please enter supplier name', 'error');
                return;
            }

            const supplier = {
                id: Date.now(),
                name: name,
                contact: document.getElementById('supplierContact').value.trim(),
                email: document.getElementById('supplierEmail').value.trim(),
                phone: document.getElementById('supplierPhone').value.trim(),
                website: document.getElementById('supplierWebsite').value.trim(),
                category: document.getElementById('supplierCategory').value,
                address: document.getElementById('supplierAddress').value.trim(),
                notes: document.getElementById('supplierNotes').value.trim(),
                logo: document.getElementById('supplierLogoPreview').src || '',
                products: [],
                createdAt: Date.now(),
                lastUpdated: new Date().toISOString().split('T')[0]
            };

            suppliers.push(supplier);
            if (await saveToStorage('aweh_suppliers', suppliers)) {
                loadSuppliers();
                closeModal('supplierModal');
                showToast('Supplier added successfully!', 'success');
            }
        }

        function loadSuppliers() {
            const tbody = document.querySelector('#suppliersTable tbody');
            if (!tbody) return;

            if (suppliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255,255,255,0.5);">No suppliers yet. Add your first supplier!</td></tr>';
                return;
            }

            tbody.innerHTML = suppliers.map(s => `
                <tr>
                    <td>
                        ${s.logo ? `<img src="${s.logo}" style="width: 40px; height: 40px; object-fit: contain; border-radius: 4px;" alt="${s.name} logo">` : 'üè¢'}
                    </td>
                    <td>
                        <strong>${s.name}</strong><br>
                        <small style="opacity: 0.7;">${s.category}</small>
                    </td>
                    <td>
                        ${s.contact ? `<div>${s.contact}</div>` : ''}
                        ${s.email ? `<div style="font-size: 0.85rem; opacity: 0.8;">${s.email}</div>` : ''}
                        ${s.phone ? `<div style="font-size: 0.85rem; opacity: 0.8;">${s.phone}</div>` : ''}
                    </td>
                    <td>${s.products.length} products</td>
                    <td>${s.lastUpdated}</td>
                    <td class="action-buttons">
                        <button type="button" class="btn btn-primary btn-sm btn-icon" onclick="viewSupplier(${s.id})" title="View">üëÅÔ∏è</button>
                        <button type="button" class="btn btn-secondary btn-sm btn-icon" onclick="editSupplier(${s.id})" title="Edit">‚úèÔ∏è</button>
                        <button type="button" class="btn btn-danger btn-sm btn-icon" onclick="deleteSupplier(${s.id})" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function viewSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            showToast(`Viewing ${supplier.name}`, 'info');
            // TODO: Implement supplier detail view
        }

        function editSupplier(id) {
            const supplier = suppliers.find(s => s.id === id);
            if (!supplier) return;
            showToast(`Editing ${supplier.name}`, 'info');
            // TODO: Implement supplier editing
        }

        async function deleteSupplier(id) {
            if (!confirm('Are you sure you want to delete this supplier?')) return;

            suppliers = suppliers.filter(s => s.id !== id);
            if (await saveToStorage('aweh_suppliers', suppliers)) {
                loadSuppliers();
                showToast('Supplier deleted successfully!', 'success');
            }
        }

        // ============================================
        // OCR SCANNING FUNCTIONS
        // ============================================

        let currentStream = null;
        let currentScanType = 'invoice'; // 'invoice', 'pricelist', 'receipt'

        function scanPriceList() {
            currentScanType = 'pricelist';
            document.getElementById('scannerModalTitle').textContent = 'üì∑ Scan Price List';
            document.getElementById('scannerModal').style.display = 'flex';
        }

        function scanInvoice() {
            currentScanType = 'invoice';
            document.getElementById('scannerModalTitle').textContent = 'üì∑ Scan Invoice';
            document.getElementById('scannerModal').style.display = 'flex';
        }

        function uploadPriceList() {
            showToast('Price list upload feature coming soon! For now, use the scan feature.', 'info');
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                currentStream = stream;

                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;

                document.getElementById('cameraView').style.display = 'block';
                document.querySelector('#scannerContent > div').style.display = 'none';
            } catch (error) {
                showToast('Camera access denied or not available. Please use file upload instead.', 'error');
                console.error('Camera error:', error);
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraView').style.display = 'none';
            document.querySelector('#scannerContent > div').style.display = 'block';
        }

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('capturedCanvas');
            const context = canvas.getContext('2d');

            // Set canvas size to video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            context.drawImage(video, 0, 0);

            // Stop camera
            stopCamera();

            // Show captured image
            document.getElementById('capturedImageView').style.display = 'block';
        }

        function handleScanFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('capturedCanvas');
                    const context = canvas.getContext('2d');

                    canvas.width = img.width;
                    canvas.height = img.height;
                    context.drawImage(img, 0, 0);

                    document.querySelector('#scannerContent > div').style.display = 'none';
                    document.getElementById('capturedImageView').style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function processOCR() {
            // Check if Tesseract.js is loaded
            if (typeof Tesseract === 'undefined') {
                showToast('OCR library not loaded. Please check your internet connection.', 'error');
                return;
            }

            const canvas = document.getElementById('capturedCanvas');
            const progressDiv = document.getElementById('ocrProgress');
            const statusDiv = document.getElementById('ocrStatus');
            const progressBar = document.getElementById('ocrProgressBar');
            const processBtn = document.getElementById('processBtn');

            progressDiv.style.display = 'block';
            processBtn.disabled = true;

            try {
                const worker = await Tesseract.createWorker({
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            statusDiv.textContent = `Recognizing text... ${progress}%`;
                            progressBar.style.width = progress + '%';
                        } else {
                            statusDiv.textContent = m.status;
                        }
                    }
                });

                await worker.loadLanguage('eng');
                await worker.initialize('eng');

                const { data: { text } } = await worker.recognize(canvas);
                await worker.terminate();

                // Show results
                document.getElementById('ocrText').textContent = text;
                document.getElementById('capturedImageView').style.display = 'none';
                document.getElementById('ocrResults').style.display = 'block';

                showToast('Text extracted successfully!', 'success');
            } catch (error) {
                showToast('OCR processing failed. Please try again.', 'error');
                console.error('OCR error:', error);
                processBtn.disabled = false;
                progressDiv.style.display = 'none';
            }
        }

        // ============================================
        // AI INVOICE ANALYSIS FUNCTIONS
        // ============================================

        let analysisResults = {
            supplier: null,
            products: [],
            priceChanges: [],
            newProducts: []
        };

        function analyzeSupplierInvoice() {
            const text = document.getElementById('ocrText').textContent;

            // Close scanner modal and open analysis modal
            closeModal('scannerModal');
            openModal('invoiceAnalysisModal');

            // Start analysis
            performSupplierRecognition(text);
            performProductAnalysis(text);
        }

        // Supplier Recognition using AI pattern matching
        function performSupplierRecognition(text) {
            const resultDiv = document.getElementById('supplierRecognitionResult');

            // Extract potential supplier names (look for common patterns)
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Common supplier name indicators
            const supplierKeywords = ['pty', 'ltd', 'limited', 'inc', 'corp', 'company', 'suppliers', 'trading'];

            // Look for company names in first 10 lines (usually at top of invoice)
            let potentialSuppliers = [];
            for (let i = 0; i < Math.min(10, lines.length); i++) {
                const line = lines[i].toLowerCase();
                if (supplierKeywords.some(keyword => line.includes(keyword))) {
                    potentialSuppliers.push(lines[i]);
                }
            }

            // Also look for email domains and phone numbers
            const emailMatch = text.match(/[\w\.-]+@[\w\.-]+\.\w+/);
            const phoneMatch = text.match(/\+?\d{1,4}[\s-]?\(?\d{1,4}\)?[\s-]?\d{1,4}[\s-]?\d{1,9}/);

            // Try to match against existing suppliers
            let matchedSupplier = null;
            let matchScore = 0;

            suppliers.forEach(supplier => {
                let score = 0;

                // Check name match
                potentialSuppliers.forEach(potential => {
                    if (potential.toLowerCase().includes(supplier.name.toLowerCase()) ||
                        supplier.name.toLowerCase().includes(potential.toLowerCase())) {
                        score += 10;
                    }
                });

                // Check email match
                if (emailMatch && supplier.email &&
                    emailMatch[0].toLowerCase().includes(supplier.email.toLowerCase().split('@')[1])) {
                    score += 5;
                }

                // Check phone match
                if (phoneMatch && supplier.phone) {
                    const cleanPhone = supplier.phone.replace(/\D/g, '');
                    const scannedPhone = phoneMatch[0].replace(/\D/g, '');
                    if (scannedPhone.includes(cleanPhone.slice(-7)) || cleanPhone.includes(scannedPhone.slice(-7))) {
                        score += 5;
                    }
                }

                if (score > matchScore) {
                    matchScore = score;
                    matchedSupplier = supplier;
                }
            });

            // Display results
            if (matchedSupplier && matchScore >= 5) {
                analysisResults.supplier = matchedSupplier;
                resultDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        ${matchedSupplier.logo ? `<img src="${matchedSupplier.logo}" style="width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: white; padding: 0.5rem;">` : '<div style="width: 60px; height: 60px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem;">üì¶</div>'}
                        <div style="flex: 1;">
                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--success); margin-bottom: 0.25rem;">
                                ‚úÖ Supplier Identified
                            </div>
                            <div style="font-size: 1.1rem; margin-bottom: 0.25rem;">${matchedSupplier.name}</div>
                            <div style="font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                                ${matchedSupplier.email || ''} ${matchedSupplier.phone ? '‚Ä¢ ' + matchedSupplier.phone : ''}
                            </div>
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(6, 255, 165, 0.1); border-radius: 4px; font-size: 0.85rem;">
                                <strong>Match Confidence:</strong> ${Math.min(100, matchScore * 10)}%
                            </div>
                        </div>
                    </div>
                `;
            } else {
                analysisResults.supplier = null;
                resultDiv.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">‚ùì</div>
                        <div style="font-size: 1.1rem; color: var(--warning); margin-bottom: 0.5rem;">Supplier Not Recognized</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.6); margin-bottom: 1rem;">
                            Could not match this invoice to any existing supplier in your database.
                        </div>
                        ${potentialSuppliers.length > 0 ? `
                            <div style="text-align: left; margin-top: 1rem; padding: 1rem; background: rgba(255,190,11,0.1); border-radius: 8px;">
                                <strong>Detected company names:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem;">
                                    ${potentialSuppliers.slice(0, 3).map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <button type="button" class="btn btn-primary" onclick="switchTab('suppliers')" style="margin-top: 1rem;">
                            ‚ûï Add New Supplier
                        </button>
                    </div>
                `;
            }
        }

        // Product Analysis and Price Change Detection
        function performProductAnalysis(text) {
            const resultDiv = document.getElementById('productAnalysisResult');

            // Parse invoice lines looking for product patterns
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);

            // Common patterns for invoice line items:
            // SKU | Product Name | Qty | Price
            // Product Name | SKU | Price
            // etc.

            let detectedProducts = [];

            // Look for SKU patterns (alphanumeric with dashes)
            const skuPattern = /\b[A-Z0-9]{2,}[-][A-Z0-9]{2,}[-]?[A-Z0-9]*\b/g;

            // Look for price patterns (R followed by number, or just numbers with decimals)
            const pricePattern = /R?\s*(\d{1,3}(?:[,\s]\d{3})*(?:\.\d{2})?)/g;

            lines.forEach((line, index) => {
                const skuMatches = line.match(skuPattern);
                const priceMatches = [...line.matchAll(pricePattern)];

                if (skuMatches && priceMatches.length > 0) {
                    skuMatches.forEach(sku => {
                        // Extract price (last number on line is usually the total)
                        const price = priceMatches[priceMatches.length - 1][1].replace(/[,\s]/g, '');

                        // Try to extract product name (text between SKU and price)
                        let productName = line.replace(sku, '').replace(priceMatches[priceMatches.length - 1][0], '').trim();

                        // Clean up product name
                        productName = productName.replace(/^\d+\s*/, ''); // Remove leading numbers
                        productName = productName.replace(/\s+/g, ' '); // Normalize spaces

                        if (productName.length > 3) {
                            detectedProducts.push({
                                sku: sku,
                                name: productName,
                                price: parseFloat(price),
                                rawLine: line
                            });
                        }
                    });
                }
            });

            // Match detected products against catalog
            analysisResults.priceChanges = [];
            analysisResults.newProducts = [];

            detectedProducts.forEach(detected => {
                // Try exact SKU match first
                let catalogProduct = products.find(p => p.sku === detected.sku);

                // If no exact match, try fuzzy matching on name
                if (!catalogProduct) {
                    catalogProduct = products.find(p => {
                        const nameSimilarity = calculateSimilarity(p.name.toLowerCase(), detected.name.toLowerCase());
                        const skuSimilarity = calculateSimilarity(p.sku.toLowerCase(), detected.sku.toLowerCase());
                        return nameSimilarity > 0.7 || skuSimilarity > 0.8;
                    });
                }

                if (catalogProduct) {
                    // Product exists - check for price changes
                    const oldPrice = catalogProduct.landedCost;
                    const newPrice = detected.price;
                    const priceDiff = newPrice - oldPrice;
                    const percentChange = ((priceDiff / oldPrice) * 100).toFixed(1);

                    if (Math.abs(priceDiff) > 0.01) { // Price changed
                        analysisResults.priceChanges.push({
                            product: catalogProduct,
                            oldPrice: oldPrice,
                            newPrice: newPrice,
                            difference: priceDiff,
                            percentChange: percentChange,
                            detected: detected
                        });
                    }
                } else {
                    // New product not in catalog
                    analysisResults.newProducts.push(detected);
                }
            });

            // Display results
            displayProductAnalysisResults();
        }

        // Calculate string similarity (Levenshtein distance based)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        function displayProductAnalysisResults() {
            const resultDiv = document.getElementById('productAnalysisResult');
            const applyBtn = document.getElementById('applyUpdatesBtn');

            let html = '';

            // Price Changes Section
            if (analysisResults.priceChanges.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--warning); margin-bottom: 1rem;">‚ö†Ô∏è Price Changes Detected (${analysisResults.priceChanges.length})</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">Product</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">SKU</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Old Price</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">New Price</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Change</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.2);">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                analysisResults.priceChanges.forEach((change, index) => {
                    const isIncrease = change.difference > 0;
                    const changeColor = isIncrease ? '#ff006e' : '#06ffa5';
                    const changeIcon = isIncrease ? 'üìà' : 'üìâ';

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">${change.product.name}</td>
                            <td style="padding: 0.75rem; font-family: monospace;">${change.product.sku}</td>
                            <td style="padding: 0.75rem; text-align: right;">R ${formatNumber(Math.round(change.oldPrice))}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">R ${formatNumber(Math.round(change.newPrice))}</td>
                            <td style="padding: 0.75rem; text-align: right; color: ${changeColor}; font-weight: 600;">
                                ${changeIcon} ${isIncrease ? '+' : ''}R ${formatNumber(Math.round(change.difference))} (${change.percentChange}%)
                            </td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="checkbox" class="price-update-checkbox" data-index="${index}" checked>
                                    <span style="font-size: 0.9rem;">Update</span>
                                </label>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                applyBtn.style.display = 'inline-block';
            }

            // New Products Section
            if (analysisResults.newProducts.length > 0) {
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary); margin-bottom: 1rem;">üÜï New Products Detected (${analysisResults.newProducts.length})</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: rgba(255,255,255,0.1);">
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">Product Name</th>
                                        <th style="padding: 0.75rem; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.2);">SKU</th>
                                        <th style="padding: 0.75rem; text-align: right; border-bottom: 2px solid rgba(255,255,255,0.2);">Price</th>
                                        <th style="padding: 0.75rem; text-align: center; border-bottom: 2px solid rgba(255,255,255,0.2);">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                analysisResults.newProducts.forEach((product, index) => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                            <td style="padding: 0.75rem;">${product.name}</td>
                            <td style="padding: 0.75rem; font-family: monospace;">${product.sku}</td>
                            <td style="padding: 0.75rem; text-align: right; font-weight: 600;">R ${formatNumber(Math.round(product.price))}</td>
                            <td style="padding: 0.75rem; text-align: center;">
                                <button type="button" class="btn btn-sm btn-primary" onclick="addNewProductFromScan(${index})">
                                    ‚ûï Add to Catalog
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // No changes detected
            if (analysisResults.priceChanges.length === 0 && analysisResults.newProducts.length === 0) {
                html = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üîç</div>
                        <div style="font-size: 1.1rem; color: rgba(255,255,255,0.7); margin-bottom: 0.5rem;">No Products Detected</div>
                        <div style="font-size: 0.9rem; color: rgba(255,255,255,0.5);">
                            Could not identify any products or prices on this invoice.<br>
                            The invoice format may not be recognized, or the OCR quality may be low.
                        </div>
                        <button type="button" class="btn btn-outline" onclick="resetScanner(); closeModal('invoiceAnalysisModal');" style="margin-top: 1rem;">
                            Try Again
                        </button>
                    </div>
                `;
            }

            resultDiv.innerHTML = html;
        }

        function resetScanner() {
            stopCamera();
            document.getElementById('cameraView').style.display = 'none';
            document.getElementById('capturedImageView').style.display = 'none';
            document.getElementById('ocrResults').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
            document.querySelector('#scannerContent > div').style.display = 'block';
        }

        // Apply Price Updates from Scanned Invoice
        function applyPriceUpdates() {
            const checkboxes = document.querySelectorAll('.price-update-checkbox:checked');
            let updatedCount = 0;

            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.dataset.index);
                const change = analysisResults.priceChanges[index];

                // Find product in catalog and update price
                const productIndex = products.findIndex(p => p.sku === change.product.sku);
                if (productIndex !== -1) {
                    products[productIndex].landedCost = change.newPrice;
                    updatedCount++;
                }
            });

            // Save updated products to localStorage
            if (updatedCount > 0) {
                localStorage.setItem('aweh_products', JSON.stringify(products));
                showToast(`‚úÖ Updated ${updatedCount} product price${updatedCount > 1 ? 's' : ''}!`, 'success');

                // Log the update
                console.log(`Price update from supplier invoice:`, {
                    supplier: analysisResults.supplier?.name || 'Unknown',
                    updatedProducts: updatedCount,
                    timestamp: new Date().toISOString()
                });
            }

            // Close modal and reset
            closeModal('invoiceAnalysisModal');
            resetScanner();

            // Refresh product display if on products tab
            if (document.querySelector('[onclick="switchTab(\'products\')"]').parentElement.classList.contains('active')) {
                // Trigger product list refresh if needed
                showToast('üí° Product prices updated. Refresh the page to see changes in product list.', 'info');
            }
        }

        // Add New Product from Scanned Invoice
        function addNewProductFromScan(index) {
            const newProduct = analysisResults.newProducts[index];

            // Determine category and brand based on supplier
            let category = 'General';
            let brand = 'Unknown';

            if (analysisResults.supplier) {
                // Try to infer category from supplier
                const supplierName = analysisResults.supplier.name.toLowerCase();
                if (supplierName.includes('awake')) {
                    category = 'Jetboards';
                    brand = 'Awake';
                } else if (supplierName.includes('aqua') || supplierName.includes('marina')) {
                    category = 'Aqua Marina';
                    brand = 'Aqua Marina';
                }

                // Use supplier category if available
                if (analysisResults.supplier.category) {
                    category = analysisResults.supplier.category;
                }
            }

            // Create new product object
            const product = {
                sku: newProduct.sku,
                name: newProduct.name,
                brand: brand,
                category: category,
                landedCost: newProduct.price,
                description: `Imported from supplier invoice on ${new Date().toLocaleDateString()}`
            };

            // Add to products array
            products.push(product);

            // Save to localStorage
            localStorage.setItem('aweh_products', JSON.stringify(products));

            // Remove from new products list
            analysisResults.newProducts.splice(index, 1);

            // Refresh display
            displayProductAnalysisResults();

            showToast(`‚úÖ Added "${product.name}" to catalog!`, 'success');
        }

        // ============================================
        // MULTI-BUSINESS MANAGEMENT
        // ============================================

        async function loadBusinesses() {
            businesses = await loadFromStorage('aweh_businesses', []);
            if (!Array.isArray(businesses)) {
                businesses = [];
            }

            // If no businesses exist, create default one
            if (businesses.length === 0) {
                businesses.push({
                    id: 'default',
                    name: 'Aweh Be Lekker',
                    tradingAs: '',
                    type: 'retail',
                    regNumber: '',
                    vatNumber: '',
                    createdAt: new Date().toISOString()
                });
                await saveToStorage('aweh_businesses', businesses);
            }

            // Load current business
            const currentId = localStorage.getItem('aweh_currentBusiness') || 'default';
            currentBusiness = businesses.find(b => b.id === currentId) || businesses[0];

            updateCurrentBusinessDisplay();
        }

        function updateCurrentBusinessDisplay() {
            if (!currentBusiness) return;

            document.getElementById('currentBusinessName').textContent = currentBusiness.name;

            let details = [];
            if (currentBusiness.tradingAs) details.push(`Trading as: ${currentBusiness.tradingAs}`);
            if (currentBusiness.type) details.push(currentBusiness.type.charAt(0).toUpperCase() + currentBusiness.type.slice(1));
            if (currentBusiness.vatNumber) details.push(`VAT: ${currentBusiness.vatNumber}`);

            document.getElementById('currentBusinessDetails').textContent = details.join(' ‚Ä¢ ');

            // Update logo if exists
            if (settings?.logo) {
                document.getElementById('currentBusinessLogo').innerHTML = `<img src="${settings.logo}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;">`;
            } else {
                document.getElementById('currentBusinessLogo').textContent = 'üè¢';
            }
        }

        function openCreateBusinessModal() {
            // Clear form
            document.getElementById('businessName').value = '';
            document.getElementById('businessTradingAs').value = '';
            document.getElementById('businessType').value = 'retail';
            document.getElementById('businessRegNumber').value = '';
            document.getElementById('businessVatNumber').value = '';

            document.getElementById('businessModalTitle').textContent = '‚ûï Add New Business';
            openModal('businessModal');
        }

        async function saveNewBusiness() {
            const name = document.getElementById('businessName').value.trim();

            if (!name) {
                showToast('Please enter a business name', 'error');
                return;
            }

            const newBusiness = {
                id: 'business_' + Date.now(),
                name: name,
                tradingAs: document.getElementById('businessTradingAs').value.trim(),
                type: document.getElementById('businessType').value,
                regNumber: document.getElementById('businessRegNumber').value.trim(),
                vatNumber: document.getElementById('businessVatNumber').value.trim(),
                createdAt: new Date().toISOString()
            };

            businesses.push(newBusiness);
            await saveToStorage('aweh_businesses', businesses);

            showToast(`‚úÖ Business "${name}" created successfully!`, 'success');
            closeModal('businessModal');

            // Ask if user wants to switch to new business
            if (confirm(`Switch to "${name}" now?`)) {
                switchToBusiness(newBusiness.id);
            }
        }

        function openSwitchBusinessModal() {
            const listDiv = document.getElementById('businessSwitchList');

            listDiv.innerHTML = businesses.map(business => {
                const isActive = business.id === currentBusiness.id;
                return `
                    <div style="padding: 1rem; background: ${isActive ? 'rgba(0, 212, 255, 0.2)' : 'rgba(0,0,0,0.3)'}; border-radius: 8px; border: 2px solid ${isActive ? 'var(--primary)' : 'transparent'}; cursor: pointer; transition: all 0.3s;" onclick="switchToBusiness('${business.id}')">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üè¢
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">
                                    ${business.name} ${isActive ? '<span style="color: var(--success); font-size: 0.9rem;">‚úì Active</span>' : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">
                                    ${business.tradingAs ? business.tradingAs + ' ‚Ä¢ ' : ''}${business.type.charAt(0).toUpperCase() + business.type.slice(1)}
                                    ${business.vatNumber ? ' ‚Ä¢ VAT: ' + business.vatNumber : ''}
                                </div>
                            </div>
                            ${!isActive ? `<button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); switchToBusiness('${business.id}')">Switch</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            openModal('switchBusinessModal');
        }

        function switchToBusiness(businessId) {
            const business = businesses.find(b => b.id === businessId);
            if (!business) {
                showToast('Business not found', 'error');
                return;
            }

            // Save current business data before switching
            saveSettings();

            // Switch to new business
            currentBusiness = business;
            localStorage.setItem('aweh_currentBusiness', businessId);

            // Load settings for new business
            loadSettings();

            // Update display
            updateCurrentBusinessDisplay();

            showToast(`‚úÖ Switched to "${business.name}"`, 'success');
            closeModal('switchBusinessModal');

            // Reload page to refresh all data
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        

        // ============================================
        // AI SMART FUNCTIONS
        // ============================================

        // Customer Selection AI
        function onCustomerSelected() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                document.getElementById('aiQuickActions').style.display = 'none';
                document.getElementById('customerInsight').style.display = 'none';
                document.getElementById('tierSuggestion').style.display = 'none';
                document.getElementById('aiSuggestionsBar').style.display = 'none';
                return;
            }

            const customer = customers.find(c => c.id == customerId);
            if (!customer) return;

            // Show quick actions
            document.getElementById('aiQuickActions').style.display = 'block';

            // Get customer insights
            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);
            const insights = analyzeCustomer(customerId);

            // Show customer insight
            const insightEl = document.getElementById('customerInsight');
            if (customerInvoices.length > 0) {
                insightEl.textContent = `üí° ${customerInvoices.length} previous invoice${customerInvoices.length > 1 ? 's' : ''} ‚Ä¢ Avg: R ${formatNumber(insights.avgInvoiceValue)} ‚Ä¢ Last: ${insights.daysSinceLastInvoice} days ago`;
                insightEl.style.display = 'block';
            }

            // Suggest pricing tier
            if (customer.pricingTier && customer.pricingTier !== document.getElementById('invoiceTier').value) {
                const tierEl = document.getElementById('tierSuggestion');
                tierEl.textContent = `üí° This customer usually uses "${customer.pricingTier}" tier`;
                tierEl.style.display = 'block';

                // Auto-select customer's preferred tier
                document.getElementById('invoiceTier').value = customer.pricingTier;
            }

            // Check for duplicate risk
            checkDuplicateRisk(customerId);

            // Show AI suggestions
            showAISuggestions(customerId, insights);

            // Predict payment date
            predictPaymentDate(customerId);
        }

        function analyzeCustomer(customerId) {
            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);

            if (customerInvoices.length === 0) {
                return {
                    avgInvoiceValue: 0,
                    totalRevenue: 0,
                    invoiceCount: 0,
                    daysSinceLastInvoice: null,
                    avgPaymentDays: null,
                    commonProducts: [],
                    preferredTier: null
                };
            }

            // Calculate average invoice value
            const totalRevenue = customerInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
            const avgInvoiceValue = totalRevenue / customerInvoices.length;

            // Days since last invoice
            const lastInvoice = customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            const daysSinceLastInvoice = Math.floor((new Date() - new Date(lastInvoice.date)) / (1000 * 60 * 60 * 24));

            // Average payment days
            const paidInvoices = customerInvoices.filter(inv => inv.status === 'paid' && inv.payments && inv.payments.length > 0);
            let avgPaymentDays = null;
            if (paidInvoices.length > 0) {
                const paymentDays = paidInvoices.map(inv => {
                    const invoiceDate = new Date(inv.date);
                    const paymentDate = new Date(inv.payments[0].date);
                    return Math.floor((paymentDate - invoiceDate) / (1000 * 60 * 60 * 24));
                });
                avgPaymentDays = Math.round(paymentDays.reduce((sum, days) => sum + days, 0) / paymentDays.length);
            }

            // Find common products
            const productFrequency = {};
            customerInvoices.forEach(inv => {
                if (inv.items) {
                    inv.items.forEach(item => {
                        productFrequency[item.sku] = (productFrequency[item.sku] || 0) + 1;
                    });
                }
            });

            const commonProducts = Object.entries(productFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([sku, count]) => ({ sku, count }));

            return {
                avgInvoiceValue,
                totalRevenue,
                invoiceCount: customerInvoices.length,
                daysSinceLastInvoice,
                avgPaymentDays,
                commonProducts,
                preferredTier: lastInvoice.tier || null
            };
        }

        function showAISuggestions(customerId, insights) {
            const suggestionsBar = document.getElementById('aiSuggestionsBar');
            const suggestionsContent = document.getElementById('aiSuggestionsContent');

            const suggestions = [];

            // Suggest based on time since last invoice
            if (insights.daysSinceLastInvoice !== null) {
                if (insights.daysSinceLastInvoice > 90) {
                    suggestions.push(`‚è∞ It's been ${insights.daysSinceLastInvoice} days since last order. Consider offering a special discount to re-engage.`);
                } else if (insights.daysSinceLastInvoice < 7) {
                    suggestions.push(`‚ö†Ô∏è Last invoice was only ${insights.daysSinceLastInvoice} days ago. Check for potential duplicate.`);
                }
            }

            // Suggest based on payment history
            if (insights.avgPaymentDays !== null) {
                if (insights.avgPaymentDays > 45) {
                    suggestions.push(`üí∞ This customer typically pays in ${insights.avgPaymentDays} days. Consider shorter payment terms or upfront deposit.`);
                } else if (insights.avgPaymentDays < 15) {
                    suggestions.push(`‚úÖ Great payer! Average payment time: ${insights.avgPaymentDays} days.`);
                }
            }

            // Suggest based on order value
            if (insights.avgInvoiceValue > 0) {
                suggestions.push(`üìä Average order value: R ${formatNumber(insights.avgInvoiceValue)}. Total lifetime value: R ${formatNumber(insights.totalRevenue)}`);
            }

            if (suggestions.length > 0) {
                suggestionsContent.innerHTML = suggestions.map(s => `<div style="padding: 0.25rem 0;">${s}</div>`).join('');
                suggestionsBar.style.display = 'block';
            } else {
                suggestionsBar.style.display = 'none';
            }
        }

        function checkDuplicateRisk(customerId) {
            const recentInvoices = invoices.filter(inv => {
                const daysSince = Math.floor((new Date() - new Date(inv.date)) / (1000 * 60 * 60 * 24));
                return inv.customerId == customerId && daysSince < 7;
            });

            if (recentInvoices.length > 0) {
                const lastInvoice = recentInvoices[0];
                if (confirm(`‚ö†Ô∏è DUPLICATE WARNING!\n\nThis customer has ${recentInvoices.length} invoice(s) in the last 7 days.\n\nLast invoice: ${lastInvoice.number} on ${lastInvoice.date}\nAmount: R ${formatNumber(lastInvoice.total)}\n\nDo you want to continue creating a new invoice?`)) {
                    return true;
                } else {
                    closeModal('invoiceModal');
                    return false;
                }
            }
            return true;
        }

        function predictPaymentDate(customerId) {
            const insights = analyzeCustomer(customerId);

            if (insights.avgPaymentDays !== null) {
                const invoiceDate = document.getElementById('invoiceDate').value || new Date().toISOString().split('T')[0];
                const predictedDate = new Date(invoiceDate);
                predictedDate.setDate(predictedDate.getDate() + insights.avgPaymentDays);

                // Show prediction in due date field hint
                const dueDateField = document.getElementById('invoiceDueDate');
                dueDateField.title = `üí° Predicted payment date based on history: ${predictedDate.toISOString().split('T')[0]} (${insights.avgPaymentDays} days)`;
            }
        }

        // Quick Actions
        function repeatLastInvoice() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const customerInvoices = invoices.filter(inv => inv.customerId == customerId);
            if (customerInvoices.length === 0) {
                showToast('No previous invoices found for this customer', 'info');
                return;
            }

            // Get last invoice
            const lastInvoice = customerInvoices.sort((a, b) => new Date(b.date) - new Date(a.date))[0];

            // Copy items
            if (lastInvoice.items && lastInvoice.items.length > 0) {
                currentInvoice.items = JSON.parse(JSON.stringify(lastInvoice.items));
                renderInvoiceItems();
                calculateInvoiceTotal();
                showToast(`Added ${lastInvoice.items.length} items from last invoice`, 'success');
            } else {
                showToast('Last invoice has no items', 'info');
            }
        }

        function addRecommendedProducts() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const insights = analyzeCustomer(customerId);

            if (insights.commonProducts.length === 0) {
                showToast('No product history found for this customer', 'info');
                return;
            }

            // Add top 3 most common products
            let added = 0;
            insights.commonProducts.slice(0, 3).forEach(({ sku }) => {
                const product = products.find(p => p.sku === sku);
                if (product && !currentInvoice.items.find(item => item.sku === sku)) {
                    addProductToInvoiceFromSearch(sku);
                    added++;
                }
            });

            if (added > 0) {
                showToast(`Added ${added} commonly ordered product(s)`, 'success');
            } else {
                showToast('All common products already added', 'info');
            }
        }

        function showCustomerHistory() {
            const customerId = document.getElementById('invoiceCustomer').value;
            if (!customerId) {
                showToast('Please select a customer first', 'error');
                return;
            }

            const customer = customers.find(c => c.id == customerId);
            const insights = analyzeCustomer(customerId);

            let historyHTML = `
                <strong>${customer.name}</strong><br><br>
                üìä Total Invoices: ${insights.invoiceCount}<br>
                üí∞ Total Revenue: R ${formatNumber(insights.totalRevenue)}<br>
                üìà Average Invoice: R ${formatNumber(insights.avgInvoiceValue)}<br>
            `;

            if (insights.daysSinceLastInvoice !== null) {
                historyHTML += `‚è∞ Last Invoice: ${insights.daysSinceLastInvoice} days ago<br>`;
            }

            if (insights.avgPaymentDays !== null) {
                historyHTML += `üí≥ Avg Payment Time: ${insights.avgPaymentDays} days<br>`;
            }

            if (insights.commonProducts.length > 0) {
                historyHTML += `<br><strong>Most Ordered Products:</strong><br>`;
                insights.commonProducts.forEach(({ sku, count }) => {
                    const product = products.find(p => p.sku === sku);
                    if (product) {
                        historyHTML += `‚Ä¢ ${product.name} (${count}x)<br>`;
                    }
                });
            }

            alert(historyHTML.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, ''));
        }

        // Product Recommendations AI
        function showProductRecommendations() {
            if (currentInvoice.items.length === 0) {
                document.getElementById('aiProductRecommendations').style.display = 'none';
                return;
            }

            // Get SKUs of current items
            const currentSKUs = currentInvoice.items.map(item => item.sku);

            // Find products that are frequently bought together
            const recommendations = findRelatedProducts(currentSKUs);

            if (recommendations.length === 0) {
                document.getElementById('aiProductRecommendations').style.display = 'none';
                return;
            }

            // Show recommendations
            const listEl = document.getElementById('recommendedProductsList');
            listEl.innerHTML = recommendations.slice(0, 5).map(({ product, score }) => `
                <button type="button" class="btn btn-outline btn-sm" onclick="addProductToInvoiceFromSearch('${product.sku}')" title="Add ${product.name}">
                    ‚ûï ${product.name.length > 30 ? product.name.substring(0, 30) + '...' : product.name}
                </button>
            `).join('');

            document.getElementById('aiProductRecommendations').style.display = 'block';
        }

        function findRelatedProducts(currentSKUs) {
            // Find invoices that contain any of the current products
            const relatedInvoices = invoices.filter(inv =>
                inv.items && inv.items.some(item => currentSKUs.includes(item.sku))
            );

            // Count frequency of other products in those invoices
            const productFrequency = {};
            relatedInvoices.forEach(inv => {
                inv.items.forEach(item => {
                    if (!currentSKUs.includes(item.sku) && !currentInvoice.items.find(i => i.sku === item.sku)) {
                        productFrequency[item.sku] = (productFrequency[item.sku] || 0) + 1;
                    }
                });
            });

            // Convert to array and sort by frequency
            const recommendations = Object.entries(productFrequency)
                .map(([sku, count]) => {
                    const product = products.find(p => p.sku === sku);
                    return product ? { product, score: count } : null;
                })
                .filter(r => r !== null)
                .sort((a, b) => b.score - a.score);

            return recommendations;
        }

        function onPricingTierChanged() {
            // Recalculate all prices when tier changes
            if (currentInvoice.items.length > 0) {
                renderInvoiceItems();
                calculateInvoiceTotal();
            }
        }
    </script>

    <!-- Tesseract.js OCR Library -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>

    <!-- Google API Client Library for Google Drive Integration -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Google Drive Sync Module -->
    <script src="google-drive-sync.js"></script>

</body>
</html>